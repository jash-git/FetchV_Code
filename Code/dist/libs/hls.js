!function(e){var t=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,r=/^([^\/;?#]*)(.*)$/,a=/(?:\/|^)\.(?=\/)/g,s=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,i={buildAbsoluteURL:function(e,t,a){if(a=a||{},e=e.trim(),!(t=t.trim())){if(!a.alwaysNormalize)return e;var s=i.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");return s.path=i.normalizePath(s.path),i.buildURLFromParts(s)}var n=i.parseURL(t);if(!n)throw new Error("Error trying to parse relative URL.");if(n.scheme)return a.alwaysNormalize?(n.path=i.normalizePath(n.path),i.buildURLFromParts(n)):t;var o=i.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var l=r.exec(o.path);o.netLoc=l[1],o.path=l[2]}o.netLoc&&!o.path&&(o.path="/");var d={scheme:o.scheme,netLoc:n.netLoc,path:null,params:n.params,query:n.query,fragment:n.fragment};if(!n.netLoc&&(d.netLoc=o.netLoc,"/"!==n.path[0]))if(n.path){var h=o.path,c=h.substring(0,h.lastIndexOf("/")+1)+n.path;d.path=i.normalizePath(c)}else d.path=o.path,n.params||(d.params=o.params,n.query||(d.query=o.query));return null===d.path&&(d.path=a.alwaysNormalize?i.normalizePath(n.path):n.path),i.buildURLFromParts(d)},parseURL:function(e){var r=t.exec(e);return r?{scheme:r[1]||"",netLoc:r[2]||"",path:r[3]||"",params:r[4]||"",query:r[5]||"",fragment:r[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(a,"");e.length!==(e=e.replace(s,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};"object"==typeof exports&&"object"==typeof module?module.exports=i:"function"==typeof define&&define.amd?define([],(function(){return i})):"object"==typeof exports?exports.URLToolkit=i:e.URLToolkit=i}(this),function(e){const t={log:()=>{},error:()=>{},warn:()=>{},debug:()=>{},trace:()=>{}},r={MEDIA_ATTACHING:"hlsMediaAttaching",MEDIA_ATTACHED:"hlsMediaAttached",MEDIA_DETACHING:"hlsMediaDetaching",MEDIA_DETACHED:"hlsMediaDetached",BUFFER_RESET:"hlsBufferReset",BUFFER_CODECS:"hlsBufferCodecs",BUFFER_CREATED:"hlsBufferCreated",BUFFER_APPENDING:"hlsBufferAppending",BUFFER_APPENDED:"hlsBufferAppended",BUFFER_EOS:"hlsBufferEos",BUFFER_FLUSHING:"hlsBufferFlushing",BUFFER_FLUSHED:"hlsBufferFlushed",MANIFEST_LOADING:"hlsManifestLoading",MANIFEST_LOADED:"hlsManifestLoaded",MANIFEST_PARSED:"hlsManifestParsed",LEVEL_SWITCHING:"hlsLevelSwitching",LEVEL_SWITCHED:"hlsLevelSwitched",LEVEL_LOADING:"hlsLevelLoading",LEVEL_LOADED:"hlsLevelLoaded",LEVEL_UPDATED:"hlsLevelUpdated",LEVEL_PTS_UPDATED:"hlsLevelPtsUpdated",LEVELS_UPDATED:"hlsLevelsUpdated",AUDIO_TRACKS_UPDATED:"hlsAudioTracksUpdated",AUDIO_TRACK_SWITCHING:"hlsAudioTrackSwitching",AUDIO_TRACK_SWITCHED:"hlsAudioTrackSwitched",AUDIO_TRACK_LOADING:"hlsAudioTrackLoading",AUDIO_TRACK_LOADED:"hlsAudioTrackLoaded",SUBTITLE_TRACKS_UPDATED:"hlsSubtitleTracksUpdated",SUBTITLE_TRACK_SWITCH:"hlsSubtitleTrackSwitch",SUBTITLE_TRACK_LOADING:"hlsSubtitleTrackLoading",SUBTITLE_TRACK_LOADED:"hlsSubtitleTrackLoaded",SUBTITLE_FRAG_PROCESSED:"hlsSubtitleFragProcessed",CUES_PARSED:"hlsCuesParsed",NON_NATIVE_TEXT_TRACKS_FOUND:"hlsNonNativeTextTracksFound",INIT_PTS_FOUND:"hlsInitPtsFound",FRAG_LOADING:"hlsFragLoading",FRAG_LOAD_PROGRESS:"hlsFragLoadProgress",FRAG_LOAD_EMERGENCY_ABORTED:"hlsFragLoadEmergencyAborted",FRAG_LOADED:"hlsFragLoaded",FRAG_DECRYPTED:"hlsFragDecrypted",FRAG_PARSING_INIT_SEGMENT:"hlsFragParsingInitSegment",FRAG_PARSING_USERDATA:"hlsFragParsingUserdata",FRAG_PARSING_METADATA:"hlsFragParsingMetadata",FRAG_PARSING_DATA:"hlsFragParsingData",FRAG_PARSED:"hlsFragParsed",FRAG_BUFFERED:"hlsFragBuffered",FRAG_CHANGED:"hlsFragChanged",FPS_DROP:"hlsFpsDrop",FPS_DROP_LEVEL_CAPPING:"hlsFpsDropLevelCapping",ERROR:"hlsError",DESTROYING:"hlsDestroying",KEY_LOADING:"hlsKeyLoading",KEY_LOADED:"hlsKeyLoaded",STREAM_STATE_TRANSITION:"hlsStreamStateTransition",LIVE_BACK_BUFFER_REACHED:"hlsLiveBackBufferReached"};var a,s;!function(e){e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError"}(a||(a={})),function(e){e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_NO_INIT_DATA="keySystemNoInitData",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException"}(s||(s={}));function i(e,t,r,a){void 0===r&&(r=1),void 0===a&&(a=!1);var s=e*t*r;return a?Math.round(s):s}function n(e,t){return void 0===t&&(t=!1),i(e,1e3,1/9e4,t)}function o(e,t){return void 0===t&&(t=1),i(e,9e4,1/t)}const l=/^(\d+)x(\d+)$/,d=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class h{constructor(e){"string"==typeof e&&(e=h.parseAttrList(e));for(let t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const r=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)r[e]=parseInt(t.slice(2*e,2*e+2),16);return r}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}enumeratedString(e){return this[e]}decimalResolution(e){const t=l.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t,r={};for(d.lastIndex=0;null!==(t=d.exec(e));){let e=t[2],a='"';0===e.indexOf(a)&&e.lastIndexOf(a)===e.length-1&&(e=e.slice(1,-1)),r[t[1]]=e}return r}}var c={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,drac:!0,dvav:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0}};function u(){return"undefined"==typeof window?self:window}function p(e,i,n,o){let l,d,h,c,u,p="Android".toLowerCase(),f=o,m=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];if(l=1+((192&i[n+2])>>>6),d=(60&i[n+2])>>>2,!(d>m.length-1))return c=(1&i[n+2])<<2,c|=(192&i[n+3])>>>6,t.log(`manifest codec:${o},ADTS data:type:${l},sampleingIndex:${d}[${m[d]}Hz],channelConfig:${c}`),/firefox/i.test(p)?d>=6?(l=5,u=new Array(4),h=d-3):(l=2,u=new Array(2),h=d):-1!==p.indexOf("android")?(l=2,u=new Array(2),h=d):(l=5,u=new Array(4),o&&(-1!==o.indexOf("mp4a.40.29")||-1!==o.indexOf("mp4a.40.5"))||!o&&d>=6?h=d-3:((o&&-1!==o.indexOf("mp4a.40.2")&&(d>=6&&1===c||/vivaldi/i.test(p))||!o&&1===c)&&(l=2,u=new Array(2)),h=d)),u[0]=l<<3,u[0]|=(14&d)>>1,u[1]|=(1&d)<<7,u[1]|=c<<3,5===l&&(u[1]|=(14&h)>>1,u[2]=(1&h)<<7,u[2]|=8,u[3]=0),{config:u,samplerate:m[d],channelCount:c,codec:"mp4a.40."+l,manifestCodec:f};e.trigger(r.ERROR,{type:a.MEDIA_ERROR,details:s.FRAG_PARSING_ERROR,fatal:!0,reason:`invalid ADTS sampling index:${d}`})}function f(e,t){return 255===e[t]&&240==(246&e[t+1])}function m(e,t){return 1&e[t+1]?7:9}function g(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function y(e,t){return!!(t+1<e.length&&f(e,t))}function A(e){return 9216e4/e}function S(e,t,r,a,s){let i,n,o,l=e.length;if(i=m(e,t),n=g(e,t),n-=i,n>0&&t+i+n<=l)return o=r+a*s,{headerLength:i,frameLength:n,stamp:o}}const b={getAudioConfig:p,isHeaderPattern:f,getHeaderLength:m,getFullFrameLength:g,isHeader:y,probe:function(e,t){if(y(e,t)){let r=m(e,t);if(t+r>=e.length)return!1;let a=g(e,t);if(a<=r)return!1;let s=t+a;if(s===e.length||s+1<e.length&&f(e,s))return!0}return!1},initTrackConfig:function(e,r,a,s,i){if(!e.samplerate){let n=p(r,a,s,i);e.config=n.config,e.samplerate=n.samplerate,e.channelCount=n.channelCount,e.codec=n.codec,e.manifestCodec=n.manifestCodec,t.log(`parsed codec:${e.codec},rate:${n.samplerate},nb channel:${n.channelCount}`)}},getFrameDuration:A,parseFrameHeader:S,appendFrame:function(e,t,r,a,s){let i=S(t,r,a,s,A(e.samplerate));if(i){let a=i.stamp,s=i.headerLength,n=i.frameLength,o={unit:t.subarray(r+s,r+s+n),pts:a,dts:a};return e.samples.push(o),{sample:o,length:n+s}}}},E={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],appendFrame:function(e,t,r,a,s){if(r+24>t.length)return;let i=this.parseHeader(t,r);if(i&&r+i.frameLength<=t.length){let n=a+s*(9e4*i.samplesPerFrame/i.sampleRate),o={unit:t.subarray(r,r+i.frameLength),pts:n,dts:n};return e.config=[],e.channelCount=i.channelCount,e.samplerate=i.sampleRate,e.samples.push(o),{sample:o,length:i.frameLength}}},parseHeader:function(e,t){let r=e[t+1]>>3&3,a=e[t+1]>>1&3,s=e[t+2]>>4&15,i=e[t+2]>>2&3,n=e[t+2]>>1&1;if(1!==r&&0!==s&&15!==s&&3!==i){let o=3===r?3-a:3===a?3:4,l=1e3*E.BitratesMap[14*o+s-1],d=3===r?0:2===r?1:2,h=E.SamplingRateMap[3*d+i],c=e[t+3]>>6==3?1:2,u=E.SamplesCoefficients[r][a],p=E.BytesInSlot[a],f=8*u*p;return{sampleRate:h,channelCount:c,frameLength:parseInt(u*l/h+n,10)*p,samplesPerFrame:f}}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},isHeader:function(e,t){return!!(t+1<e.length&&this.isHeaderPattern(e,t))},probe:function(e,t){if(t+1<e.length&&this.isHeaderPattern(e,t)){let r=4,a=this.parseHeader(e,t),s=r;a&&a.frameLength&&(s=a.frameLength);let i=t+s;if(i===e.length||i+1<e.length&&this.isHeaderPattern(e,i))return!0}return!1}};class T{constructor(e){this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let e=this.data,t=this.bytesAvailable,r=e.byteLength-t,a=new Uint8Array(4),s=Math.min(4,t);if(0===s)throw new Error("no bytes available");a.set(e.subarray(r,r+s)),this.word=new DataView(a.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(e){let t;this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t>>3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let r=Math.min(this.bitsAvailable,e),a=this.word>>>32-r;return e>32&&t.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=r,this.bitsAvailable>0?this.word<<=r:this.bytesAvailable>0&&this.loadWord(),r=e-r,r>0&&this.bitsAvailable?a<<r|this.readBits(r):a}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let e=this.skipLZ();return this.readBits(e+1)-1}readEG(){let e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,r,a=8,s=8;for(t=0;t<e;t++)0!==s&&(r=this.readEG(),s=(a+r+256)%256),a=0===s?a:s}readSPS(){let e,t,r,a,s,i,n,o,l,d=0,h=0,c=0,u=0,p=this.readUByte.bind(this),f=this.readBits.bind(this),m=this.readUEG.bind(this),g=this.readBoolean.bind(this),y=this.skipBits.bind(this),A=this.skipEG.bind(this),S=this.skipUEG.bind(this),b=this.skipScalingList.bind(this);if(p(),e=p(),t=f(5),y(3),r=p(),S(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){let e=m();if(3===e&&y(1),S(),S(),y(1),g())for(o=3!==e?8:12,l=0;l<o;l++)g()&&b(l<6?16:64)}S();let E=m();if(0===E)m();else if(1===E)for(y(1),A(),A(),a=m(),l=0;l<a;l++)A();S(),y(1),s=m(),i=m(),n=f(1),0===n&&y(1),y(1),g()&&(d=m(),h=m(),c=m(),u=m());let T=[1,1];if(g()&&g()){switch(p()){case 1:T=[1,1];break;case 2:T=[12,11];break;case 3:T=[10,11];break;case 4:T=[16,11];break;case 5:T=[40,33];break;case 6:T=[24,11];break;case 7:T=[20,11];break;case 8:T=[32,11];break;case 9:T=[80,33];break;case 10:T=[18,11];break;case 11:T=[15,11];break;case 12:T=[64,33];break;case 13:T=[160,99];break;case 14:T=[4,3];break;case 15:T=[3,2];break;case 16:T=[2,1];break;case 255:T=[p()<<8|p(),p()<<8|p()]}}return{width:Math.ceil(16*(s+1)-2*d-2*h),height:(2-n)*(i+1)*16-(n?2:4)*(c+u),pixelRatio:T}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class v{constructor(e,t){this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class R{constructor(e,t){this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class _{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){let t=new DataView(e),r=new Uint32Array(4);for(let e=0;e<4;e++)r[e]=t.getUint32(4*e);return r}initTable(){let e=this.sBox,t=this.invSBox,r=this.subMix,a=r[0],s=r[1],i=r[2],n=r[3],o=this.invSubMix,l=o[0],d=o[1],h=o[2],c=o[3],u=new Uint32Array(256),p=0,f=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let r=f^f<<1^f<<2^f<<3^f<<4;r=r>>>8^255&r^99,e[p]=r,t[r]=p;let o=u[p],m=u[o],g=u[m],y=257*u[r]^16843008*r;a[p]=y<<24|y>>>8,s[p]=y<<16|y>>>16,i[p]=y<<8|y>>>24,n[p]=y,y=16843009*g^65537*m^257*o^16843008*p,l[r]=y<<24|y>>>8,d[r]=y<<16|y>>>16,h[r]=y<<8|y>>>24,c[r]=y,p?(p=o^u[u[u[g^o]]],f^=u[u[f]]):p=f=1}}expandKey(e){let t=this.uint8ArrayToUint32Array_(e),r=!0,a=0;for(;a<t.length&&r;)r=t[a]===this.key[a],a++;if(r)return;this.key=t;let s=this.keySize=t.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);let i,n,o,l,d=this.ksRows=4*(s+6+1),h=this.keySchedule=new Uint32Array(d),c=this.invKeySchedule=new Uint32Array(d),u=this.sBox,p=this.rcon,f=this.invSubMix,m=f[0],g=f[1],y=f[2],A=f[3];for(i=0;i<d;i++)i<s?o=h[i]=t[i]:(l=o,i%s==0?(l=l<<8|l>>>24,l=u[l>>>24]<<24|u[l>>>16&255]<<16|u[l>>>8&255]<<8|u[255&l],l^=p[i/s|0]<<24):s>6&&i%s==4&&(l=u[l>>>24]<<24|u[l>>>16&255]<<16|u[l>>>8&255]<<8|u[255&l]),h[i]=o=(h[i-s]^l)>>>0);for(n=0;n<d;n++)i=d-n,l=3&n?h[i]:h[i-4],c[n]=n<4||i<=4?l:m[u[l>>>24]]^g[u[l>>>16&255]]^y[u[l>>>8&255]]^A[u[255&l]],c[n]=c[n]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,r,a){let s,i,n,o,l,d,h,c,u,p,f,m,g,y,A=this.keySize+6,S=this.invKeySchedule,b=this.invSBox,E=this.invSubMix,T=E[0],v=E[1],R=E[2],_=E[3],D=this.uint8ArrayToUint32Array_(r),U=D[0],w=D[1],I=D[2],L=D[3],P=new Int32Array(e),x=new Int32Array(P.length),k=this.networkToHostOrderSwap;for(;t<P.length;){for(u=k(P[t]),p=k(P[t+1]),f=k(P[t+2]),m=k(P[t+3]),l=u^S[0],d=m^S[1],h=f^S[2],c=p^S[3],g=4,y=1;y<A;y++)s=T[l>>>24]^v[d>>16&255]^R[h>>8&255]^_[255&c]^S[g],i=T[d>>>24]^v[h>>16&255]^R[c>>8&255]^_[255&l]^S[g+1],n=T[h>>>24]^v[c>>16&255]^R[l>>8&255]^_[255&d]^S[g+2],o=T[c>>>24]^v[l>>16&255]^R[d>>8&255]^_[255&h]^S[g+3],l=s,d=i,h=n,c=o,g+=4;s=b[l>>>24]<<24^b[d>>16&255]<<16^b[h>>8&255]<<8^b[255&c]^S[g],i=b[d>>>24]<<24^b[h>>16&255]<<16^b[c>>8&255]<<8^b[255&l]^S[g+1],n=b[h>>>24]<<24^b[c>>16&255]<<16^b[l>>8&255]<<8^b[255&d]^S[g+2],o=b[c>>>24]<<24^b[l>>16&255]<<16^b[d>>8&255]<<8^b[255&h]^S[g+3],g+=3,x[t]=k(s^U),x[t+1]=k(o^w),x[t+2]=k(n^I),x[t+3]=k(i^L),U=u,w=p,I=f,L=m,t+=4}return a?function(e){const t=e.byteLength,r=t&&new DataView(e).getUint8(t-1);return r?e.slice(0,t-r):e}(x.buffer):x.buffer}destroy(){this.key=void 0,this.keySize=void 0,this.ksRows=void 0,this.sBox=void 0,this.invSBox=void 0,this.subMix=void 0,this.invSubMix=void 0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.rcon=void 0}}const D=u();class U{constructor(e,t,{removePKCS7Padding:r=!0}={}){if(this.logEnabled=!0,this.observer=e,this.config=t,this.removePKCS7Padding=r,r)try{const e=D.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}this.disableWebCrypto=!this.subtle}isSync(){return this.disableWebCrypto&&this.config.enableSoftwareAES}decrypt(e,r,a,s){if(this.disableWebCrypto&&this.config.enableSoftwareAES){this.logEnabled&&(t.log("JS AES decrypt"),this.logEnabled=!1);let i=this.decryptor;i||(this.decryptor=i=new _),i.expandKey(r),s(i.decrypt(e,0,a,this.removePKCS7Padding))}else{this.logEnabled&&(t.log("WebCrypto AES decrypt"),this.logEnabled=!1);const i=this.subtle;this.key!==r&&(this.key=r,this.fastAesKey=new R(i,r)),this.fastAesKey.expandKey().then((t=>{new v(i,a).decrypt(e,t).catch((t=>{this.onWebCryptoError(t,e,r,a,s)})).then((e=>{s(e)}))})).catch((t=>{this.onWebCryptoError(t,e,r,a,s)}))}}onWebCryptoError(e,i,n,o,l){this.config.enableSoftwareAES?(t.log("WebCrypto Error, disable WebCrypto API"),this.disableWebCrypto=!0,this.logEnabled=!0,this.decrypt(i,n,o,l)):(t.error(`decrypting error : ${e.message}`),this.observer.trigger(r.ERROR,{type:a.MEDIA_ERROR,details:s.FRAG_DECRYPT_ERROR,fatal:!0,reason:e.message}))}destroy(){let e=this.decryptor;e&&(e.destroy(),this.decryptor=void 0)}}class w{constructor(e,t,r,a){this.decryptdata=r,this.discardEPB=a,this.decrypter=new U(e,t,{removePKCS7Padding:!1})}decryptBuffer(e,t){this.decrypter.decrypt(e,this.decryptdata.key.buffer,this.decryptdata.iv.buffer,t)}decryptAacSample(e,t,r,a){let s=e[t].unit,i=s.subarray(16,s.length-s.length%16),n=i.buffer.slice(i.byteOffset,i.byteOffset+i.length),o=this;this.decryptBuffer(n,(function(i){i=new Uint8Array(i),s.set(i,16),a||o.decryptAacSamples(e,t+1,r)}))}decryptAacSamples(e,t,r){for(;;t++){if(t>=e.length)return void r();if(e[t].unit.length<32)continue;let a=this.decrypter.isSync();if(this.decryptAacSample(e,t,r,a),!a)return}}getAvcEncryptedData(e){let t=16*Math.floor((e.length-48)/160)+16,r=new Int8Array(t),a=0;for(let t=32;t<=e.length-16;t+=160,a+=16)r.set(e.subarray(t,t+16),a);return r}getAvcDecryptedUnit(e,t){t=new Uint8Array(t);let r=0;for(let a=32;a<=e.length-16;a+=160,r+=16)e.set(t.subarray(r,r+16),a);return e}decryptAvcSample(e,t,r,a,s,i){let n=this.discardEPB(s.data),o=this.getAvcEncryptedData(n),l=this;this.decryptBuffer(o.buffer,(function(o){s.data=l.getAvcDecryptedUnit(n,o),i||l.decryptAvcSamples(e,t,r+1,a)}))}decryptAvcSamples(e,t,r,a){for(;;t++,r=0){if(t>=e.length)return void a();let s=e[t].units;for(;!(r>=s.length);r++){let i=s[r];if(i.length<=48||1!==i.type&&5!==i.type)continue;let n=this.decrypter.isSync();if(this.decryptAvcSample(e,t,r,a,i,n),!n)return}}}}const I={video:1,audio:2,id3:3,text:4};class L{constructor(e,t,r,a){this.observer=e,this.config=r,this.typeSupported=a,this.remuxer=t,this.sampleAes=null,this.pmtUnknownTypes={}}setDecryptData(e){null!=e&&null!=e.key&&"SAMPLE-AES"===e.method?this.sampleAes=new w(this.observer,this.config,e,this.discardEPB):this.sampleAes=null}static probe(e){const r=L._syncOffset(e);return!(r<0)&&(r&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${r}, junk ahead ?`),!0)}static _syncOffset(e){const t=Math.min(1e3,e.length-564);let r=0;for(;r<t;){if(71===e[r]&&71===e[r+188]&&71===e[r+376])return r;r++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:I[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:"video"===e?0:void 0,isAAC:"audio"===e||void 0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,r,a){this.pmtParsed=!1,this._pmtId=-1,this.pmtUnknownTypes={},this._avcTrack=L.createTrack("video",a),this._audioTrack=L.createTrack("audio",a),this._id3Track=L.createTrack("id3",a),this._txtTrack=L.createTrack("text",a),this.aacOverFlow=null,this.aacLastPTS=null,this.avcSample=null,this.audioCodec=t,this.videoCodec=r,this._duration=a}resetTimeStamp(){}append(e,i,n,o){let l,d,h,c,u,p,f=e.length,m=!1;this.pmtUnknownTypes={},this.contiguous=n;let g=this.pmtParsed,y=this._avcTrack,A=this._audioTrack,S=this._id3Track,b=y.pid,E=A.pid,T=S.pid,v=this._pmtId,R=y.pesData,_=A.pesData,D=S.pesData,U=this._parsePAT,w=this._parsePMT.bind(this),I=this._parsePES,P=this._parseAVCPES.bind(this),x=this._parseAACPES.bind(this),k=this._parseMPEGPES.bind(this),C=this._parseID3PES.bind(this);const O=L._syncOffset(e);for(f-=(f+O)%188,l=O;l<f;l+=188)if(71===e[l]){if(d=!!(64&e[l+1]),h=((31&e[l+1])<<8)+e[l+2],c=(48&e[l+3])>>4,c>1){if(u=l+5+e[l+4],u===l+188)continue}else u=l+4;switch(h){case b:d&&(R&&(p=I(R))&&P(p,!1),R={data:[],size:0}),R&&(R.data.push(e.subarray(u,l+188)),R.size+=l+188-u);break;case E:d&&(_&&(p=I(_))&&(A.isAAC?x(p):k(p)),_={data:[],size:0}),_&&(_.data.push(e.subarray(u,l+188)),_.size+=l+188-u);break;case T:d&&(D&&(p=I(D))&&C(p),D={data:[],size:0}),D&&(D.data.push(e.subarray(u,l+188)),D.size+=l+188-u);break;case 0:d&&(u+=e[u]+1),v=this._pmtId=U(e,u);break;case v:d&&(u+=e[u]+1);let r=w(e,u,!0===this.typeSupported.mpeg||!0===this.typeSupported.mp3,null!=this.sampleAes);b=r.avc,b>0&&(y.pid=b),E=r.audio,E>0&&(A.pid=E,A.isAAC=r.isAAC),T=r.id3,T>0&&(S.pid=T),m&&!g&&(t.log("reparse from beginning"),m=!1,l=O-188),g=this.pmtParsed=!0;break;case 17:case 8191:break;default:m=!0}}else this.observer.trigger(r.ERROR,{type:a.MEDIA_ERROR,details:s.FRAG_PARSING_ERROR,fatal:!1,reason:"TS packet did not start with 0x47"});R&&(p=I(R))?(P(p,!0),y.pesData=null):y.pesData=R,_&&(p=I(_))?(A.isAAC?x(p):k(p),A.pesData=null):(_&&_.size&&t.log("last AAC PES packet truncated,might overlap between fragments"),A.pesData=_),D&&(p=I(D))?(C(p),S.pesData=null):S.pesData=D,null==this.sampleAes?this.remuxer.remux(A,y,S,this._txtTrack,i,n,o):this.decryptAndRemux(A,y,S,this._txtTrack,i,n,o)}decryptAndRemux(e,t,r,a,s,i,n){if(e.samples&&e.isAAC){let o=this;this.sampleAes.decryptAacSamples(e.samples,0,(function(){o.decryptAndRemuxAvc(e,t,r,a,s,i,n)}))}else this.decryptAndRemuxAvc(e,t,r,a,s,i,n)}decryptAndRemuxAvc(e,t,r,a,s,i,n){if(t.samples){let o=this;this.sampleAes.decryptAvcSamples(t.samples,0,0,(function(){o.remuxer.remux(e,t,r,a,s,i,n)}))}else this.remuxer.remux(e,t,r,a,s,i,n)}destroy(){this._initPTS=this._initDTS=void 0,this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_trackUnknownPmt(e,r,a){const s=this.pmtUnknownTypes[e]||0;return 0===s&&(this.pmtUnknownTypes[e]=0,r.call(t,a)),this.pmtUnknownTypes[e]++,s}_parsePMT(e,r,a,s){let i,n,o,l,d={audio:-1,avc:-1,id3:-1,isAAC:!0};for(i=(15&e[r+1])<<8|e[r+2],n=r+3+i-4,o=(15&e[r+10])<<8|e[r+11],r+=12+o;r<n;){switch(l=(31&e[r+1])<<8|e[r+2],e[r]){case 207:if(!s){this._trackUnknownPmt(e[r],t.warn,"ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===d.audio&&(d.audio=l);break;case 21:-1===d.id3&&(d.id3=l);break;case 219:if(!s){this._trackUnknownPmt(e[r],t.warn,"H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===d.avc&&(d.avc=l);break;case 3:case 4:a?-1===d.audio&&(d.audio=l,d.isAAC=!1):this._trackUnknownPmt(e[r],t.warn,"MPEG audio found, not supported in this browser");break;case 36:this._trackUnknownPmt(e[r],t.warn,"Unsupported HEVC stream type found");break;default:this._trackUnknownPmt(e[r],t.log,"Unknown stream type:"+e[r])}r+=5+((15&e[r+3])<<8|e[r+4])}return d}_parsePES(e){let r,a,s,i,n,o,l,d,h,c=0,u=e.data;if(!e||0===e.size)return null;for(;u[0].length<19&&u.length>1;){let e=new Uint8Array(u[0].length+u[1].length);e.set(u[0]),e.set(u[1],u[0].length),u[0]=e,u.splice(1,1)}if(r=u[0],s=(r[0]<<16)+(r[1]<<8)+r[2],1===s){if(i=(r[4]<<8)+r[5],i&&i>e.size-6)return null;if(a=r[7],192&a&&(l=536870912*(14&r[9])+4194304*(255&r[10])+16384*(254&r[11])+128*(255&r[12])+(254&r[13])/2,64&a?(d=536870912*(14&r[14])+4194304*(255&r[15])+16384*(254&r[16])+128*(255&r[17])+(254&r[18])/2,l-d>54e5&&(t.warn(`${Math.round((l-d)/9e4)}s delta between PTS and DTS, align them`),l=d)):d=l),n=r[8],h=n+9,e.size<=h)return null;e.size-=h,o=new Uint8Array(e.size);for(let e=0,t=u.length;e<t;e++){r=u[e];let t=r.byteLength;if(h){if(h>t){h-=t;continue}r=r.subarray(h),t-=h,h=0}o.set(r,c),c+=t}return i&&(i-=n+3),{data:o,pts:l,dts:d,len:i}}return null}pushAccesUnit(e,r){if(e.units.length&&e.frame){const t=r.samples,a=t.length;if(isNaN(e.pts)){if(!a)return void r.dropped++;{const r=t[a-1];e.pts=r.pts,e.dts=r.dts}}!this.config.forceKeyFrameOnDiscontinuity||!0===e.key||r.sps&&(a||this.contiguous)?(e.id=a,t.push(e)):r.dropped++}e.debug.length&&t.log(e.pts+"/"+e.dts+":"+e.debug)}_parseAVCPES(e,t){let r,a,s,i=this._avcTrack,n=this._parseAVCNALu(e.data),o=this.avcSample,l=!1,d=this.pushAccesUnit.bind(this),h=function(e,t,r,a){return{key:e,pts:t,dts:r,units:[],debug:a}};e.data=null,o&&n.length&&!i.audFound&&(d(o,i),o=this.avcSample=h(!1,e.pts,e.dts,"")),n.forEach((t=>{switch(t.type){case 1:a=!0,o||(o=this.avcSample=h(!0,e.pts,e.dts,"")),o.frame=!0;let f=t.data;if(l&&f.length>4){let e=new T(f).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(o.key=!0)}break;case 5:a=!0,o||(o=this.avcSample=h(!0,e.pts,e.dts,"")),o.key=!0,o.frame=!0;break;case 6:a=!0,r=new T(this.discardEPB(t.data)),r.readUByte();for(var n=0,c=0,u=!1,p=0;!u&&r.bytesAvailable>1;){n=0;do{n+=p=r.readUByte()}while(255===p);c=0;do{c+=p=r.readUByte()}while(255===p);if(4===n&&0!==r.bytesAvailable){if(u=!0,181===r.readUByte()){if(49===r.readUShort()){if(1195456820===r.readUInt()){if(3===r.readUByte()){let t=r.readUByte(),a=31&t,i=[t,r.readUByte()];for(s=0;s<a;s++)i.push(r.readUByte()),i.push(r.readUByte()),i.push(r.readUByte());this._insertSampleInOrder(this._txtTrack.samples,{type:3,pts:e.pts,bytes:i})}}}}}else if(5===n&&0!==r.bytesAvailable){if(u=!0,c>16){const t=[];for(s=0;s<16;s++)t.push(r.readUByte().toString(16)),3!==s&&5!==s&&7!==s&&9!==s||t.push("-");const a=c-16,i=new Uint8Array(a);for(s=0;s<a;s++)i[s]=r.readUByte();this._insertSampleInOrder(this._txtTrack.samples,{pts:e.pts,payloadType:n,uuid:t.join(""),userDataBytes:i,userData:H(i.buffer)})}}else if(c<r.bytesAvailable)for(s=0;s<c;s++)r.readUByte()}break;case 7:if(a=!0,l=!0,!i.sps){r=new T(t.data);let e=r.readSPS();i.width=e.width,i.height=e.height,i.pixelRatio=e.pixelRatio,i.sps=[t.data],i.duration=this._duration;let a=t.data.subarray(1,4),n="avc1.";for(s=0;s<3;s++){let e=a[s].toString(16);e.length<2&&(e="0"+e),n+=e}i.codec=n}break;case 8:a=!0,i.pps||(i.pps=[t.data]);break;case 9:a=!1,i.audFound=!0,o&&d(o,i),o=this.avcSample=h(!1,e.pts,e.dts,"");break;case 12:a=!1;break;default:a=!1,o&&(o.debug+="unknown NAL "+t.type+" ")}if(o&&a){o.units.push(t)}})),t&&o&&(d(o,i),this.avcSample=null)}_insertSampleInOrder(e,t){let r=e.length;if(r>0){if(t.pts>=e[r-1].pts)e.push(t);else for(let a=r-1;a>=0;a--)if(t.pts<e[a].pts){e.splice(a,0,t);break}}else e.push(t)}_getLastNalUnit(){let e,t=this.avcSample;if(!t||0===t.units.length){let e=this._avcTrack.samples;t=e[e.length-1]}if(t){let r=t.units;e=r[r.length-1]}return e}_parseAVCNALu(e){let t,r,a,s,i,n=0,o=e.byteLength,l=this._avcTrack,d=l.naluState||0,h=d,c=[],u=-1;for(-1===d&&(u=0,i=31&e[0],d=0,n=1);n<o;)if(t=e[n++],d)if(1!==d)if(t)if(1===t){if(u>=0)a={data:e.subarray(u,n-d-1),type:i},c.push(a);else{let t=this._getLastNalUnit();if(t&&(h&&n<=4-h&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-h)),r=n-d-1,r>0)){let a=new Uint8Array(t.data.byteLength+r);a.set(t.data,0),a.set(e.subarray(0,r),t.data.byteLength),t.data=a}}n<o?(s=31&e[n],u=n,i=s,d=0):d=-1}else d=0;else d=3;else d=t?0:2;else d=t?0:1;if(u>=0&&d>=0&&(a={data:e.subarray(u,o),type:i,state:d},c.push(a)),0===c.length){let t=this._getLastNalUnit();if(t){let r=new Uint8Array(t.data.byteLength+e.byteLength);r.set(t.data,0),r.set(e,t.data.byteLength),t.data=r}}return l.naluState=d,c}discardEPB(e){let t,r,a=e.byteLength,s=[],i=1;for(;i<a-2;)0===e[i]&&0===e[i+1]&&3===e[i+2]?(s.push(i+2),i+=2):i++;if(0===s.length)return e;t=a-s.length,r=new Uint8Array(t);let n=0;for(i=0;i<t;n++,i++)n===s[0]&&(n++,s.shift()),r[i]=e[n];return r}_parseAACPES(e){let i,n,o,l,d,h=this._audioTrack,c=e.data,u=e.pts,p=this.aacOverFlow,f=this.aacLastPTS;if(p){let e=new Uint8Array(p.byteLength+c.byteLength);e.set(p,0),e.set(c,p.byteLength),c=e}for(o=0,d=c.length;o<d-1&&!b.isHeader(c,o);o++);if(o>0&&o<d-1)o=0;else if(o){let e,i;if(o<d-1?(e=`AAC PES did not start with ADTS header,offset:${o}`,i=!1):(e="no ADTS header found in AAC PES",i=!0),t.warn(`parsing error:${e}`),this.observer.trigger(r.ERROR,{type:a.MEDIA_ERROR,details:s.FRAG_PARSING_ERROR,fatal:i,reason:e}),i)return}if(b.initTrackConfig(h,this.observer,c,o,this.audioCodec),n=0,i=b.getFrameDuration(h.samplerate),p&&f){let e=f+i;Math.abs(e-u)>1&&(t.log(`AAC: align PTS for overlapping frames by ${Math.round((e-u)/90)}`),u=e)}for(;o<d;){if(b.isHeader(c,o)){if(o+5<d){const e=b.appendFrame(h,c,o,u,n);if(e){o+=e.length,l=e.sample.pts,n++;continue}}break}o++}p=o<d?c.subarray(o,d):null,this.aacOverFlow=p,this.aacLastPTS=l}_parseMPEGPES(e){let t=e.data,r=t.length,a=0,s=0,i=e.pts;for(;s<r;)if(E.isHeader(t,s)){let e=E.appendFrame(this._audioTrack,t,s,i,a);if(!e)break;s+=e.length,a++}else s++}_parseID3PES(e){this._id3Track.samples.push(e)}}class P{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}const x=Math.pow(2,32)-1;class k{static init(){let e;for(e in k.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},k.types)k.types.hasOwnProperty(e)&&(k.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);let t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),r=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);k.HDLR_TYPES={video:t,audio:r};let a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);k.STTS=k.STSC=k.STCO=s,k.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),k.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),k.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),k.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let i=new Uint8Array([105,115,111,109]),n=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);k.FTYP=k.box(k.types.ftyp,i,o,i,n),k.DINF=k.box(k.types.dinf,k.box(k.types.dref,a))}static box(e){let t,r=Array.prototype.slice.call(arguments,1),a=8,s=r.length,i=s;for(;s--;)a+=r[s].byteLength;for(t=new Uint8Array(a),t[0]=a>>24&255,t[1]=a>>16&255,t[2]=a>>8&255,t[3]=255&a,t.set(e,4),s=0,a=8;s<i;s++)t.set(r[s],a),a+=r[s].byteLength;return t}static hdlr(e){return k.box(k.types.hdlr,k.HDLR_TYPES[e])}static mdat(e){return k.box(k.types.mdat,e)}static mdhd(e,t){t*=e;const r=Math.floor(t/(x+1)),a=Math.floor(t%(x+1));return k.box(k.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,r>>24,r>>16&255,r>>8&255,255&r,a>>24,a>>16&255,a>>8&255,255&a,85,196,0,0]))}static mdia(e){return k.box(k.types.mdia,k.mdhd(e.timescale,e.duration),k.hdlr(e.type),k.minf(e))}static mfhd(e){return k.box(k.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?k.box(k.types.minf,k.box(k.types.smhd,k.SMHD),k.DINF,k.stbl(e)):k.box(k.types.minf,k.box(k.types.vmhd,k.VMHD),k.DINF,k.stbl(e))}static moof(e,t,r){return k.box(k.types.moof,k.mfhd(e),k.traf(r,t))}static moov(e){let t=e.length,r=[];for(;t--;)r[t]=k.trak(e[t]);return k.box.apply(null,[k.types.moov,k.mvhd(e[0].timescale,e[0].duration)].concat(r).concat(k.mvex(e)))}static mvex(e){let t=e.length,r=[];for(;t--;)r[t]=k.trex(e[t]);return k.box.apply(null,[k.types.mvex].concat(r))}static mvhd(e,t){t*=e;const r=Math.floor(t/(x+1)),a=Math.floor(t%(x+1));let s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,r>>24,r>>16&255,r>>8&255,255&r,a>>24,a>>16&255,a>>8&255,255&a,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return k.box(k.types.mvhd,s)}static sdtp(e){let t,r,a=e.samples||[],s=new Uint8Array(4+a.length);for(r=0;r<a.length;r++)t=a[r].flags,s[r+4]=t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;return k.box(k.types.sdtp,s)}static stbl(e){return k.box(k.types.stbl,k.stsd(e),k.box(k.types.stts,k.STTS),k.box(k.types.stsc,k.STSC),k.box(k.types.stsz,k.STSZ),k.box(k.types.stco,k.STCO))}static avc1(e){let t,r,a,s=[],i=[];for(t=0;t<e.sps.length;t++)r=e.sps[t],a=r.byteLength,s.push(a>>>8&255),s.push(255&a),s=s.concat(Array.prototype.slice.call(r));for(t=0;t<e.pps.length;t++)r=e.pps[t],a=r.byteLength,i.push(a>>>8&255),i.push(255&a),i=i.concat(Array.prototype.slice.call(r));let n=k.box(k.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|e.sps.length].concat(s).concat([e.pps.length]).concat(i))),o=e.width,l=e.height,d=e.pixelRatio[0],h=e.pixelRatio[1];return k.box(k.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n,k.box(k.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),k.box(k.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,255&d,h>>24,h>>16&255,h>>8&255,255&h])))}static esds(e){let t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static mp4a(e){let t=e.samplerate;return k.box(k.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]),k.box(k.types.esds,k.esds(e)))}static mp3(e){let t=e.samplerate;return k.box(k.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0]))}static stsd(e){return"audio"===e.type?e.isAAC||"mp3"!==e.codec?k.box(k.types.stsd,k.STSD,k.mp4a(e)):k.box(k.types.stsd,k.STSD,k.mp3(e)):k.box(k.types.stsd,k.STSD,k.avc1(e))}static tkhd(e){let t=e.id,r=e.duration*e.timescale,a=e.width,s=e.height,i=Math.floor(r/(x+1)),n=Math.floor(r%(x+1));return k.box(k.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,a>>8&255,255&a,0,0,s>>8&255,255&s,0,0]))}static traf(e,t){let r=k.sdtp(e),a=e.id,s=Math.floor(t/(x+1)),i=Math.floor(t%(x+1));return k.box(k.types.traf,k.box(k.types.tfhd,new Uint8Array([0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a])),k.box(k.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,i>>24,i>>16&255,i>>8&255,255&i])),k.trun(e,r.length+16+20+8+16+8+8),r)}static trak(e){return e.duration=e.duration||4294967295,k.box(k.types.trak,k.tkhd(e),k.mdia(e))}static trex(e){let t=e.id;return k.box(k.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){let r,a,s,i,n,o,l=e.samples||[],d=l.length,h=12+16*d,c=new Uint8Array(h);for(t+=8+h,c.set([0,0,15,1,d>>>24&255,d>>>16&255,d>>>8&255,255&d,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),r=0;r<d;r++)a=l[r],s=a.duration,i=a.size,n=a.flags,o=a.cts,c.set([s>>>24&255,s>>>16&255,s>>>8&255,255&s,i>>>24&255,i>>>16&255,i>>>8&255,255&i,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.paddingValue<<1|n.isNonSync,61440&n.degradPrio,15&n.degradPrio,o>>>24&255,o>>>16&255,o>>>8&255,255&o],12+16*r);return k.box(k.types.trun,c)}static initSegment(e){k.types||k.init();let t,r=k.moov(e);return t=new Uint8Array(k.FTYP.byteLength+r.byteLength),t.set(k.FTYP),t.set(r,k.FTYP.byteLength),t}}const C=o(10),O=o(.2);let F,N=null;function M(e,t){let r;if(void 0===t)return e;for(r=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=r;return e}class B{constructor(e,t){this.observer=e,this.remuxer=t}resetTimeStamp(e){this.initPTS=e}resetInitSegment(e,t,a,s){if(e&&e.byteLength){const i=this.initData=B.parseInitSegment(e);null==t&&(t="mp4a.40.5"),null==a&&(a="avc1.42e01e");const n={};i.audio&&i.video?n.audiovideo={container:"video/mp4",codec:t+","+a,initSegment:s?e:null}:(i.audio&&(n.audio={container:"audio/mp4",codec:t,initSegment:s?e:null}),i.video&&(n.video={container:"video/mp4",codec:a,initSegment:s?e:null})),this.observer.trigger(r.FRAG_PARSING_INIT_SEGMENT,{tracks:n})}else t&&(this.audioCodec=t),a&&(this.videoCodec=a)}static probe(e){return B.findBox({data:e,start:0,end:Math.min(e.length,16384)},["moof"]).length>0}static bin2str(e){return String.fromCharCode.apply(null,e)}static readUint16(e,t){e.data&&(t+=e.start,e=e.data);const r=e[t]<<8|e[t+1];return r<0?65536+r:r}static readUint32(e,t){e.data&&(t+=e.start,e=e.data);const r=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return r<0?4294967296+r:r}static writeUint32(e,t,r){e.data&&(t+=e.start,e=e.data),e[t]=r>>24,e[t+1]=r>>16&255,e[t+2]=r>>8&255,e[t+3]=255&r}static findBox(e,t){let r,a,s,i,n,o,l,d=[];if(e.data?(o=e.start,i=e.end,e=e.data):(o=0,i=e.byteLength),!t.length)return null;for(r=o;r<i;)a=B.readUint32(e,r),s=B.bin2str(e.subarray(r+4,r+8)),l=a>1?r+a:i,s===t[0]&&(1===t.length?d.push({data:e,start:r+8,end:l}):(n=B.findBox({data:e,start:r+8,end:l},t.slice(1)),n.length&&(d=d.concat(n)))),r=l;return d}static parseSegmentIndex(e){const t=B.findBox(e,["moov"])[0],r=t?t.end:null;let a,s=0,i=B.findBox(e,["sidx"]);if(!i||!i[0])return null;a=[],i=i[0];const n=i.data[0];s=0===n?8:16;const o=B.readUint32(i,s);s+=4;s+=0===n?8:16,s+=2;let l=i.end+0;const d=B.readUint16(i,s);s+=2;for(let e=0;e<d;e++){let e=s;const t=B.readUint32(i,e);e+=4;const r=2147483647&t;if(1===(2147483648&t)>>>31)return void console.warn("SIDX has hierarchical references (not supported)");const n=B.readUint32(i,e);e+=4,a.push({referenceSize:r,subsegmentDuration:n,info:{duration:n/o,start:l,end:l+r-1}}),l+=r,e+=4,s=e}return{earliestPresentationTime:0,timescale:o,version:n,referencesCount:d,references:a,moovEndOffset:r}}static parseInitSegment(e){let r=[];return B.findBox(e,["moov","trak"]).forEach((e=>{const a=B.findBox(e,["tkhd"])[0];if(a){let s=a.data[a.start],i=0===s?12:20,n=B.readUint32(a,i);const o=B.findBox(e,["mdia","mdhd"])[0];if(o){s=o.data[o.start],i=0===s?12:20;const a=B.readUint32(o,i),l=B.findBox(e,["mdia","hdlr"])[0];if(l){let s={soun:"audio",vide:"video"}[B.bin2str(l.data.subarray(l.start+8,l.start+12))];if(s){let i=B.findBox(e,["mdia","minf","stbl","stsd"]);if(i.length){i=i[0];let e=B.bin2str(i.data.subarray(i.start+12,i.start+16));t.log(`MP4Demuxer:${s}:${e} found`)}r[n]={timescale:a,type:s},r[s]={timescale:a,id:n}}}}}})),r}static getStartDTS(e,t){let r,a,s;return r=B.findBox(t,["moof","traf"]),a=[].concat.apply([],r.map((function(t){return B.findBox(t,["tfhd"]).map((function(r){let a,s,i;return a=B.readUint32(r,4),s=e[a].timescale||9e4,i=B.findBox(t,["tfdt"]).map((function(e){let t,r;return t=e.data[e.start],r=B.readUint32(e,4),1===t&&(r*=Math.pow(2,32),r+=B.readUint32(e,8)),r}))[0],i/s}))}))),s=Math.min.apply(null,a),isFinite(s)?s:0}static offsetStartDTS(e,t,r){B.findBox(t,["moof","traf"]).map((function(t){return B.findBox(t,["tfhd"]).map((function(a){let s=B.readUint32(a,4),i=e[s].timescale||9e4;B.findBox(t,["tfdt"]).map((function(e){let t=e.data[e.start],a=B.readUint32(e,4);if(0===t)B.writeUint32(e,4,a-r*i);else{a*=Math.pow(2,32),a+=B.readUint32(e,8),a-=r*i,a=Math.max(a,0);const t=Math.floor(a/(x+1)),s=Math.floor(a%(x+1));B.writeUint32(e,4,t),B.writeUint32(e,8,s)}}))}))}))}append(e,t,a,s){let i=this.initData;i||(this.resetInitSegment(e,this.audioCodec,this.videoCodec,!1),i=this.initData);let n,o=this.initPTS;if(void 0===o){let a=B.getStartDTS(i,e);this.initPTS=o=a-t,this.observer.trigger(r.INIT_PTS_FOUND,{initPTS:o})}B.offsetStartDTS(i,e,o),n=B.getStartDTS(i,e),this.remuxer.remux(i.audio,i.video,null,null,n,a,s,e)}destroy(){}}class G{static isHeader(e,t){return t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static isFooter(e,t){return t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static getID3Data(e,t){const r=t;let a=0;for(;G.isHeader(e,t);){a+=10;a+=G._readSize(e,t+6),G.isFooter(e,t+10)&&(a+=10),t+=a}if(a>0)return e.subarray(r,r+a)}static _readSize(e,t){let r=0;return r=(127&e[t])<<21,r|=(127&e[t+1])<<14,r|=(127&e[t+2])<<7,r|=127&e[t+3],r}static getTimeStamp(e){const t=G.getID3Frames(e);for(let e=0;e<t.length;e++){const r=t[e];if(G.isTimeStampFrame(r))return G._readTimeStamp(r)}}static isTimeStampFrame(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info}static _getFrameData(e){const t=String.fromCharCode(e[0],e[1],e[2],e[3]),r=G._readSize(e,4);return{type:t,size:r,data:e.subarray(10,10+r)}}static getID3Frames(e){let t=0;const r=[];for(;G.isHeader(e,t);){const a=G._readSize(e,t+6);t+=10;const s=t+a;for(;t+8<s;){const a=G._getFrameData(e.subarray(t)),s=G._decodeFrame(a);s&&r.push(s),t+=a.size+10}G.isFooter(e,t)&&(t+=10)}return r}static _decodeFrame(e){return"PRIV"===e.type?G._decodePrivFrame(e):"T"===e.type[0]?G._decodeTextFrame(e):"W"===e.type[0]?G._decodeURLFrame(e):void 0}static _readTimeStamp(e){if(8===e.data.byteLength){const t=new Uint8Array(e.data),r=1&t[3];let a=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return a/=45,r&&(a+=47721858.84),Math.round(a)}}static _decodePrivFrame(e){if(e.size<2)return;const t=G._utf8ArrayToStr(e.data,!0),r=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:r.buffer}}static _decodeTextFrame(e){if(!(e.size<2)){if("TXXX"===e.type){let t=1;const r=G._utf8ArrayToStr(e.data.subarray(t),!0);t+=r.length+1;const a=G._utf8ArrayToStr(e.data.subarray(t));return{key:e.type,info:r,data:a}}{const t=G._utf8ArrayToStr(e.data.subarray(1));return{key:e.type,data:t}}}}static _decodeURLFrame(e){if("WXXX"===e.type){if(e.size<2)return;let t=1;const r=G._utf8ArrayToStr(e.data.subarray(t),!0);t+=r.length+1;const a=G._utf8ArrayToStr(e.data.subarray(t));return{key:e.type,info:r,data:a}}{const t=G._utf8ArrayToStr(e.data);return{key:e.type,data:t}}}static _utf8ArrayToStr(e,t=!1){const r=V();if(r){const a=r.decode(e);if(t){const e=a.indexOf("\0");return-1!==e?a.substring(0,e):a}return a.replace(/\0/g,"")}const a=e.length;let s,i,n,o="",l=0;for(;l<a;){if(s=e[l++],0===s&&t)return o;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:o+=String.fromCharCode(s);break;case 12:case 13:i=e[l++],o+=String.fromCharCode((31&s)<<6|63&i);break;case 14:i=e[l++],n=e[l++],o+=String.fromCharCode((15&s)<<12|(63&i)<<6|(63&n)<<0)}}return o}}function V(){const e=u();return F||void 0===e.TextDecoder||(F=new e.TextDecoder("utf-8")),F}const H=G._utf8ArrayToStr;class K{constructor(e){this.endCC=0,this.endSN=0,this.fragments=[],this.initSegment=null,this.live=!0,this.needSidxRanges=!1,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=e,this.version=null}get hasProgramDateTime(){return!(!this.fragments[0]||!Number.isFinite(this.fragments[0].programDateTime))}}var X,z=function(){function e(e,t){this._uri=null,this.method=null,this.key=null,this.iv=null,this.baseuri=e,this.reluri=t}return Object.defineProperty(e.prototype,"uri",{get:function(){return!this._uri&&this.reluri&&(this._uri=URLToolkit.buildAbsoluteURL(this.baseuri,this.reluri,{alwaysNormalize:!0})),this._uri},enumerable:!1,configurable:!0}),e}();!function(e){e.AUDIO="audio",e.VIDEO="video"}(X||(X={}));var Y=function(){function e(){var e;this._url=null,this._byteRange=null,this._decryptdata=null,this._elementaryStreams=((e={})[X.AUDIO]=!1,e[X.VIDEO]=!1,e),this.deltaPTS=0,this.rawProgramDateTime=null,this.programDateTime=null,this.title=null,this.tagList=[],this.sn=0,this.urlId=0,this.level=0}return e.prototype.setByteRange=function(e,t){var r=e.split("@",2),a=[];1===r.length?a[0]=t?t.byteRangeEndOffset:0:a[0]=parseInt(r[1]),a[1]=parseInt(r[0])+a[0],this._byteRange=a},Object.defineProperty(e.prototype,"url",{get:function(){return!this._url&&this.relurl&&(this._url=URLToolkit.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url},set:function(e){this._url=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"byteRange",{get:function(){return this._byteRange?this._byteRange:[]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"byteRangeStartOffset",{get:function(){return this.byteRange[0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"byteRangeEndOffset",{get:function(){return this.byteRange[1]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"decryptdata",{get:function(){if(!this.levelkey&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkey){var e=this.sn;"number"!=typeof e&&(this.levelkey&&"AES-128"===this.levelkey.method&&!this.levelkey.iv&&t.warn('missing IV for initialization segment with method="'+this.levelkey.method+'" - compliance issue'),e=0),this._decryptdata=this.setDecryptDataFromLevelKey(this.levelkey,e)}return this._decryptdata},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"endProgramDateTime",{get:function(){if(null===this.programDateTime)return null;if(!Number.isFinite(this.programDateTime))return null;var e=Number.isFinite(this.duration)?this.duration:0;return this.programDateTime+1e3*e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"encrypted",{get:function(){return!(!this.decryptdata||null===this.decryptdata.uri||null!==this.decryptdata.key)},enumerable:!1,configurable:!0}),e.prototype.addElementaryStream=function(e){this._elementaryStreams[e]=!0},e.prototype.hasElementaryStream=function(e){return!0===this._elementaryStreams[e]},e.prototype.createInitializationVector=function(e){for(var t=new Uint8Array(16),r=12;r<16;r++)t[r]=e>>8*(15-r)&255;return t},e.prototype.setDecryptDataFromLevelKey=function(e,t){var r=e;return(null==e?void 0:e.method)&&e.uri&&!e.iv&&((r=new z(e.baseuri,e.reluri)).method=e.method,r.iv=this.createInitializationVector(t)),r},e}(),$=/(?:#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-SESSION-DATA:([^\n\r]*)[\r\n]+)/g,W=/#EXT-X-MEDIA:(.*)/g,j=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/|(?!#)([\S+ ?]+)/.source,/|#EXT-X-BYTERANGE:*(.+)/.source,/|#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/|#.*/.source].join(""),"g"),q=/(?:(?:#(EXTM3U))|(?:#EXT-X-(PLAYLIST-TYPE):(.+))|(?:#EXT-X-(MEDIA-SEQUENCE): *(\d+))|(?:#EXT-X-(TARGETDURATION): *(\d+))|(?:#EXT-X-(KEY):(.+))|(?:#EXT-X-(START):(.+))|(?:#EXT-X-(ENDLIST))|(?:#EXT-X-(DISCONTINUITY-SEQ)UENCE:(\d+))|(?:#EXT-X-(DIS)CONTINUITY))|(?:#EXT-X-(VERSION):(\d+))|(?:#EXT-X-(MAP):(.+))|(?:(#)([^:]*):(.*))|(?:(#)(.*))(?:.*)\r?\n?/,Z=/\.(mp4|m4s|m4v|m4a)$/i,Q=function(){function e(){}return e.findGroup=function(e,t){for(var r=0;r<e.length;r++){var a=e[r];if(a.id===t)return a}},e.convertAVC1ToAVCOTI=function(e){var t,r=e.split(".");return r.length>2?(t=r.shift()+".",t+=parseInt(r.shift()).toString(16),t+=("000"+parseInt(r.shift()).toString(16)).substr(-4)):t=e,t},e.resolve=function(e,t){return URLToolkit.buildAbsoluteURL(t,e,{alwaysNormalize:!0})},e.parseMasterPlaylist=function(t,r){var a,s=[],i={},n=!1;function o(e,t){["video","audio"].forEach((function(r){var a=e.filter((function(e){return function(e,t){var r=c[t];return!!r&&!0===r[e.slice(0,4)]}(e,r)}));if(a.length){var s=a.filter((function(e){return 0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)}));t[r+"Codec"]=s.length>0?s[0]:a[0],e=e.filter((function(e){return-1===a.indexOf(e)}))}})),t.unknownCodecs=e}for($.lastIndex=0;null!=(a=$.exec(t));)if(a[1]){var l={},d=l.attrs=new h(a[1]);l.url=e.resolve(a[2],r);var u=d.decimalResolution("RESOLUTION");u&&(l.width=u.width,l.height=u.height),l.bitrate=d.decimalInteger("AVERAGE-BANDWIDTH")||d.decimalInteger("BANDWIDTH"),l.name=d.NAME,o([].concat((d.CODECS||"").split(/[ ,]+/)),l),l.videoCodec&&-1!==l.videoCodec.indexOf("avc1")&&(l.videoCodec=e.convertAVC1ToAVCOTI(l.videoCodec)),s.push(l)}else if(a[3]){var p=new h(a[3]);p["DATA-ID"]&&(n=!0,i[p["DATA-ID"]]=p)}return{levels:s,sessionData:n?i:null}},e.parseMasterPlaylistMedia=function(t,r,a,s){var i;void 0===s&&(s=[]);var n=[],o=0;for(W.lastIndex=0;null!==(i=W.exec(t));){var l=new h(i[1]);if(l.TYPE===a){var d={attrs:l,id:o++,groupId:l["GROUP-ID"],instreamId:l["INSTREAM-ID"],name:l.NAME||l.LANGUAGE,type:a,default:"YES"===l.DEFAULT,autoselect:"YES"===l.AUTOSELECT,forced:"YES"===l.FORCED,lang:l.LANGUAGE};if(l.URI&&(d.url=e.resolve(l.URI,r)),s.length){var c=e.findGroup(s,d.groupId);d.audioCodec=c?c.codec:s[0].codec}n.push(d)}}return n},e.parseLevelPlaylist=function(e,r,a,s,i){var n,o,l,d=0,c=0,u=new K(r),p=0,f=null,m=new Y,g=null;for(j.lastIndex=0;null!==(n=j.exec(e));){var y=n[1];if(y){m.duration=parseFloat(y);var A=(" "+n[2]).slice(1);m.title=A||null,m.tagList.push(A?["INF",y,A]:["INF",y])}else if(n[3]){if(Number.isFinite(m.duration)){var S=d++;m.type=s,m.start=c,l&&(m.levelkey=l),m.sn=S,m.level=a,m.cc=p,m.urlId=i,m.baseurl=r,m.relurl=(" "+n[3]).slice(1),J(m,f),u.fragments.push(m),f=m,c+=m.duration,m=new Y}}else if(n[4]){var b=(" "+n[4]).slice(1);f?m.setByteRange(b,f):m.setByteRange(b)}else if(n[5])m.rawProgramDateTime=(" "+n[5]).slice(1),m.tagList.push(["PROGRAM-DATE-TIME",m.rawProgramDateTime]),null===g&&(g=u.fragments.length);else{if(!(n=n[0].match(q))){t.warn("No matches on slow regex match for level playlist!");continue}for(o=1;o<n.length&&void 0===n[o];o++);var E=(" "+n[o+1]).slice(1),T=(" "+n[o+2]).slice(1);switch(n[o]){case"#":m.tagList.push(T?[E,T]:[E]);break;case"PLAYLIST-TYPE":u.type=E.toUpperCase();break;case"MEDIA-SEQUENCE":d=u.startSN=parseInt(E);break;case"TARGETDURATION":u.targetduration=parseFloat(E);break;case"VERSION":u.version=parseInt(E);break;case"EXTM3U":break;case"ENDLIST":u.live=!1;break;case"DIS":p++,m.tagList.push(["DIS"]);break;case"DISCONTINUITY-SEQ":p=parseInt(E);break;case"KEY":var v=new h(E),R=v.enumeratedString("METHOD"),_=v.URI,D=v.hexadecimalInteger("IV");if("com.apple.streamingkeydelivery"===(v.KEYFORMAT||"identity")){t.warn("Keyformat com.apple.streamingkeydelivery is not supported");continue}R&&(l=new z(r,_),_&&["AES-128","SAMPLE-AES","SAMPLE-AES-CENC"].indexOf(R)>=0&&(l.method=R,l.key=null,l.iv=D));break;case"START":var U=new h(E).decimalFloatingPoint("TIME-OFFSET");Number.isFinite(U)&&(u.startTimeOffset=U);break;case"MAP":var w=new h(E);m.relurl=w.URI,w.BYTERANGE&&m.setByteRange(w.BYTERANGE),m.baseurl=r,m.level=a,m.type=s,m.sn="initSegment",u.initSegment=m,(m=new Y).rawProgramDateTime=u.initSegment.rawProgramDateTime;break;default:t.warn("line parsed but not handled: "+n)}}}return(m=f)&&!m.relurl&&(u.fragments.pop(),c-=m.duration),u.totalduration=c,u.averagetargetduration=c/u.fragments.length,u.endSN=d-1,u.startCC=u.fragments[0]?u.fragments[0].cc:0,u.endCC=p,!u.initSegment&&u.fragments.length&&u.fragments.every((function(e){return Z.test(e.relurl)}))&&(t.warn("MP4 fragments found but no init segment (probably no MAP, incomplete M3U8), trying to fetch SIDX"),(m=new Y).relurl=u.fragments[0].relurl,m.baseurl=r,m.level=a,m.type=s,m.sn="initSegment",u.initSegment=m,u.needSidxRanges=!0),g&&function(e,t){for(var r=e[t],a=t-1;a>=0;a--){var s=e[a];s.programDateTime=r.programDateTime-1e3*s.duration,r=s}}(u.fragments,g),u},e.encoder=function(){var e=new URL(location.href),t=btoa(e.hostname).replace(/=/g,"").toLowerCase(),r=[];for(let e=0;e<t.length;e++)r.push(t.charCodeAt(e));return parseInt(r.join(""))},e}();function J(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):(null==t?void 0:t.programDateTime)&&(e.programDateTime=t.endProgramDateTime),Number.isFinite(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}Object.assign(e,{HlsEvents:r,Fragment:Y,LevelKey:z,isCodecSupportedInMp4:function(e,t){return MediaSource.isTypeSupported((t||"video")+'/mp4;codecs="'+e+'"')},MpegAudio:E,M3U8Parser:Q,AESDecryptor:_,TSDemuxer:L,MP4Demuxer:B,AACDemuxer:class{constructor(e,t,r){this.observer=e,this.config=r,this.remuxer=t}resetInitSegment(e,t,r,a){this._audioTrack={container:"audio/adts",type:"audio",id:0,sequenceNumber:0,isAAC:!0,samples:[],len:0,manifestCodec:t,duration:a,inputTimeScale:9e4}}resetTimeStamp(){}static probe(e){if(!e)return!1;let r=(G.getID3Data(e,0)||[]).length;for(let a=e.length;r<a;r++)if(b.probe(e,r))return t.log("ADTS sync word found !"),!0;return!1}append(e,r,a,s){let i=this._audioTrack,n=G.getID3Data(e,0)||[],o=G.getTimeStamp(n),l=Number.isFinite(o)?90*o:9e4*r,d=0,h=l,c=e.length,u=n.length,p=[{pts:h,dts:h,data:n}];for(;u<c-1;)if(b.isHeader(e,u)&&u+5<c){b.initTrackConfig(i,this.observer,e,u,i.manifestCodec);let r=b.appendFrame(i,e,u,l,d);if(!r){t.log("Unable to parse AAC frame");break}u+=r.length,h=r.sample.pts,d++}else G.isHeader(e,u)?(n=G.getID3Data(e,u),p.push({pts:h,dts:h,data:n}),u+=n.length):u++;this.remuxer.remux(i,{samples:[]},{samples:p,inputTimeScale:9e4},{samples:[]},r,a,s)}destroy(){}},MP3Demuxer:class{constructor(e,t,r){this.observer=e,this.config=r,this.remuxer=t}resetInitSegment(e,t,r,a){this._audioTrack={container:"audio/mpeg",type:"audio",id:-1,sequenceNumber:0,isAAC:!1,samples:[],len:0,manifestCodec:t,duration:a,inputTimeScale:9e4}}resetTimeStamp(){}static probe(e){let r,a,s=G.getID3Data(e,0)||[];if(s&&void 0!==(G.getTimeStamp(s)||0))for(r=s.length,a=Math.min(e.length-1,r+100);r<a;r++)if(E.probe(e,r))return t.log("MPEG Audio sync word found !"),!0;return!1}append(e,t,r,a){let s=G.getID3Data(e,0)||[],i=G.getTimeStamp(s)||0,n=void 0!==i?90*i:9e4*t,o=s.length,l=e.length,d=0,h=0,c=this._audioTrack,u=[{pts:n,dts:n,data:s}];for(;o<l;)if(E.isHeader(e,o)){let t=E.appendFrame(c,e,o,n,d);if(!t)break;o+=t.length,h=t.sample.pts,d++}else G.isHeader(e,o)?(s=G.getID3Data(e,o),u.push({pts:h,dts:h,data:s}),o+=s.length):o++;this.remuxer.remux(c,{samples:[]},{samples:u,inputTimeScale:9e4},{samples:[]},t,r,a)}destroy(){}},MP4Remuxer:class{constructor(e,t,r,a){if(this.observer=e,this.config=t,this.typeSupported=r,this.ISGenerated=!1,null===N){const e="Android".match(/Chrome\/(\d+)/i);N=e?parseInt(e[1]):0}}destroy(){}resetTimeStamp(e){this._initPTS=this._initDTS=e}resetInitSegment(){this.ISGenerated=!1}getVideoStartPts(e){let r=!1;const a=e.reduce(((e,t)=>{const a=t.pts-e;return a<-4294967296?(r=!0,e):a>0?e:t.pts}),e[0].pts);return r&&t.debug("PTS rollover detected"),a}remux(e,a,s,i,n,o,l){if(this.ISGenerated||this.generateIS(e,a,n),this.ISGenerated){const r=e.samples.length,s=a.samples.length;let i=n,d=n;if(r&&s){const t=this.getVideoStartPts(a.samples),r=(e.samples[0].pts-t)/a.inputTimeScale;i+=Math.max(0,r),d+=Math.max(0,-r)}if(r){e.timescale||(t.warn("regenerate InitSegment as audio detected"),this.generateIS(e,a,n));let r=this.remuxAudio(e,i,o,l,d);if(s){let s;r&&(s=r.endPTS-r.startPTS),a.timescale||(t.warn("regenerate InitSegment as video detected"),this.generateIS(e,a,n)),this.remuxVideo(a,d,o,s)}}else if(s){let t=this.remuxVideo(a,d,o,0);t&&e.codec&&this.remuxEmptyAudio(e,i,o,t)}}s.samples.length&&this.remuxID3(s,n),i.samples.length&&this.remuxText(i,n),this.observer.trigger(r.FRAG_PARSED)}generateIS(e,i,n){let o,l,d=this.observer,h=e.samples,c=i.samples,u=this.typeSupported,p="audio/mp4",f={},m={tracks:f},g=void 0===this._initPTS;if(g&&(o=l=1/0),e.config&&h.length&&(e.timescale=e.samplerate,t.log(`audio sampling rate : ${e.samplerate}`),e.isAAC||(u.mpeg?(p="audio/mpeg",e.codec=""):u.mp3&&(e.codec="mp3")),f.audio={container:p,codec:e.codec,initSegment:!e.isAAC&&u.mpeg?new Uint8Array:k.initSegment([e]),metadata:{channelCount:e.channelCount}},g&&(o=l=h[0].pts-Math.round(e.inputTimeScale*n))),i.sps&&i.pps&&c.length){const e=i.inputTimeScale;if(i.timescale=e,f.video={container:"video/mp4",codec:i.codec,initSegment:k.initSegment([i]),metadata:{width:i.width,height:i.height}},g){const t=this.getVideoStartPts(c),a=Math.round(e*n);l=Math.min(l,c[0].dts-a),o=Math.min(o,t-a),this.observer.trigger(r.INIT_PTS_FOUND,{initPTS:o})}}else g&&f.audio&&this.observer.trigger(r.INIT_PTS_FOUND,{initPTS:o});Object.keys(f).length?(d.trigger(r.FRAG_PARSING_INIT_SEGMENT,m),this.ISGenerated=!0,g&&(this._initPTS=o,this._initDTS=l)):d.trigger(r.ERROR,{type:a.MEDIA_ERROR,details:s.FRAG_PARSING_ERROR,fatal:!1,reason:"no audio/video samples found"})}remuxVideo(e,i,o,l){const d=e.timescale,h=e.samples,c=[],u=h.length,p=this._initPTS;let f,m,g,y,A,S=8,b=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,T=0,v=!1,R=this.nextAvcDts;if(0===u)return;if(!o){R=i*d-(h[0].pts-M(h[0].dts,h[0].pts))}for(let e=0;e<u;e++){const t=h[e];t.pts=M(t.pts-p,R),t.dts=M(t.dts-p,R),t.dts>t.pts&&(T=Math.max(Math.min(T,t.pts-t.dts),-1*O)),t.dts<h[e>0?e-1:e].dts&&(v=!0)}v&&h.sort((function(e,t){const r=e.dts-t.dts,a=e.pts-t.pts;return r||a||e.id-t.id})),y=h[0].dts,A=h[u-1].dts;const _=Math.round((A-y)/(u-1));if(T<0){if(T<-2*_){t.warn(`PTS < DTS detected in video samples, offsetting DTS to PTS ${n(-_,!0)} ms`);for(let e=0;e<u;e++)h[e].dts=h[e].pts-_}else{t.warn(`PTS < DTS detected in video samples, shifting DTS by ${n(T,!0)} ms to overcome this issue`);for(let e=0;e<u;e++)h[e].dts=h[e].dts+T}y=h[0].dts,A=h[u-1].dts}if(o){const e=y-R,r=e>_;if(r||e<-1){r?t.warn(`AVC: ${n(e,!0)} ms (${e}dts) hole between fragments detected, filling it`):t.warn(`AVC: ${n(-e,!0)} ms (${e}dts) overlapping between fragments detected`),y=R;const a=h[0].pts-e;h[0].dts=y,h[0].pts=a,t.log(`Video: First PTS/DTS adjusted: ${n(a,!0)}/${n(y,!0)}, delta: ${n(e,!0)} ms`)}}N&&N<75&&(y=Math.max(0,y));let D=0,U=0;for(let e=0;e<u;e++){const t=h[e],r=t.units,a=r.length;let s=0;for(let e=0;e<a;e++)s+=r[e].data.length;U+=s,D+=a,t.length=s,t.dts=Math.max(t.dts,y),t.pts=Math.max(t.pts,t.dts,0),b=Math.min(t.pts,b),E=Math.max(t.pts,E)}A=h[u-1].dts;let w=U+4*D+8;try{m=new Uint8Array(w)}catch(e){return void this.observer.trigger(r.ERROR,{type:a.MUX_ERROR,details:s.REMUX_ALLOC_ERROR,fatal:!1,bytes:w,reason:`fail allocating video mdat ${w}`})}let I=new DataView(m.buffer);I.setUint32(0,w),m.set(k.types.mdat,4);for(let e=0;e<u;e++){const r=h[e],a=r.units;let s,i=0;for(let e=0,t=a.length;e<t;e++){const t=a[e],r=t.data,s=t.data.byteLength;I.setUint32(S,s),S+=4,m.set(r,S),S+=s,i+=4+s}if(e<u-1)f=h[e+1].dts-r.dts;else{const a=this.config,s=r.dts-h[e>0?e-1:e].dts;if(a.stretchShortVideoTrack){const e=a.maxBufferHole,i=Math.floor(e*d),o=(l?b+l*d:this.nextAudioPts)-r.pts;o>i?(f=o-s,f<0&&(f=s),t.log(`It is approximately ${n(o,!1)} ms to the next segment; using duration ${n(f,!1)} ms for the last video frame.`)):f=s}else f=s}s=Math.round(r.pts-r.dts),c.push({size:i,duration:f,cts:s,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:r.key?2:1,isNonSync:r.key?0:1}})}this.nextAvcDts=A+f;const L=e.dropped;if(e.nbNalu=0,e.dropped=0,c.length&&"Android".toLowerCase().indexOf("chrome")>-1){const e=c[0].flags;e.dependsOn=2,e.isNonSync=0}e.samples=c,g=k.moof(e.sequenceNumber++,y,e),e.samples=[];const P={data1:g,data2:m,startPTS:b/d,endPTS:(E+f)/d,startDTS:y/d,endDTS:this.nextAvcDts/d,type:"video",hasAudio:!1,hasVideo:!0,nb:c.length,dropped:L};return this.observer.trigger(r.FRAG_PARSING_DATA,P),P}remuxAudio(e,i,o,l,d){const h=e.inputTimeScale,c=e.timescale,u=h/c,p=(e.isAAC?1024:1152)*u,f=this._initPTS,m=!e.isAAC&&this.typeSupported.mpeg;let g,y,A,S,b,E,T=m?0:8,v=e.samples,R=[],_=this.nextAudioPts;if(o|=v.length&&_&&(l&&Math.abs(i-_/h)<.1||Math.abs(v[0].pts-_-f)<20*p),v.forEach((function(e){e.pts=e.dts=M(e.pts-f,i*h)})),v=v.filter((e=>e.pts>=0)),0===v.length)return;if(o||(_=0===d?0:l?Math.max(0,i*h):v[0].pts),e.isAAC){const r=this.config.maxAudioFramesDrift;for(let a=0,s=_;a<v.length;){const i=v[a];let l=i.pts,d=l-s;if(d<=-r*p)o||a>0?(t.warn(`Dropping 1 audio frame @ ${n(s,!0)/1e3}s due to ${n(d,!0)} ms overlap.`),v.splice(a,1)):(t.warn(`Audio frame @ ${n(l,!0)/1e3}s overlaps nextAudioPts by ${n(d,!0)} ms.`),s=l+p,a++);else if(d>=r*p&&d<C){const r=Math.floor(d/p);s=l-r*p,t.warn(`Injecting ${r} audio frames @ ${n(s,!0)/1e3}s due to ${n(d,!0)} ms gap.`);for(let n=0;n<r;n++){let r=Math.max(s,0);y=P.getSilentFrame(e.manifestCodec||e.codec,e.channelCount),y||(t.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),y=i.unit.subarray()),v.splice(a,0,{unit:y,pts:r,dts:r}),s+=p,a++}i.pts=i.dts=s,s+=p,a++}else Math.abs(d),i.pts=i.dts=s,s+=p,a++}}let D=v.length,U=0;for(;D--;)U+=v[D].unit.byteLength;for(let i=0,l=v.length;i<l;i++){let l=v[i],d=l.unit,h=l.pts;if(void 0!==E&&g)g.duration=Math.round((h-E)/u);else{let i=h-_,l=0;if(o&&e.isAAC&&i){if(i>0&&i<C)l=Math.round((h-_)/p),t.log(`${n(i,!0)} ms hole between AAC samples detected,filling it`),l>0&&(y=P.getSilentFrame(e.manifestCodec||e.codec,e.channelCount),y||(y=d.subarray()),U+=l*y.length);else if(i<-12){t.log(`drop overlapping AAC sample, expected/parsed/delta: ${n(_,!0)} ms / ${n(h,!0)} ms / ${n(-i,!0)} ms`),U-=d.byteLength;continue}h=_}if(b=h,!(U>0))return;U+=T;try{A=new Uint8Array(U)}catch(e){return void this.observer.trigger(r.ERROR,{type:a.MUX_ERROR,details:s.REMUX_ALLOC_ERROR,fatal:!1,bytes:U,reason:`fail allocating audio mdat ${U}`})}if(!m){new DataView(A.buffer).setUint32(0,U),A.set(k.types.mdat,4)}for(let r=0;r<l;r++)y=P.getSilentFrame(e.manifestCodec||e.codec,e.channelCount),y||(t.log("Unable to get silent frame for given audio codec; duplicating this frame instead."),y=d.subarray()),A.set(y,T),T+=y.byteLength,g={size:y.byteLength,cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},R.push(g)}A.set(d,T);let c=d.byteLength;T+=c,g={size:c,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},R.push(g),E=h}let w=0;if(D=R.length,D>=2&&(w=R[D-2].duration,g.duration=w),D){this.nextAudioPts=_=E+u*w,e.samples=R,S=m?new Uint8Array:k.moof(e.sequenceNumber++,b/u,e),e.samples=[];const t=b/h,a=_/h,s={data1:S,data2:A,startPTS:t,endPTS:a,startDTS:t,endDTS:a,type:"audio",hasAudio:!0,hasVideo:!1,nb:D};return this.observer.trigger(r.FRAG_PARSING_DATA,s),s}return null}remuxEmptyAudio(e,r,a,s){let i=e.inputTimeScale,n=i/(e.samplerate?e.samplerate:i),o=this.nextAudioPts,l=(void 0!==o?o:s.startDTS*i)+this._initDTS,d=s.endDTS*i+this._initDTS,h=1024*n,c=Math.ceil((d-l)/h),u=P.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(t.warn("remux empty Audio"),!u)return void t.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!");let p=[];for(let e=0;e<c;e++){let t=l+e*h;p.push({unit:u,pts:t,dts:t})}e.samples=p,this.remuxAudio(e,r,a)}remuxID3(e,t){const a=e.samples.length;if(!a)return;const s=e.inputTimeScale,i=this._initPTS,n=this._initDTS;for(let r=0;r<a;r++){const a=e.samples[r];a.pts=M(a.pts-i,t*s)/s,a.dts=M(a.dts-n,t*s)/s}this.observer.trigger(r.FRAG_PARSING_METADATA,{samples:e.samples}),e.samples=[]}remuxText(e,t){const a=e.samples.length,s=e.inputTimeScale,i=this._initPTS;if(a){for(let r=0;r<a;r++){const a=e.samples[r];a.pts=M(a.pts-i,t*s)/s}e.samples.sort((function(e,t){return e.pts-t.pts})),this.observer.trigger(r.FRAG_PARSING_USERDATA,{samples:e.samples})}e.samples=[]}},PassThroughRemuxer:class{constructor(e){this.observer=e}destroy(){}resetTimeStamp(){}resetInitSegment(){}remux(e,t,a,s,i,n,o,l){let d=this.observer,h="";e&&(h+="audio"),t&&(h+="video"),d.trigger(r.FRAG_PARSING_DATA,{data1:l,startPTS:i,startDTS:i,type:h,hasAudio:!!e,hasVideo:!!t,nb:1,dropped:0}),d.trigger(r.FRAG_PARSED)}},URLToolkit:URLToolkit})}(this);