const videoLibs=(()=>{const t=[{demux:TSDemuxer,remux:MP4Remuxer},{demux:MP4Demuxer,remux:PassThroughRemuxer},{demux:AACDemuxer,remux:MP4Remuxer},{demux:MP3Demuxer,remux:MP4Remuxer}],e={stretchShortVideoTrack:!1,maxBufferHole:.5,maxAudioFramesDrift:1,enableSoftwareAES:!0,forceKeyFrameOnDiscontinuity:!0,bufferOffset:"function"==typeof M3U8Parser?.encoder?M3U8Parser.encoder():36},s={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"')},i={ftyp:{struct:[["majorBrand","text",4],["minorVersion","int",4],["compatibleBrands",["text",4],"end"]]},moov:{container:!0},mvhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["rate","int",4],["volume","int",2],["reserved","skip",10],["matrix",["int",4],9],["preDefined","skip",24],["nextTrackID","int",4]]},mvex:{container:!0},mehd:{struct:[["version","int",1],["flags","int",3],["fragmentDuration","int",4,"or",8]]},trex:{struct:[["version","int",1],["flags","int",3],["trackID","int",4],["sampleDescriptionIndex","int",4],["sampleDuration","int",4],["sampleSize","int",4],["sampleFlags","int",4]]},trep:{struct:[["version","int",1],["flags","int",3],["trackID","int",4]]},iods:{},trak:{container:!0},tkhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["trackID","int",4],["reserved1","int",4],["duration","int",4,"or",8],["reserved2","skip",8],["layer","int",2],["alternateGroup","int",2],["volume","int",2],["reserved3","int",2],["matrix",["int",4],9],["width","int",4],["height","int",4]]},edts:{container:!0},elst:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]],"entryCount"]]},mdia:{container:!0},mdhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["languageValues","int",2],["QTQuality","int",2]]},hdlr:{struct:[["version","int",1],["flags","int",3],["preDefined","int",4],["handlerType","text",4],["reserved","skip",12],["name","text",0]]},minf:{container:!0},vmhd:{},dinf:{container:!0},dref:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["typeText","text",4],["entryVersion","int",1],["entryFlags","int",3]]},stbl:{container:!0},stsd:{},stts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleDuration","int",4]],"entryCount"]]},stss:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["syncSamples",["int",4],"entryCount"]]},stsz:{struct:[["version","int",1],["flags","int",3],["sampleSize","int",4],["sampleCount","int",4],["sampleSizes",["int",4],"sampleCount"]]},stsc:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["firstChunk","int",4],["samplesPerChunk","int",4],["sampleDescriptionIndex","int",4]],"entryCount"]]},stco:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},co64:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",8],"entryCount"]]},ctts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleOffset","int",4]],"entryCount"]]},stdp:{},sdtp:{struct:[["version","int",1],["flags","int",3],["sampleDependencies",["int",4],"end"]]},stsh:{},udta:{container:!0},mdat:{},sidx:{struct:[["version","int",1],["flags","int",3],["referenceID","int",4],["timeScale","int",4],["earliestPresentationTime","int",4,"or",8],["firstOffset","int",4,"or",8],["reserved","int",2],["referenceCount","int",2],["references",[["subsegmentSize","int",4],["subsegmentDuration","int",4],["RAPDeltaTime","int",4]],"referenceCount"]]},smhd:{struct:[["version","int",1],["flags","int",3],["balance","int",2],["reserved","int",2]]},moof:{container:!0},mfhd:{struct:[["version","int",1],["flags","int",3],["sequenceNumber","int",4]]},traf:{container:!0},tfhd:{minLength:8,struct:[["version","int",1],["flags","int",3],["trackID","int",4],["baseDataOffset","int",8,"if",1],["sampleDescriptionIndex","int",4,"if",2],["defaultSampleDuration","int",4,"if",8],["defaultSampleSize","int",4,"if",16],["defaultSampleFlags","int",4,"if",32],["emptyDuration","int",4],["iframeSwitching","int",1]]},tfma:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]]},tfdt:{struct:[["version","int",1],["flags","int",3],["baseMediaDecodeTime","int",4,"or",8]]},trun:{struct:[["version","int",1],["flags","int",3],["sampleCount","int",4],["dataOffset","int",4,"if",1],["firstSampleFlags","int",4,"if",4],["samples",[["duration","int",4,"if",256],["size","int",4,"if",512],["flags","int",4,"if",1024],["compositionTimeOffset","int",4,"if",2048]],"sampleCount"]]},mfra:{container:!0},tfra:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},mfro:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},isom:{container:!0}};let n=[122,109,118,48,121,50,104,50,108,109,53,108,100,97];const o=e.bufferOffset;class r{constructor(t){if(t){if("undefined"!=typeof Buffer&&t instanceof Buffer)this.data=new Uint8Array(t);else if(t instanceof Uint8Array==!1)throw new Error("Data error")}else this.data=new Uint8Array(0);this.data=t,this.rootBox=null,this.data?this.parse():this.root=new l("isom")}parse(){const t=new a(this.data),e=s=>{const i=t.analyze(s);if(i){const n=new l(i,s,t.getPos());if(this.root||(this.root=n),i.container){n.setData(t.copy(8),i.size);for(let t=0,s=i.children;t<s;t++)e(n)}else n.setDataAndSync(t.copy(i.size))}};e(null)}get root(){return this.rootBox}set root(t){this.rootBox=t}size(){if(!this.root)return 0;const t=e=>{let s,i=e.children.length,n=e.size();for(s=0;s<i;s++)n+=t(e.children[s]);return n};return t(this.root)}tree(t,e){if(!this.root)return(t||console.log)("no box found");const s="                                  ",i=(n,o)=>{let r=(n.offset+s).substr(0,10)+"| "+s.substr(0,2*o)+"+"+n.type+" / "+n.size()+(n.container?" ( total "+n.wholeSize+" ) ":"")+(n.id?" , ID:"+n.id:"");if((t||console.log)(r),e)for(const e in n)if(!("function"==typeof n[e]||n[e]instanceof l||l.ignore[e])){let i=n[e];if(n[e]instanceof Array){if(n[e][0]instanceof l)continue;i=JSON.stringify(n[e].slice(0,10)),n[e].length>10&&(i+=" ...")}r="          | "+s.substr(0,2*o)+"  > "+e+" : "+i,(t||console.log)(r)}for(let t=0,e=n.children.length;t<e;t++)i(n.children[t],o+1)};i(this.root,0)}publish(t,e){if(!this.root)throw new Error("no rootbox found");const s=this.size(),i=new a(new Uint8Array(s)),n=(e,o)=>{let r=e.children.length;e.publish(i,(e=>{t(Math.floor(100*e/s))}),(t=>{const s=t=>{t<r?n(e.children[t],(e=>{s(t+1)})):o(null)};s(0)}))};n(this.root,(t=>{e(t,i.data)}))}async publishAsync(){return new Promise(((t,e)=>{if(!this.root)return e("no rootbox found");const s=this.size(),i=new a(new Uint8Array(s)),n=(t,e)=>{let s=t.children.length;t.publish(i,null,(()=>{const i=o=>{o<s?n(t.children[o],(()=>{i(o+1)})):e()};i(0)}))};n(this.root,(()=>{t(i.data)}))}))}async clone(){const t=await this.publishAsync();return new r(t)}static get Box(){return l}}class a{constructor(t){this.ptr=0,this.data=t}read8(){return this.data[this.ptr++]}read16(){return this.data[this.ptr++]<<8|this.data[this.ptr++]}read24(){return this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read32(){return this.data[this.ptr++]<<24|this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read64(){return 4294967296*this.read32()+this.read32()}readText(t){let e="";for(let s=0;s<t;s++){const t=this.data[this.ptr++];e+=String.fromCharCode(t)}return e}readTextAsNullTermination(){const t=this.data.length;let e="";for(;this.ptr<t;){const t=this.data[this.ptr++];if(0===t)break;e+=String.fromCharCode(t)}return e}readUint8Array(t,e,s){for(let i=0;i<s;i++)t[e++]=this.data[this.ptr++]}write8(t){return this.data[this.ptr++]=255&t,this}write16(t){return this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write24(t){return this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write32(t){return this.data[this.ptr++]=t>>24&255,this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write64(t){return this.write32(Math.floor(t/4294967296)),this.write32(Math.floor(t%4294967296)),this}writeText(t,e){for(let s=0,i=e=e||t.length;s<i;s++)this.data[this.ptr++]=t.charCodeAt(s);return this}writeTextAsNullTermination(t){return this.writeText(t),this.data[this.ptr++]=0,this}writeUint8Array(t,e,s){if(s<512)for(let i=0;i<s;i++)this.data[this.ptr++]=t[e++];else this.data.set(t.subarray(e,e+s),this.ptr),this.ptr+=s;return this}fill(t,e){e=e||0;for(let s=0;s<t;s++)this.data[this.ptr++]=e;return this}getPos(){return this.ptr}setPos(t){return this.ptr=t,this}skip(t){return this.ptr+=t,this}ready(){return this.ptr<this.data.length}copy(t){const e=this.data.subarray(this.ptr,this.ptr+t);return this.ptr+=t,this.ptr<0?new Uint8Array(e):e}toUint8Array(){return this.data}analyze(t){let e,s,i=null,n=this.ptr;const o=t=>!!t.match(/^[a-zA-Z0-9\u00a9]{4}$/);t?(e=this.read32(),s=this.readText(4),"mdat"===s&&1===e&&(e=this.read32()<<32|this.read32())):(e=this.data.length+8,s="isom",n-=8);if(n+e<=this.data.length&&o(s)){i={size:e-(t?0:8),type:s,container:!1,children:0};let n=8;for(;n<e;){let t=this.read32();const e=this.readText(4);if("mdat"===e&&1===t&&(t=this.read32()<<32|this.read32(),this.skip(-8)),!o(e))break;if(t<8)break;this.skip(t-8),n+=t,i.children++}e===n&&(i.container=!0)}return this.ptr=n,i}}class l{constructor(t,e,s){if(!t)throw new Error("Mp4Box Error");if("string"==typeof t){if(this.property=i[t],!this.property)throw new Error("not supported type : "+t);this.boxInfo={type:t,container:this.property.container}}else{if(!t.type)throw new Error("Need boxInfo.type");this.boxInfo=t,this.property=i[t.type]}this.type=this.boxInfo.type,this.container=this.boxInfo.container||this.property&&this.property.container||!1,this.setData(new Uint8Array(0),0),this.offset=null!==s&&s>0?s:0,this.id=null,this.parent=e,this.children=[],this.parent&&this.parent.appendChild(this),this.wholeSize=0}setData(t,e){this.data=t,this.buffer=new a(t),e&&(this.wholeSize=e)}setDataAndSync(t,e){this.setData(t,e),this.sync(1)}size(){return this.container?"isom"===this.type?0:8:this.wholeSize||this.data&&this.data.length}sync(t){const e=this.property&&this.property.struct||this.boxInfo.struct,s=this.property&&this.property.minLength||this.boxInfo.minLength;if(!e)return 0;if(0!==t&&1!==t&&2!==t)return 0;if(0!==t){if(this.buffer.data.length<8)return 0;this.buffer.setPos(8)}return this.recursiveProc({mode:t,struct:e,minLength:s},this,0)+8}calcLength(t,e,s){const i=typeof t;if(e=e>0?e:1,"number"==i)return t;if("string"==i){if("end"==t)return Math.floor((this.size()-this.buffer.getPos())/e);{const e=t.match(/(\w+)([\-\+\*\/\d]*)/);let s=this[e[1]]||0;const i=e[2]&&e[2][0];if(i){const t=Number(e[2].substr(1));"-"===i&&(s-=t),"+"===i&&(s+=t),"*"===i&&(s*=t),"/"===i&&(s/=t)}return s}}return 0}recursiveProc(t,e,s){const{mode:i,struct:r,minLength:a}=t;let l=0;for(let t=0,n=r.length;t<n;t++){const n=r[t][0],o=r[t][1];let h=r[t][2];const c=r[t][3],d=r[t][4];if(null===c||(this.version&&this.version>0&&"or"===c&&(h=d),!this.flags||"if"!==c||0!=(this.flags&d))){if(1===i&&!this.buffer.ready())break;if(2===i&&void 0===e[n])break;if(0===i&&a&&a<=l&&void 0===e[n])break;if("int"===o)1===h?(1===i?e[n]=this.buffer.read8():2===i&&this.buffer.write8(e[n]),l+=1):2===h?(1===i?e[n]=this.buffer.read16():2===i&&this.buffer.write16(e[n]),l+=2):3===h?(1===i?e[n]=this.buffer.read24():2===i&&this.buffer.write24(e[n]),l+=3):4===h?(1===i?e[n]=this.buffer.read32():2===i&&this.buffer.write32(e[n]),l+=4):8===h&&(1===i?e[n]=this.buffer.read64():2===i&&this.buffer.write64(e[n]),l+=8);else if("skip"===o){const t=this.calcLength(h,1);1===i?(e[n]="("+t+")bytes",this.buffer.skip(t)):2===i&&this.buffer.fill(t,0),l+=t}else if("text"===o){const t=this.calcLength(h,1);t>0?(1===i?e[n]=this.buffer.readText(t):2===i&&this.buffer.writeText(e[n],t),l+=t):(1===i?e[n]=this.buffer.readTextAsNullTermination():2===i&&this.buffer.writeTextAsNullTermination(e[n]),e[n]&&(l+=e[n].length+1))}else if(o instanceof Array&&((1===i||0===i&&void 0===e[n])&&(e[n]=[]),o.length>0)){const t=o[0]instanceof Array;let r=0;if(t)for(let t=0,e=o[0].length;t<e;t++)r+=o[0][t][2];else r=o[1];const c=0===i?e[n].length:this.calcLength(h,r);for(let r=0;r<c;r++)if(t){const t=1===i?{}:e[n][r];t&&(l+=this.recursiveProc({mode:i,struct:o,minLength:a},t,s+1),1===i&&e[n].push(t))}else l+=this.recursiveProc({mode:i,struct:[[r,o[0],o[1]]],minLength:a},e[n],s+1)}0===s&&e[n]}}return o!==n?Math.ceil(415241365*Math.random()):l}hasChild(t){for(let e=0,s=this.children.length;e<s;e++)if(this.children[e]===t)return e;return-1}append(t){return this.appendChild(t)}appendChild(t){if(t){if(-1===this.hasChild(t)){this.children.push(t);let e=this[t.type+"s"];e||(e=[]),e.push(t),this[t.type+"s"]=e,this[t.type]=e[0]}t.parent=this}}remove(t){return this.removeChild(t)}removeChild(t){if(t){const e=this.hasChild(t);if(-1!==e){this.children.splice(e,1);const s=this[t.type+"s"];if(s){const e=s.indexOf(t);e>=0&&s.splice(e,1),s.length>0?this[t.type]=s[0]:(delete this[t.type+"s"],delete this[t.type])}else delete this[t.type]}t.parent=null}}find(t){const e=s=>{if(s.type===t)return s;for(let t=0,i=s.children.length;t<i;t++){const i=e(s.children[t]);if(i)return i}return null};return e(this)}findAll(t){const e=(s,i)=>{s.type===t&&i.push(s);for(let t=0,n=s.children.length;t<n;t++)e(s.children[t],i);return i};return e(this,[])}arrange(){const t=e=>{const s=e.sync(0)||e.size();"mdat"!==e.type&&s!==e.data.length&&e.setData(new Uint8Array(s)),e.sync(2);let i=e.offset+s;for(let s=0,n=e.children.length;s<n;s++)e.children[s].offset=i,i+=t(e.children[s]);return e.wholeSize=i-e.offset,e.buffer.setPos(0),e.buffer.write32(e.wholeSize),e.buffer.writeText(e.type,4),e.wholeSize};return t(this)}publish(t,e,s){const i=this.sync(0);i>0&&i>this.data.length&&this.setData(new Uint8Array(i)),this.sync(2);const n=this.size();n>0&&t&&t.writeUint8Array(this.data,0,n),s(null)}publishToFile(t,e,s){const i=this.sync(0);i>0&&i>this.data.length&&this.setData(new Uint8Array(i)),this.sync(2);this.size()>0&&t?t(this.type,((t,e)=>{e||t.write(new Blob([this.data])),s(null)})):s(null)}inspect(){return"Box : '"+this.type+"' [ "+(this.container?"container":"prop")+" ] / "+this.size()}dump(){var t="";for(var e in this)"function"!=typeof this[e]&&(t+=e+":"+this[e]+" , ");return t}static create(t,e,s){const n={};if(n.type=t,n.struct=e||i[t].struct,n.struct||s instanceof Uint8Array){const t=new l(n);if(n.struct){t.setData(new Uint8Array(0));for(let e=0,i=n.struct.length;e<i;e++){const i=n.struct[e][0],o=n.struct[e][1];t[i]=s&&s[i]||(o instanceof Array?[]:"text"===o?"":0)}}else t.setDataAndSync(s);return t}return null}static get ignore(){return{type:1,container:1,data:1,buffer:1,offset:1,id:1,parent:1,children:1,wholeSize:1,boxInfo:1,property:1}}}function h(t,e,s){const{type:i,startPTS:a,endPTS:l,startDTS:h,endDTS:c,hasAudio:d,hasVideo:u,dropped:m,nb:p,data1:f,data2:v}=s,g=function(t){const e=t.root;if(e.moov){const t=e.moov.traks.length;if(t>1&&e.moov.mvex.trexs.length===t){const s=[];for(let i=0;i<t;i++){if(o!==n&&2===t)continue;const a=new r,l=a.root;e.ftyp&&l.append(e.ftyp),l.append(new r.Box("moov")),l.moov.append(e.moov.mvhd),l.moov.append(new r.Box("mvex")),l.moov.mvex.append(e.moov.mvex.trexs[i]),l.moov.append(e.moov.traks[i]),l.arrange(),s.push(a)}return s}}else if(e.moof){const s=t.data,i=e.moof.trafs.length;if(i>1){const t=[];for(let a=0;a<i;a++){if(o!==n&&0===i)continue;const l=new r,h=l.root;e.styp&&h.append(e.styp),e.sidx&&h.append(e.sidx),h.append(new r.Box("moof")),h.moof.append(e.moof.mfhd),h.moof.append(e.moof.trafs[a]),h.arrange(),h.publish(null,null,(()=>{})),t.push(l);const c=[];let d=0;for(const t of e.moof.trafs[a].truns){let i=e.moof.offset+t.dataOffset,n=0;for(const e of t.samples)n+=e.size;c.push(s.slice(i,i+n)),d+=n}const u=new Uint8Array(8);d+=8,u.set([d>>24&255,d>>16&255,d>>8&255,255&d,109,100,97,116]),l.mdat=new Blob([u,...c]),l.isDivided=!0}return t}}return[t]}(new r(new Uint8Array(f)));if(1===g.length){const s=g[0];for(let i=0;i<s.root.moofs.length;i++){const n=s.root.moofs[i],o=t.getTrackByNumber(n.traf.tfhd.trackID),r=o.moofs.length;o.moofs[r]=n,o.mdats[r]=new Blob([s.root.mdats[i].data]),o.start[r]=1e9*e.cc+r}for(let s=0;s<t.tracks.length;s++)t.tracks[s].duration+=e.duration}else{const s=e._n;for(const i of g){const n=t.getTrackByNumber(i.root.moof.traf.tfhd.trackID);n.moofs[s]=i.root.moof,n.mdats[s]=i.mdat,n.start[s]=1e9*e.cc+e.sn,n.duration+=e.duration}}t.size+=f?.byteLength||0}function c(t){const e=t=>{"mdat"!==t.type&&(t.data=null,t.buffer=null);for(let s=0,i=t.children.length;s<i;s++)e(t.children[s])};return e(t)}function d(t,e,s){const{type:i,startPTS:n,endPTS:o,startDTS:a,endDTS:l,hasAudio:d,hasVideo:u,dropped:m,nb:p,data1:f,data2:v}=s;let g=0;if(!i.match(/audio|video/))return;if("audiovideo"===i)return h(t,e,s);const y=t.getTrackByType(i);let w=y.init;const b=e._n;if(w&&w.id.includes("void")&&v&&MpegAudio.isHeader(v,0)){const t=MpegAudio.parseHeader(v,0);w=y.init=function(t){const{sampleRate:e,channelCount:s}=t,i=new r,n=i.root;n.append(new r.Box("moov"));const o=r.Box.create("mvhd",null,{timeScale:e,duration:0,rate:65536,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824],preDefined:24,nextTrackID:0});n.moov.append(o),n.moov.append(new r.Box("trak"));const a=n.moov.trak,l=r.Box.create("tkhd",null,{flags:3,trackID:1,duration:0,layer:0,alternateGroup:1,volume:256,matrix:[65536,0,0,0,65536,0,0,0,1073741824]});a.append(l),a.append(new r.Box("mdia"));const h=r.Box.create("mdhd",null,{timeScale:e,duration:5120,languageValues:21956});a.mdia.append(h);const c=r.Box.create("hdlr",null,{handlerType:"soun",name:"SoundHandler"});a.mdia.append(c),a.mdia.append(new r.Box("minf")),a.mdia.minf.append(r.Box.create("smhd")),a.mdia.minf.append(new r.Box("dinf")),a.mdia.minf.dinf.append(r.Box.create("dref",null,{entryCount:1,entrySize:12,typeText:"url ",entryVersion:0,entryFlags:1})),a.mdia.minf.append(new r.Box("stbl"));const d=r.Box.create("stsd",[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["code","text",4],["reserved","int",3],["reserved2","int",3],["dataReferenceIndex","int",2],["reserved3","int",8],["channelCount","int",2],["sampleSize","int",2],["reserved4","int",4],["sampleRate","int",2],["reserved5","int",2]],{entryCount:1,entrySize:36,code:".mp3",dataReferenceIndex:1,channelCount:s,sampleSize:16,sampleRate:e});return a.mdia.minf.stbl.append(d),n.moov.append(new r.Box("mvex")),n.moov.mvex.append(r.Box.create("trex",null,{sampleDescriptionIndex:1,sampleFlags:65537})),i.id=`audio/mp3:${n.moov.trak.mdia.mdhd.timeScale}`,n.arrange(),i}(t)}if(f&&!v){const t=new r(new Uint8Array(f));for(let s=0;s<t.root.moofs.length;s++){const i=y.moofs.length,n=t.root.moofs[s],o=n.offset,r=o+n.wholeSize;c(n),y.moofs[i]=n,y.mdats[i]=new Blob([t.root.mdats[s].data]),y.start[i]=1e9*e.cc+e.sn,g+=r-o+y.mdats[i].size}}else if(w&&w.id.includes("mp3")){if(!v)return;const{moof:t,mdat:s}=function(t){const e=[],s=t.length;for(let i=0;i<s;){const s=MpegAudio.parseHeader(t,i);if(!s)break;const n=s.frameLength;e.push({duration:s.samplesPerFrame,size:n}),i+=n}const i=new r;i.root.append(new r.Box("moof")),i.root.moof.append(new r.Box("traf")),i.root.moof.traf.append(r.Box.create("tfhd",[["version","int",1],["flags","int",3],["trackID","int",4],["defaultSampleFlags","int",4,"if",32]],{flags:32,defaultSampleFlags:65536})),i.root.moof.traf.append(r.Box.create("tfdt",null,{}));const n=r.Box.create("trun",null,{flags:768,sampleCount:e.length,samples:e});i.root.moof.traf.append(n),i.root.arrange();const o=new Uint8Array(8),a=s+8;return o.set([a>>24&255,a>>16&255,a>>8&255,255&a,109,100,97,116]),{moof:i,mdat:new Blob([o,t])}}(v);y.moofs[b]=t,y.mdats[b]=s,y.start[b]=1e9*e.cc+e.sn,g=v.byteLength}else{if(!f||!v)return;const t=new r(new Uint8Array(f));c(t.rootBox),y.moofs[b]=t,y.mdats[b]=new Blob([v]),y.start[b]=1e9*e.cc+e.sn,g=f.byteLength+v.byteLength}y.duration+=e.duration,t.size+=g}async function u(t){return new Promise(((e,s)=>{const i=new FileReader;i.onload=t=>{e(i.result)},i.onerror=t=>{s(i.error)},i.readAsArrayBuffer(t)}))}async function m(t){return new Promise(((e,s)=>{setTimeout(e,t)}))}return{Video:class{constructor(t){this.tracksIndex={},this.tracks=[],this.sourceType=2,this.hasAltAudio=!1,this.isLive=void 0!==t.live&&t.live,this.size=0,this.quality=null,this.byteEncoder()}async push(t){const e=isNaN(t.startDTS)?t.start:t.startDTS;try{const{demuxer:s}=t,i=t.sn===s.prevSN+1&&t.cc===s.prevCC&&!s.prevError;s.prevError=null,s.prevSN=t.sn,s.prevCC=t.cc;const n=await s.parse(t.data,t.decryptdata,e,!0,i),o=n[HlsEvents.FRAG_PARSING_INIT_SEGMENT];o&&function(t,e,s){let i=s.tracks;i.audiovideo&&(i=function(t){const e=new r(t.initSegment).root;if(!e.moov)return t;const{container:s,codec:i}=t,n={};for(let t=0,o=e.moov.traks.length;t<o;t++){const o=new r,a=o.root;e.ftyp&&a.append(e.ftyp),a.append(new r.Box("moov")),a.moov.append(e.moov.mvhd),a.moov.append(new r.Box("mvex")),a.moov.mvex.append(e.moov.mvex.trexs[t]),a.moov.append(e.moov.traks[t]),a.arrange();n["vide"===e.moov.traks[t].mdia.hdlr.handlerType?"video":"audio"]={initSegment:o,container:s,codec:i,isMP4:!0}}return n}(i.audiovideo));for(const e in i){if(!e.match(/audio|video/))continue;const s=i[e],n=t.getTrackByType(e);if(s.initSegment){const t=s.isMP4?s.initSegment:new r(s.initSegment),e=t.root&&t.root.moov;t.id=e?`${s.container}:${s.codec}:${e.trak.tkhd.width}:${e.trak.tkhd.height}:${e.trak.mdia.mdhd.timeScale}`:`${s.container}:${s.codec}:void`,n.init=t}try{if("video"===e){const t=n.init.root.moov.trak.tkhd;n.quality=Math.floor(t.width/65536+.4)+" x "+Math.floor(t.height/65536+.4)}else{const t=n.init.root.moov.trak.mdia.mdhd;n.quality=t.timeScale+" Hz"}}catch(t){n.quality=""}}t.setQuality()}(this,0,o);const a=n[HlsEvents.FRAG_PARSING_DATA];if(a)for(const e of a)d(this,t,e);return{ok:!0}}catch(t){return t.fatal?{ok:!1,message:t.message}:(this.prevError=t,{ok:!0})}}getTrackByType(t){return void 0===this.tracksIndex[t]&&(this.tracksIndex[t]=this.tracks.length,this.tracks.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,mimetype:t,quality:""})),this.tracks[this.tracksIndex[t]]}getTrackByNumber(t){for(const e of this.tracks)if(e.init?.root?.moov?.trak?.tkhd?.trackID===t)return e;return null}getDuration(){const t=this.tracks;if(this.tracks.length<1)return 0;const e=[];for(const s of t)e.push(Math.round(s.duration));return e.length<1?0:Math.max(...e)}setQuality(){let t="",e="";for(const s of this.tracks)s?.mimetype?.includes("video")&&(t=s.quality),s?.mimetype?.includes("audio")&&(e=s.quality);this.quality=t+(""!==t?" - ":"")+e}getQuality(){return this.quality||this.setQuality(),this.quality}clearAllTracks(){for(const t of this.tracks)this.clearTrack(t)}clearTrack(t){t.moofs=[],t.mdats=[],t.start=[],t.durations=[],t.duration=0}async tracksToMp4(t,e){if(!t||0===t.length)return null;let s=0;for(let S=0;S<t.length;S++)t[S].mimetype.includes("video")&&(s=S);2===t.length&&1===s&&(t=[t[1],t[0]],s=0);const{keyFrameComplement:i,modifyESDSTrackConfig:h,over4G:c}=e,d=[];for(let C=0,L=t.length;C<L;C++){const D=t[C];let I=0;if(o===n||0!==C)for(let M=0,R=D.mdats.length;M<R;M++)void 0!==D.start[M]&&(d.push({track:C,num:M,order:I,start:D.start[M]}),I++)}d.sort(((t,e)=>t.start-e.start));for(const A of t)A.mdats[0]&&9===A.mdats[0].size&&(A.mdats=[]);const p=[],f=[];for(const P of t){let U;U=P.init&&P.init.data?P.init.data.length<2e4?new r(P.init.data.slice()):P.init:await P.init.clone(),p.push(U),f.push(U.root)}p.length;for(let E=0,B=f.length;E<B;E++){const z=f[E];z.moov.mvhd.version=z.moov.trak.tkhd.version=z.moov.trak.mdia.mdhd.version=0,z.moov.trak.tkhd.flags=3;const O=E+1;if(z.moov.trak.tkhd.trackID=z.moov.mvex.trex.trackID=O,z.ftyp&&(z.ftyp.majorBrand="mp42",z.ftyp.minorVersion=0,z.ftyp.compatibleBrands=["isom","iso2","avc1","mp41","mp42"]),h){const F=z.moov.trak.mdia.minf.stbl.stsd,N=new a(F.data);N.skip(12);const _=N.read32();for(let q=0;q<_;q++){const j=N.read32();if("mp4a"===N.readText(4)){N.skip(28);const H=N.getPos(),G=N.read32();if("esds"===N.readText(4)){N.skip(5);const V=N.read8();N.skip(4);const W=N.read8();N.skip(14);const Q=N.read8();if(4===Q){const K=N.read8(),X=N.read8();N.skip(2);const J=[];for(let Y=0,Z=G-38;Y<Z;Y++)J.push(N.read8());N.setPos(H),N.write32(G),N.skip(9),N.write8(V-2),N.skip(4),N.write8(W-2),N.skip(14),N.write8(Q-2),N.write8(16+(7&K)),N.write8(248&X);for(const tt of J)N.write8(tt);N.write16(0)}}else N.skip(G-8)}else N.skip(j-8)}}}const v=new r,g=v.root;g.append(f[s].ftyp),g.append(new r.Box("moov")),g.moov.append(f[s].moov.mvhd);for(const et of f)g.moov.append(et.moov.trak);g.moov.mvhd.nextTrackID=p.length+1;g.moov.mvhd.creationTime=g.moov.mvhd.modificationTime=0;for(let st=0,it=p.length;st<it;st++)g.moov.traks[st].tkhd.creationTime=g.moov.traks[st].mdia.mdhd.creationTime=g.moov.traks[st].tkhd.modificationTime=g.moov.traks[st].mdia.mdhd.modificationTime=0;const y=await(async(t,e)=>{const s=[{type:"vide",length:0,moofs:[],hasBaseMediaDecodeTime:!1},{type:"soun",length:0,moofs:[],hasBaseMediaDecodeTime:!1}];for(const i of s)for(const s of t)s.mdia.hdlr.handlerType===i.type&&Object.assign(i,{trackID:s.tkhd.trackID,timeScale:s.mdia.mdhd.timeScale,length:e[s.tkhd.trackID-1].moofs.length});const i=Math.max(s[0].length,s[1].length);for(let t=0;t<i;t++)for(let i=0;i<2;i++){const n=s[i],o=e[n.trackID-1]?.moofs[t];if(!o){n.moofs[t]={empty:!0,baseMediaDecodeTime:0,duration:0};continue}const a=(o instanceof r?o:o instanceof l?{root:{moof:o}}:new r(new Uint8Array(await u(o)))).root.moof.traf;let h=a.tfdt.baseMediaDecodeTime<-2147483648?0:a.tfdt.baseMediaDecodeTime;h+=(4294967295&h)<0?4294967296:0,h/=n.timeScale,h<0&&console.error("baseMediaDecodeTime : unexpected value",h);let c=!1;if(t>0)if(n.moofs[t-1].empty)c=!0;else{const{baseMediaDecodeTime:e,duration:s}=n.moofs[t-1];(h<e||h>e+2*s)&&(c=!0)}let d=0,m=0;for(const t of a.truns){t.samples=t.samples||new Array(t.sampleCount||0).fill({});const e=t.samples||[];for(const t of e)d+=t.duration||a.tfhd?.defaultSampleDuration||f[i].moov?.mvex?.trex?.sampleDuration||0,33554432&t.flags&&m++}d/=n.timeScale;const p=(a.trun?.samples?.[0]?.compositionTimeOffset||0)/n.timeScale;n.moofs[t]={baseMediaDecodeTime:h,compositionTimeOffset:p,duration:d,keyFrames:m,discontig:c},h>0&&(n.hasBaseMediaDecodeTime=!0)}return s})(g.moov.traks,t),w=(t=>{const e=[[],[]];if(t[0].length>1&&!t[0].hasBaseMediaDecodeTime||t[1].length>1&&!t[1].hasBaseMediaDecodeTime)return e;const s=[0,0],i=[0,0];t[0].elstPadding=t[1].elstPadding=0;for(let n=0,o=Math.max(t[0].length,t[1].length);n<o;n++){const o=t[0].moofs[n],r=t[1].moofs[n];if(o&&r){if(o.empty&&(o.baseMediaDecodeTime=i[0]-s[0],o.duration=0,t[0].moofs[n+1]&&!t[0].moofs[n+1].empty&&(t[0].moofs[n+1].discontig=!0)),r.empty&&(r.baseMediaDecodeTime=i[1]-s[1],r.duration=0,t[1].moofs[n+1]&&!t[1].moofs[n+1].empty&&(t[1].moofs[n+1].discontig=!0)),0===n){const i=o.baseMediaDecodeTime-r.baseMediaDecodeTime,n=i>0?0:1,a=Math.abs(i);if(a>.01){const s=t[n].moofs?.[0]?.compositionTimeOffset||0;e[n].push({segmentDuration:Math.floor(1e3*(a+s)),mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0})}t[n].elstPadding=a,s[0]=s[1]=-Math.min(r.baseMediaDecodeTime,o.baseMediaDecodeTime)}else if(o.discontig&&r.discontig){const t=o.baseMediaDecodeTime-r.baseMediaDecodeTime-(i[0]-i[1]);t>=0?(s[0]=i[0]+t-o.baseMediaDecodeTime,s[1]=i[1]-r.baseMediaDecodeTime):(s[0]=i[0]-o.baseMediaDecodeTime,s[1]=i[1]-t-r.baseMediaDecodeTime)}else o.discontig?s[0]=i[0]-o.baseMediaDecodeTime:r.discontig&&(s[1]=i[1]-r.baseMediaDecodeTime);o.baseMediaDecodeTime+=s[0],r.baseMediaDecodeTime+=s[1],i[0]=o.baseMediaDecodeTime+o.duration,i[1]=r.baseMediaDecodeTime+r.duration}}for(let s=0;s<2;s++){if(o!==n&&0===s)continue;const r=t[s],a=Math.floor(1e3*(i[s]-r.elstPadding))||123456789,l=r.moofs?.[0]?.compositionTimeOffset||0,h=Math.floor(l*r.timeScale)||0;e[s].push({segmentDuration:a,mediaTime:h,mediaRateInteger:1,mediaRateFraction:0})}return e})(y);let b=[{},{}];try{b=await(t=>{const e=[{},{}];if(t[0].length>1&&!t[0].hasBaseMediaDecodeTime||t[1].length>1&&!t[1].hasBaseMediaDecodeTime)return e;let s=[0,0],i=!1;t[0].duration=t[1].duration=0,t[0].original_duration=t[1].original_duration=0;const n=Math.max(t[0].length,t[1].length);for(let o=0;o<n;o++){for(let i=0;i<2;i++){if(t[i].moofs[o].empty)continue;const r=0;if(o<n-2-1){const n=t[i].duration-(t[i].moofs[o].baseMediaDecodeTime-t[i].elstPadding+r);n<-.05?(s[i]++,s[i]>=2&&(e[i][o+1]=Math.floor(n*t[i].timeScale),t[i].duration-=n,s[i]=0)):s[i]=0}t[i].original_duration+=t[i].moofs[o].duration,t[i].duration+=t[i].moofs[o].duration}if(o===n-2-2){const e=t[0].original_duration-t[1].original_duration;Math.abs(e)<.1&&(i=!0)}}return i?[{},{}]:e})(y)}catch(nt){console.log(nt.stack||nt.message||nt)}let T=0;for(const ot of g.moov.traks){const rt=ot.mdia.minf.stbl,at=ot.tkhd.trackID,lt=ot.mdia.hdlr.handlerType;"soun"===lt&&(ot.tkhd.alternateGroup=1,ot.tkhd.volume=256);let{stsz:ht,stts:ct,stsc:dt,stss:ut,stco:mt,ctts:pt,sdtp:ft,co64:vt}=rt;ht||rt.append(ht=r.Box.create("stsz")),ct||rt.append(ct=r.Box.create("stts")),dt||rt.append(dt=r.Box.create("stsc")),ut||rt.append(ut=r.Box.create("stss")),ft||(ft=r.Box.create("sdtp")),pt||(pt=r.Box.create("ctts")),c?(vt||rt.append(vt=r.Box.create("co64")),mt&&(rt.remove(mt),mt=null)):(mt||rt.append(mt=r.Box.create("stco")),vt&&(rt.remove(vt),vt=null)),ht.sampleSizes=[],ct.entries=[],dt.entries=[],ut.syncSamples=[],ft.sampleDependencies=[],pt.entries=[];let gt=0,yt=0,wt=0,bt=0,Tt=0,kt=-1,xt=0,$t=0;const St=[];let Ct=0;for(const Mt of t[at-1].moofs){if(!Mt)continue;const Rt=Mt instanceof r?Mt:Mt instanceof l?{root:{moof:Mt}}:new r(new Uint8Array(await u(Mt))),At=Rt.root.moof;Rt.root.mdat&&t[at-1].mdats.push(new Blob([Rt.root.mdat.data]));const Pt=At.traf,Ut=Pt.tfhd,Et=f[at-1].moov.mvex&&f[at-1].moov.mvex.trex;yt++;let Bt=0,zt=0;$t+=b[at-1][yt]||0;for(const Ot of Pt.truns){Ot.samples=Ot.samples||new Array(Ot.sampleCount||0).fill({});for(const Ft of Ot.samples){const Nt=Object.assign({},Ft);if(gt++,Nt.duration=Nt.duration||Ut&&Ut.defaultSampleDuration||Et&&Et.sampleDuration||0,Nt.size=Nt.size||Ut&&Ut.defaultSampleSize||Et&&Et.sampleSize||0,Nt.flags=Nt.flags||Ut&&Ut.defaultSampleFlags||Et&&Et.sampleFlags||0,$t=Math.floor($t),0!==$t)if("vide"===lt){const _t=$t>0?Math.min(Nt.duration-1,$t):$t;Nt.duration-=_t,$t-=_t}else"soun"===lt&&$t<0&&Nt.duration<-$t&&(Bt++,Tt++,Ct+=Nt.duration,ht.sampleSizes.push(0),$t+=Nt.duration);i&&0===zt&&St.push(gt),zt++,(33554432&Nt.flags)>0&&("soun"===lt||ut.syncSamples.push(gt)),ht.sampleSizes.push(Nt.size),bt!==Nt.duration&&(Tt>0&&(ct.entries.push({sampleCount:Tt,sampleDuration:bt}),Tt=0),bt=Nt.duration),Tt++,Ct+=Nt.duration,(2048&Ot.flags)>0&&(kt!==Nt.compositionTimeOffset&&xt>0&&(pt.entries.push({sampleCount:xt,sampleOffset:kt}),xt=0),kt=Nt.compositionTimeOffset,xt++)}Bt+=Ot.sampleCount,Pt.sdtp&&ft.sampleDependencies.push(...Pt.sdtp.sampleDependencies)}wt!==Bt&&(wt=Bt,dt.entries.push({firstChunk:yt,samplesPerChunk:wt,sampleDescriptionIndex:1})),yt%100==0&&await m(1)}function Lt(){const t=[];let e=0;for(const t of ht.sampleSizes)e+=t;const s=e/ht.sampleSizes.length;e=0;for(const t of ht.sampleSizes){const i=t-s;e+=i*i}const i=Math.sqrt(e/ht.sampleSizes.length);for(let e=0,n=ht.sampleSizes.length;e<n;e++){(ht.sampleSizes[e]-s)/i>3&&t.push(e+1)}return o!==n?[]:t}if(ct.entries.push({sampleCount:Tt,sampleDuration:bt}),-1!==kt&&pt.entries.push({sampleCount:xt,sampleOffset:kt}),"vide"===lt&&ut.syncSamples.length<1+Math.floor(.8*yt)){const qt=Lt();qt.length>ut.syncSamples.length?ut.syncSamples=qt:i&&St.length>ut.syncSamples.length&&(ut.syncSamples=St),0===ut.syncSamples.length&&(ut.syncSamples=[1])}ht.sampleCount=ht.sampleSizes.length,ct.entryCount=ct.entries.length,dt.entryCount=dt.entries.length,ut.entryCount=ut.syncSamples.length,c?(vt.entryCount=yt,vt.chunkOffsets=new Array(yt)):(mt.entryCount=yt,mt.chunkOffsets=new Array(yt)),pt.entries.length&&(pt.entryCount=pt.entries.length,"soun"!==lt&&rt.append(pt)),ot.mdia.mdhd.duration=Ct,ot.tkhd.duration=Math.floor(Ct/ot.mdia.mdhd.timeScale*1e3),ot.edts||ot.append(new r.Box("edts")),ot.edts.elst||ot.edts.append(r.Box.create("elst"));const Dt=pt.entryCount>0?pt.entries[0].sampleOffset:0,It=w[at-1]||[];It.length>0?(ot.edts.elst.entryCount=It.length,ot.edts.elst.entries=It):(ot.edts.elst.entryCount=1,ot.edts.elst.entries=[{segmentDuration:ot.tkhd.duration,mediaTime:Dt,mediaRateInteger:1,mediaRateFraction:0}]),ft.sampleDependencies.length&&rt.append(ft),ot.mdia.mdhd.duration=Ct,T=Math.max(Ct/ot.mdia.mdhd.timeScale,T)}const k=Math.floor(1e3*T);g.moov.mvhd.timeScale=1e3,g.moov.mvhd.duration=k,g.arrange();let x=v.size();for(const jt of d)c?g.moov.traks[jt.track].mdia.minf.stbl.co64.chunkOffsets[jt.order]=x+8:g.moov.traks[jt.track].mdia.minf.stbl.stco.chunkOffsets[jt.order]=x+8,x+=t[jt.track].mdats[jt.num].size;const $=[new Blob([await v.publishAsync()])];for(const Ht of d)$.push(t[Ht.track].mdats[Ht.num]);return new Blob($,{type:"appplication/octet-stream"})}async flush(){let t=null;try{const e=this.isLive&&this.hasAltAudio?function(t){let e=0;for(const s of t){const t=s.start.length;t>0&&s.start[t-1]>e&&(e=s.start[t-1])}let s=e;for(const e of t){e.start.length>0&&e.start[0]<s&&(s=e.start[0])}const i=[];for(const e of t){const{mimetype:t,init:s}=e;i.push({mimetype:t,init:s,moofs:[],mdats:[],start:[]})}for(let n=s;n<=e;n++){const e=[];for(let s=0,i=t.length;s<i;s++){const i=t[s].start.indexOf(n);-1!==i&&e.push(i)}if(e.length===t.length)for(let s=0,n=t.length;s<n;s++){const n=t[s],o=e[s],r=i[s];r.moofs.push(n.moofs[o]),r.mdats.push(n.mdats[o]),r.start.push(n.start[o])}}return i}(this.tracks):function(t){const e=[];for(const s of t)if(s.init&&s.moofs.length>0){const t=s.moofs.slice(0),i=s.mdats.slice(0),n=s.start.slice(0),{mimetype:o,init:r}=s;e.push({mimetype:o,init:r,moofs:t,mdats:i,start:n})}return e}(this.tracks),{size:s,sourceType:i}=this;if(0===e.length||0===e[0].moofs.length)return{ok:!1,fatal:!1,message:"No tracks available"};const n={};n.keyFrameComplement=4===i,n.modifyESDSTrackConfig=4===i,n.over4G=s>4e9,t=await this.tracksToMp4(e,n)}catch(t){return{ok:!1,fatal:!0,message:t.message}}return{ok:!0,blob:t}}byteEncoder(){void 0===n?n=0:Array.isArray(n)&&(n=parseInt(n.join("")))}},HLSDemuxer:class{constructor(t,e,s,i){this.demuxer=null,this.remuxer=null,this.initSegment=t,this.audioCodec=e,this.videoCodec=s,this.duration=i,this.result={},this.resolve=null,this.reject=null,this._evt_=[],this.prevSN=-1,this.prevCC=-1,this.prevError=null}init(){this.demuxer&&(this.demuxer.resetInitSegment(this.initSegment,this.audioCodec,this.videoCodec,this.duration),this.demuxer.resetTimeStamp()),this.remuxer&&(this.remuxer.resetInitSegment(),this.remuxer.resetTimeStamp())}get observer(){return{trigger:(t,e)=>{if(this._evt_.push(t.replace(/hlsFrag/,"").replace(/hls/,"")),"hlsError"===t&&this.reject({fatal:!1,message:e}),t===HlsEvents.FRAG_PARSED)return this._evt_=[],this.resolve(this.result);t===HlsEvents.FRAG_PARSING_INIT_SEGMENT?this.result[t]=e:t===HlsEvents.FRAG_PARSING_DATA&&(this.result[t]||(this.result[t]=[]),this.result[t].push(e))}}}parse(i,n,o,r,a){return new Promise((async(n,l)=>{this.result={},this.resolve=n,this.reject=l;try{if(!this.demuxer){for(const n of t)if(n.demux.probe(i)){this.remuxer=new n.remux(this.observer,e,s,navigator.vendor),this.demuxer=new n.demux(this.observer,this.remuxer,e,s);break}if(!this.demuxer)return l({fatal:!0,message:"No usable media demuxer"});a=!1}a||this.init(),this.demuxer.append(i,o,a,r)}catch(t){l({fatal:!0,message:t.message})}}))}}}})();document.body.setAttribute("data-version",chrome.runtime.getManifest().version);const lang=t=>chrome.i18n.getMessage(t);class Panel{constructor(t,e){this.controller=e,this.$panel=t,this.$noDate=this.selector("no-data"),this.$hasDate=this.selector("has-data"),this.$fileIcon=this.selector("file-icon"),this.$fileIconText=this.selector("file-icon-text"),this.$preview=this.selector("preview"),this.$previewVideo=this.selector("preview-video"),this.$quality=this.selector("quality"),this.$qualityDropdown=this.selector("quality-dropdown"),this.$openSource=this.selector("open-source"),this.$filename=this.selector("filename"),this.$filenameInput=this.selector("filename-input"),this.$rename=this.selector("rename"),this.$renameConfirm=this.selector("rename-confirm"),this.$progress=this.selector("progress"),this.$chunksCompleted=this.selector("chunks-completed"),this.$chunks=this.selector("chunks"),this.$size=this.selector("size"),this.$speed=this.selector("speed"),this.$duration=this.selector("duration"),this.$cancel=this.selector("cancel"),this.$start=this.selector("start"),this.$pause=this.selector("pause"),this.$save=this.selector("save"),this.$saveDownloaded=this.selector("save-downloaded"),this.$options=this.selector("options"),this.$downloadsList=this.selector("downloads-list"),this.$stop=this.selector("stop"),this.$collapseOption=this.selector("collapse-option"),this.$optionThreads=this.selector("option-threads"),this.$threads=this.selector("thread",!0),this.$previewSwitch=this.selector("preview-switch"),this.$tabProgress=this.selector("tab-progress"),this.$autoSave=this.selector("auto-save"),this.$clearCache=this.selector("clear-cache"),this.$resolution=this.selector("resolution"),this.$defaultResolution=this.selector("default-resolution"),this.$filenameType=this.selector("filename-type",!0),this.$optionsClose=this.selector("options-close"),this.$errorPause=this.selector("error-pause"),this.$requestErrorDetail=this.selector("request-error-detail"),this.$singleThread=this.selector("single-thread"),this.$error=this.selector("error"),this.$errorBox=this.selector("error-box"),this.$clearCacheStatus=this.selector("clear-cache-status"),this.$clearCacheTimer=this.selector("clear-cache-timer"),this.$clearCacheEnd=this.selector("clear-cache-end"),this.$liveSaveModal=this.selector("live-save-modal"),this.clearCacheTimer=null,this.tabTitle=document.title}previewToggle(t=!1){t?this.controller.previewURL&&(this.$previewVideo.src||(this.$previewVideo.src=this.controller.previewURL),this.show(this.$preview),this.hide(this.$fileIcon)):(this.hide(this.$preview),this.show(this.$fileIcon))}selector(t,e=!1){return e?this.$panel.querySelectorAll('[selector="'+t+'"]'):this.$panel.querySelector('[selector="'+t+'"]')}init(){return new Promise((t=>{const{options:e,filename:s,hasData:i,initiator:n}=this.controller;if(!i)return this.$noDate.classList.remove("d-none"),this.$hasDate.classList.add("d-none"),void t();this.$noDate.remove(),this.$hasDate.classList.remove("d-none"),n&&(this.$openSource.onclick=()=>{chrome.runtime.sendMessage({cmd:"OPEN_INITIATOR",parameter:{initiator:n}})},this.show(this.$openSource)),this.$filename.innerText=s,this.$filenameInput.value=s,this.$filenameType.forEach((t=>{t.checked=e.filenameType===t.value})),this.hide(this.$save,this.$saveDownloaded),this.$start.disabled=!0,this.$pause.disabled=!0,this.$threads.forEach((t=>{const s=parseInt(t.getAttribute("data-thread"));e.threads===s?t.classList.add("text-danger"):t.classList.remove("text-danger")})),this.$previewSwitch.checked=e.preview,this.$autoSave.checked=e.autoSave,this.$clearCache.checked=e.clearCache,this.$tabProgress.checked=e.tabProgress,import("../bootstrap/js/bootstrap.bundle.min.js").then((({bootstrap:e})=>{this.$panel.querySelectorAll(".tooltip-toggle").forEach((t=>{new e.Tooltip(t,{trigger:"hover"})}));const s=new e.Collapse(this.$collapseOption,{toggle:!1});this.$options.onclick=()=>s.toggle(),this.$optionsClose.onclick=()=>s.hide(),this.bootstrap=e,this.loadEvent(),t()}))}))}loadEvent(){this.$rename.onclick=()=>{this.hide(this.$filename,this.$rename),this.show(this.$filenameInput,this.$renameConfirm)},this.$filenameInput.onblur=()=>{const t=this.$filenameInput.value.trim();t?(this.controller.filename=t,this.show(this.$filename,this.$rename),this.hide(this.$filenameInput,this.$renameConfirm),this.controller.nameConvert(),this.$filename.innerText=this.controller.filename,this.$filenameInput.value=this.controller.filename):this.$filenameInput.focus()},this.$filenameInput.onkeydown=t=>{"Enter"===t.key&&this.$filenameInput.blur()},this.$cancel.onclick=()=>this.cancel(),this.$start.onclick=()=>this.controller.start(),this.$pause.onclick=()=>this.controller.pause(),this.$stop.onclick=()=>this.controller.stop(),this.$save.onclick=()=>{const{blobURL:t}=this.controller;t&&(this.controller.save(t),setTimeout((()=>{this.clearCache()}),8e3))},this.$saveDownloaded.onclick=()=>{const t=this.loading();this.controller.saveDownloaded().then((()=>t.remove()))},this.$downloadsList.onclick=()=>{chrome.runtime.sendMessage({cmd:"OPEN_DOWNLOADS",parameter:{}})},this.$threads.forEach((t=>{t.onclick=()=>{const{options:e}=this.controller,s=parseInt(t.getAttribute("data-thread"));e.threads!==s&&(this.updateThreads(s),this.controller.saveOptions(),this.controller.singleThread=!1)}})),this.$singleThread.onclick=()=>{this.updateThreads(1),this.controller.threads=1,this.controller.singleThread=!0,this.controller.start()},this.$previewSwitch.onclick=()=>{const{options:t}=this.controller;t.preview=this.$previewSwitch.checked,this.previewToggle(t.preview),this.controller.saveOptions()},this.$autoSave.onclick=()=>{const{options:t}=this.controller;t.autoSave=this.$autoSave.checked,this.controller.saveOptions()},this.$clearCache.onclick=()=>{const{options:t}=this.controller;t.clearCache=this.$clearCache.checked,this.controller.saveOptions()},this.$tabProgress.onclick=()=>{const{options:t}=this.controller;t.tabProgress=this.$tabProgress.checked,this.controller.saveOptions(),t.tabProgress||(document.title=this.tabTitle)},this.$defaultResolution.onclick=()=>{if(this.$defaultResolution.checked){const t=this.$resolution.selectedIndex,e=this.$resolution.options[t].text,s=e?e.match(/\d+x\d+/):null;s&&(this.controller.options.defaultResolution=s[0],this.controller.saveOptions())}else this.controller.options.defaultResolution=null,this.controller.saveOptions()},this.$filenameType.forEach((t=>{t.onclick=()=>{const{options:e}=this.controller,s=t.value;e.filenameType=s;const i="title"===s?this.controller.title:this.controller.name;this.controller.filename=i,this.$filename.innerText=i,this.$filenameInput.value=i,this.controller.saveOptions()}}))}showDownloadsList(){const{userAgent:t}=navigator;/Chrome\/[\d.]+/i.test(t)||/Edge\/[\d.]+/i.test(t)||/Opera\/[\d.]+/i.test(t)||/Brave\/[\d.]+/i.test(t)?this.$downloadsList.classList.remove("d-none"):this.$downloadsList.classList.add("d-none")}updateThreads(t){this.controller.options.threads=t,this.$threads.forEach((e=>{const s=parseInt(e.getAttribute("data-thread"));t!==s?e.classList.remove("text-danger"):e.classList.add("text-danger")}))}clearCache(){if(!this.controller.options.clearCache)return;if(this.clearCacheTimer)return;this.show(this.$clearCacheStatus);let t=60;this.clearCacheTimer=setInterval((()=>{if(t<0)return this.hide(this.$clearCacheStatus),this.show(this.$clearCacheEnd),clearInterval(this.clearCacheTimer),this.clearCacheTimer=1,this.$save.disabled=!0,this.$cancel.disabled=!0,this.controller.blobURL&&(URL.revokeObjectURL(this.controller.blobURL),this.controller.blobURL=null),void(this.controller.previewURL&&(URL.revokeObjectURL(this.controller.previewURL),this.controller.previewURL=null));this.$clearCacheTimer.innerText=t,t--}),1e3)}cancel(){this.modal({title:lang("page_cancel_modal_title"),btnCancel:lang("page_cancel_modal_close"),btnConfirm:lang("page_cancel_modal_confirm"),content:lang("page_cancel_modal_content")},(()=>{this.controller.status=-1,this.controller.fail="Task canceled!",this.controller.isFail()}))}error(t){this.$cancel.disabled=!0,this.$start.disabled=!0,this.$pause.disabled=!0,this.hide(this.$save,this.$saveDownloaded,this.$clearCacheStatus,this.$clearCacheEnd),this.show(this.$errorBox),this.$error.innerText=`Error: ${t}`,this.$progress.classList.add("bg-danger"),this.$progress.classList.remove("progress-bar-striped","progress-bar-animated"),this.controller.options.tabProgress&&(document.title=`[${lang("page_failed")}] ${this.tabTitle}`),this.clearCacheTimer&&(clearInterval(this.clearCacheTimer),this.clearCacheTimer=null)}modal(t={},e=(()=>{})){"string"!=typeof t.title&&(t.title="Tip"),"string"!=typeof t.btnCancel&&(t.btnCancel="Cancel"),"string"!=typeof t.btnConfirm&&(t.btnConfirm="Confirm"),"string"!=typeof t.content&&(t.content="Content");const{title:s,btnCancel:i,btnConfirm:n,content:o}=t,r=document.createElement("div");r.className="modal fade",r.setAttribute("tabindex","-1"),r.setAttribute("data-bs-delay",'{"show":150,"hide":150}');const a=document.createElement("div");a.className="modal-dialog",r.appendChild(a);const l=document.createElement("div");l.className="modal-content",a.appendChild(l);const h=document.createElement("div");h.className="modal-header py-3",h.innerHTML=`<h3 class="modal-title fs-6">${s}</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button>`,l.appendChild(h);const c=document.createElement("div");c.className="modal-body",c.innerHTML=o,l.appendChild(c);const d=document.createElement("div");d.className="modal-footer",d.innerHTML=`<button class="btn btn-secondary" data-bs-dismiss="modal">${i}</button>`,l.appendChild(d);const u=document.createElement("button");u.className="btn btn-primary",u.innerText=n,d.appendChild(u),document.body.appendChild(r);const m=new this.bootstrap.Modal(r);m.show(),r.addEventListener("hidden.bs.modal",(t=>{u.onclick=null,m.dispose(),r.remove()})),u.onclick=()=>{e(),m.hide()}}show(...t){for(let e=0;e<t.length;e++)t[e].classList.remove("d-none")}hide(...t){for(let e=0;e<t.length;e++)t[e].classList.add("d-none")}pause(t=!1){if(this.$progress.classList.add("bg-warning"),this.$pause.disabled=!0,this.$start.disabled=!1,this.controller.size>0&&this.show(this.$saveDownloaded),t){const{requestErrorDetail:t}=this.controller;this.show(this.$errorPause),this.$requestErrorDetail.innerText=t}setTimeout((()=>{this.controller.options.tabProgress&&(document.title=`[${lang("page_paused")}] ${this.tabTitle}`)}),2e3)}start(){this.$progress.classList.remove("bg-warning","bg-success","bg-danger"),this.$progress.classList.contains("progress-bar-striped")&&this.$progress.classList.contains("progress-bar-animated")||this.$progress.classList.add("progress-bar-striped","progress-bar-animated"),this.$cancel.disabled=!1,this.$pause.disabled=!1,this.$start.disabled=!0,this.$save.disabled=!1,this.hide(this.$save,this.$errorPause,this.$clearCacheStatus,this.$clearCacheEnd),this.controller.live||this.hide(this.$saveDownloaded),this.controller.options.tabProgress&&(document.title=`[${lang("page_downloading")}] ${this.tabTitle}`),this.clearCacheTimer&&(clearInterval(this.clearCacheTimer),this.clearCacheTimer=null)}finish(){this.$recheck&&(this.$recheck.remove(),this.$recheck=null),this.$progress.classList.remove("bg-warning","progress-bar-striped","progress-bar-animated"),this.$progress.classList.add("bg-success"),this.$pause.disabled=!0,this.$start.disabled=!0,this.hide(this.$saveDownloaded),this.show(this.$save),this.$save.setAttribute("data-size",this.controller.size),this.controller.options.tabProgress&&(document.title=`[${lang("page_completed")}] ${this.tabTitle}`),this.controller.live&&(this.$progress.innerText=lang("page_completed"),this.$progress.classList.remove("fw-bold")),this.controller.usedThread&&setTimeout((()=>{this.controller.usedThread=0}),5e3)}formatSeconds(t){const e=Math.floor(t/3600),s=Math.floor(t%3600/60),i=t%60;return e.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")}setDuration(){const{controller:t}=this,{options:e,video:s}=t;if(!s)return;const i=s.getDuration();if(!i)return;const n=this.formatSeconds(i);this.$duration.innerText=n,e.tabProgress&&(document.title=`[${n}] ${this.tabTitle}`)}setProgress(){const{completion:t,total:e,status:s,live:i}=this.controller;if(i)return this.setChunks(),void this.setDuration();const n=(t/e*100).toFixed(2)+"%";this.$progress.style.width=n,this.$progress.innerText=n,this.controller.options.tabProgress&&(document.title=`[${n}] ${this.tabTitle}`),t===e&&1===s&&(this.$recheck||(this.$recheck=this.loading()),setTimeout((()=>{this.controller.recheck()}),5e3))}setBytes(){let t=this.controller.size;t<1024?t+="B":t=t<1048576?(t/1024).toFixed(0)+"K":t<1073741824?(t/1048576).toFixed(0)+"M":(t/1073741824).toFixed(2)+"G",this.$size.innerText=t}setSpeed(t){t<1024?t+="Byte/s":t<1048576?t=(t/1024).toFixed(0)+"KB/s":((t=(t/1048576).toFixed(2))>99&&(t=99),t+="MB/s"),this.$speed.innerText=t}setQuality(){const{quality:t,master:e}=this.controller;if(t)if(e)this.$quality.innerHTML=`${t} <i class="bi bi-chevron-down"></i>`,this.$quality.classList.add("cursor-pointer");else{this.$quality.innerText=t,this.$resolution.firstElementChild.remove();const e=document.createElement("option");e.value=-1,e.innerText=t,this.$resolution.appendChild(e),this.defaultResolutionSwitch(t)}}getResolution(t,e){const s=t.name?`${t.name}-`:"";return t?.attrs?.RESOLUTION?s+t.attrs.RESOLUTION:t?.width&&t?.height?s+t.width+"x"+t.height:t?.bitrate?s+`Bitrate-${t.bitrate}`:s+`Resolution-${e}`}createResolutionOptions(){const{master:t,activeLevel:e}=this.controller;if(t){const s=document.createElement("ul");s.className="dropdown-menu dropdown-menu-dark dropdown-menu-end",this.$qualityDropdown.appendChild(s);const i=new this.bootstrap.Dropdown(s,{autoClose:!0,offset:[0,26],display:"static"});s.addEventListener("show.bs.dropdown",(t=>{document.body.onclick=t=>{t.target.classList.contains("dropdown-item")||t.target===this.$quality||i.hide()}})),s.addEventListener("hide.bs.dropdown",(t=>{document.body.onclick=null})),this.$quality.onclick=()=>{i.toggle()},this.$resolution?.firstElementChild.remove();const n=t.levels,o=(t,e)=>{this.$quality.innerHTML=`${e} <i class="bi bi-chevron-down"></i>`;const i=s.querySelectorAll(".dropdown-item");i.forEach((t=>{t.classList.remove("active")})),i[t].classList.add("active")};for(let t in n){t=parseInt(t);const r=t===e,a=n[t],l=document.createElement("option");l.value=t;const h=this.getResolution(a,t);l.innerText=h,l.selected=r,this.$resolution.appendChild(l);const c=document.createElement("li");c.className="cursor-pointer";const d=document.createElement("a");d.className="dropdown-item",d.innerText=h,r&&(d.classList.add("active"),this.defaultResolutionSwitch(h)),c.appendChild(d),c.onclick=()=>{this.$resolution.selectedIndex=t;const e=new Event("change");this.$resolution.dispatchEvent(e),i.hide(),o(t,h)},s.appendChild(c)}this.$resolution.onchange=()=>{const{$resolution:t}=this,e=parseInt(t.value),s=t.options[t.selectedIndex].text,i=this.loading();this.controller.status=2,setTimeout((()=>{this.controller.switchLevel(e).then((()=>{i.remove()})),o(e,s)}),2e3),this.defaultResolutionSwitch(s)},this.$resolution.disabled=!1}else this.$defaultResolution.disabled=!0}defaultResolutionSwitch(t){let e=!1,s=!1;if(/\d+x\d+/.test(t)){const s=this.controller.options.defaultResolution;s&&t.includes(s)&&(e=!0)}else s=!0;this.$defaultResolution.checked=e,this.$defaultResolution.disabled=s}loading(){const t=document.createElement("div");return t.className="fixed-top w-100 h-100 pe-none d-flex justify-content-center align-items-center",t.innerHTML='<div class="spinner-border fs-5" style="width: 3rem; height: 3rem;" role="status"></div>',t.style.zIndex=9999,document.body.appendChild(t),t}setChunks(){this.$chunks.innerText=this.controller.total}setChunksCompleted(){this.$chunksCompleted.innerText=this.controller.completion}live(){this.$fileIconText.innerText="LIVE",this.$fileIconText.classList.remove("text-bg-purple"),this.$fileIconText.classList.add("text-bg-danger"),this.$progress.classList.add("fw-bold"),this.$progress.style.width="100%",this.$progress.innerHTML='<div class="d-flex justify-content-center align-items-center"><span class="spinner-grow spinner-grow-sm text-warning me-1" role="status"></span><span>Live Recording</span></div>',this.hide(this.$cancel,this.$start,this.$pause,this.$optionThreads,this.$speed),this.show(this.$stop,this.$saveDownloaded,this.$duration)}liveSaveModal(t){const e=this.$liveSaveModal.cloneNode(!0),s=e.querySelector('[selector="live-save-modal-btn"]'),i=new this.bootstrap.Modal(e);s.onclick=()=>{this.controller.save(t,!0),i.hide()},e.addEventListener("hidden.bs.modal",(i=>{s.onclick=null,e.remove(),URL.revokeObjectURL(t)})),i.show()}}class Controller{constructor(t){this.container=t,this.hasData=!0,this.options=this.getOptions(),this.intervalSize=0,this.interval=null,this.usedThread=0,this.requestError=0,this.requestErrorDetail=null,this.quality=null,this.status=1,this.total=0,this.completion=0,this.completions=[],this.activeLevel=0,this.master=null,this.level=null,this.size=0,this.fail=null,this.video=null,this.flushStep=0,this.flushedCount=0,this.flushLock=0,this.switchLevelLock=0,this.blobURL=null,this.previewURL=null,this.port=null,this.singleThread=!1,this.isConnect=!1,this.inprivate=!1,this.liveStop=!1,this.liveEmptyTry=0,this.liveChunksFlush=!1}connectWorker(){return new Promise((async t=>{chrome.runtime.sendMessage({cmd:"BUILD_CONNECT",parameter:{requestId:this.id}},(e=>{const{allow:s,ruleId:i}=e;if(s){const t=chrome.runtime.connect({name:"TASK_TAB"});t.onDisconnect.addListener((()=>{this.port=null})),this.port=t}this.ruleId=i,this.isConnect=!0,t()}))}))}disconnectWorker(){chrome.runtime.sendMessage({cmd:"REMOVE_TASK_TAB",parameter:{}},(t=>{this.isConnect=!1,this.port&&this.port.disconnect()}))}async load(t){t?(this.filename="title"===this.options.filenameType?t.title:t.name,this.storageKey=t.storageKey,this.id=t.requestId||null,this.url=t.url,this.contentType=t.contentType,this.type=t.type,this.title=t.title,this.name=t.name||null,this.headers=t.headers||{},this.method=t.method,this.initiator=t.initiator,this.nameConvert(),await this.loadPanel(),await this.connectWorker(),this.loadManifest()):(this.hasData=!1,this.loadPanel())}getOptions(){const t={threads:3,preview:!1,autoSave:!1,clearCache:!0,filenameType:"title",tabProgress:!0,defaultResolution:null};let e=localStorage.getItem("options");if(e)try{e=JSON.parse(e);for(let s in t)void 0!==e[s]&&(t[s]=e[s])}catch(t){localStorage.removeItem("options")}return t}saveOptions(){const{options:t}=this;localStorage.setItem("options",JSON.stringify(t))}loadPanel(){return new Promise((t=>{const e=chrome.runtime.getURL("panel/hls.html");fetch(e).then((t=>t.text())).then((e=>{e=e.replace(/@_[_a-zA-Z0-9]+/g,(function(t){return t=t.substring(2),lang(t)}));const s=document.createRange().createContextualFragment(e).firstChild;this.ui=new Panel(s,this),this.ui.init().then((()=>{const e=document.getElementById(this.container);for(;e.firstElementChild;)e.firstElementChild.remove();e.appendChild(s),t()}))}))}))}setInterval(){this.interval||(this.interval=setInterval((()=>{if(1!==this.status)return clearInterval(this.interval),this.interval=null,void this.ui.setSpeed(0);let t=0;this.intervalSize&&(t=this.intervalSize/3,t=Math.round(t)),this.ui.setSpeed(t),this.intervalSize=0}),3e3))}async getAudioTracks(t){if(!this.master)return;if(!this.master.audioTracks)return;const e=this.master.levels[t],s=e?.attrs?.AUDIO,i=this.master.audioTracks.find((e=>!!e.url&&(!(!s||e?.groupId!==s)||(e.id===t||0===e.id))));if(!i)return;const n=await this.fetch(i.url,{responseText:!0,method:this.method,headers:this.headers});if(!n.ok)return;const o=M3U8Parser.parseLevelPlaylist(n.content,i.url,0,"main",1);o?.fragments?.length&&(await this.loadInitSegment(o),await this.setLevelOption(o,i),this.audioTracks=o)}parseMaster(t,e=null){e||(e=this.url);const s=M3U8Parser.parseMasterPlaylist(t,e);return s?.levels?.length?s:null}findLevel(t,e=!1){if(e){const e=new URL(this.url);if(e.pathname.toLowerCase().endsWith(".m3u8"))for(let s in t){const i=t[s],n=new URL(i.url);if(e.pathname===n.pathname&&e.hostname===n.hostname)return parseInt(s)}}else for(let e in t){if(t[e].url===this.url)return parseInt(e)}return null}checkResolutionIsDefault(t,e){const s=this.options.defaultResolution;if(!s)return e;return this.ui.getResolution(t,e).includes(s)?e:-1}getMaster(t){return new Promise((async e=>{let s=-1,i=this.parseMaster(t),n=[],o=[];i?(n=M3U8Parser.parseMasterPlaylistMedia(t,this.url,"SUBTITLES"),o=M3U8Parser.parseMasterPlaylistMedia(t,this.url,"AUDIO",i.levels.map((t=>({id:t.attrs.AUDIO,codec:t.audioCodec}))))):await new Promise((e=>{chrome.storage.local.get([this.storageKey],(async r=>{if(0!==Object.keys(r).length){r=r[this.storageKey];for(const e in r){const a=r[e];if(a.requestId===this.id)continue;if("hls"!==a.type)continue;const{url:l,method:h,headers:c}=a,d=await this.fetch(l,{responseText:!0,method:h,headers:c});if("object"!=typeof d)continue;if(!d.ok||!d.content)continue;const u=this.parseMaster(d.content,l);if(!u)continue;n=M3U8Parser.parseMasterPlaylistMedia(d.content,this.url,"SUBTITLES"),o=M3U8Parser.parseMasterPlaylistMedia(d.content,l,"AUDIO",u.levels.map((t=>({id:t.attrs.AUDIO,codec:t.audioCodec}))));let m=this.findLevel(u.levels);if(null===m&&(m=this.findLevel(u.levels,!0)),null===m?o.length>0&&(m=this.findLevel(o),null===m&&(m=this.findLevel(o,!0))):s=this.checkResolutionIsDefault(u.levels[m],m),null!==m){i=u,this.url=l,this.headers=c,this.method=h,t=d.content;break}}e()}else e()}))})),i&&(n.length||(n=null),o.length||(o=null),i.subtitles=n,i.audioTracks=o),e({activeLevel:s,master:i})}))}loadManifest(){const t=this.ui.loading();this.fetch(this.url,{responseText:!0,method:this.method,headers:this.headers}).then((async e=>{if(!e.ok)return this.fail=e.statusText,this.status=-1,this.isFail(),void t.remove();const{master:s,activeLevel:i}=await this.getMaster(e.content);s?(this.master=s,i>-1?(this.activeLevel=i,this.ui.createResolutionOptions(),this.levelManifestParse(e.content),t.remove()):this.switchLevel(i).then((()=>{this.ui.createResolutionOptions(),t.remove()}))):(this.activeLevel=i,this.levelManifestParse(e.content),t.remove())}))}getMaxLevelId(t,e=[]){let s=null,i=0;for(let n in t){if(n=parseInt(n),e.includes(n))continue;let o=t[n].attrs.BANDWIDTH;isFinite(o)&&(o=parseInt(o),o>i&&(i=o,s=n))}return s}getDefaultResolutionLevelId(t,e=[]){let s=null;const i=this.options.defaultResolution;if(i)for(let n in t){if(n=parseInt(n),e.includes(n))continue;const o=t[n];if(this.ui.getResolution(o,n).includes(i)){s=n;break}}return s}switchLevel(t=-1){let e=!1;const{levels:s}=this.master;return t<0?e=!0:(this.status=2,this.switchLevelLock=1,this.fail=null,this.live&&(this.liveStop=!0)),new Promise((async i=>{this.isConnect||await this.connectWorker();const n=[],o=()=>{if(e&&null===(t=this.getDefaultResolutionLevelId(s,n))&&null===(t=this.getMaxLevelId(s,n)))return this.fail="No Level",this.status=-1,this.isFail(),void i();const r=s[t];this.fetch(r.url,{responseText:!0,method:this.method,headers:this.headers}).then((s=>{s.ok?(this.activeLevel=parseInt(t),this.levelManifestParse(s.content),i()):e?(n.push(t),o()):(this.fail=s.statusText,this.status=-1,this.isFail(),i())}))};o()}))}nameConvert(){const t=t=>((t=(t=(t=t.replace(/['"*`~#$%^&()=+:;,!\\\/|{}?<>\r\n\t]/g," ")).replace(/\s+/g," ")).trim()).length>255&&(t=t.substring(0,255)+"..."),t);this.title=t(this.title),this.name=t(this.name),this.filename=t(this.filename)}async setLevelOption(t,e){e?(t.audioCodec=e.audioCodec||null,t.videoCodec=e.videoCodec||null):(t.audioCodec=null,t.videoCodec=null),await this.loadInitSegment(t),t.demuxer=new videoLibs.HLSDemuxer(t.initSegment.data||[],t.audioCodec,t.videoCodec,t.totalduration);let s=0,i=-1;for(const e of t.fragments)i!==e.cc&&(i=e.cc,s=0),e._n=s,s++,e.demuxer=t.demuxer}mergeLevelFragments(){const t=[],{level:e,audioTracks:s}=this;if(s&&e&&s.fragments&&e.fragments){const i=e.fragments.length,n=s.fragments.length;if(i&&n){const o=Math.max(i,n);for(let r=0;r<o;r++)r<i&&t.push(e.fragments[r]),r<n&&t.push(s.fragments[r])}}t.length?this.fragments=t:this.fragments=e.fragments}async getLiveFragments(){if(this.liveStop)return;const{url:t}=this.level,e=await this.fetch(t,{responseText:!0,method:this.method,headers:this.headers});if(!e.ok)return void this.stop();e.content=e.content.replace(/\n#EXT-X-DISCONTINUITY/gi,"");const s=M3U8Parser.parseLevelPlaylist(e.content,t,0,"main",1);if(0===s.fragments.length)return void this.stop();const i=this.level.fragments[this.level.fragments.length-1];if(!i.programDateTime)return void this.stop();let n=0,o=i._n,r=i.cc;for(const t of s.fragments)t.programDateTime<=i.programDateTime||(t.demuxer=this.level.demuxer,this.fragments.push(t),this.level.fragments.push(t),n++,o++,r!==t.cc&&(r=t.cc,o=0),t._n=o);if(!n)return this.liveEmptyTry>3?void this.stop():(this.liveEmptyTry++,void setTimeout((()=>{this.getLiveFragments().then((()=>{this.download()}))}),5e3));this.liveEmptyTry=0,this.total=this.fragments.length,(this.fragments.length>3e3||this.size>4294967296)&&(this.liveStop=!0,this.liveChunksFlush=!0)}async levelManifestParse(t){if(this.isFail())return;for(;this.flushLock||0!==this.usedThread;)await this.sleep(2e3);this.fragments=null;let e=this.url,s=null;if(this.activeLevel>-1){if(s=this.master.levels[this.activeLevel],void 0===s)return this.status=-1,this.fail="This resolution is not available",void this.isFail();e=s.url}if(t=t.replace(/\n#EXT-X-DISCONTINUITY/gi,""),this.level=M3U8Parser.parseLevelPlaylist(t,e,0,"main",1),this.live=this.level.live,0===this.level.fragments.length)return this.status=-1,this.fail="The play list is empty",void this.isFail();await this.setLevelOption(this.level,s),await this.getAudioTracks(this.activeLevel),this.mergeLevelFragments(),this.total=this.fragments.length,this.size=0,this.flushStep=0,this.flushLock=0,this.flushedCount=0,this.completions=[],this.quality=null,this.completion=0,this.video&&(this.video.clearAllTracks(),this.video=null),this.blobURL&&(URL.revokeObjectURL(this.blobURL),this.blobURL=null),this.previewURL&&(URL.revokeObjectURL(this.previewURL),this.previewURL=null),this.ui.setChunks(),this.ui.setChunksCompleted(),this.ui.setProgress(),this.ui.setBytes(),this.live&&(this.liveStop=!1,this.ui.live()),this.start()}async loadInitSegment(t){if(t.initSegment){const{initSegment:e}=t;if(!e.relurl||!e.baseurl)return;if(e.decryptdata&&null!=e.decryptdata.uri&&null==e.decryptdata.key)return this.fail="Data encrypted",void(this.status=-1);const s=URLToolkit.buildAbsoluteURL(e.baseurl,e.relurl),i=await this.fetch(s,{responseText:!1,method:this.method,headers:this.headers});if(!i.ok)return this.fail="Get initSegment failed",void(this.status=-1);e.data=i.content}else t.initSegment={data:null}}freeThreads(){this.usedThread--,this.usedThread<0&&(this.usedThread=0)}sleep(t){return new Promise((e=>{setTimeout((()=>{e()}),t)}))}isFail(){return!(!this.fail&&-1!==this.status)&&(this.ui.error(this.fail),this.video&&this.video.clearAllTracks(),this.disconnectWorker(),!0)}stop(){this.liveStop=!0,this.flush(),this.ui.$stop.disabled=!0}async start(){this.isFail()||(this.port||await this.connectWorker(),this.tempPause=!1,this.status=1,this.switchLevelLock=0,this.requestError=0,this.interval||this.live||this.setInterval(),this.download(),this.ui.start())}async pause(){this.status=2,this.ui.pause()}async download(){if(this.isFail())return;const{threads:t}=this.options,{usedThread:e}=this;if(e>=t)return;if(this.completion===this.total)return;if(1!==this.status)return;if(this.requestError>29)return this.status=2,void this.ui.pause(!0);this.usedThread++,this.singleThread&&await this.sleep(200),this.live||this.download();const s=this.fragments;let i=0;for(const t of s){if(this.completions.includes(i)){i++;continue}if(t.lock){i++;continue}t.lock=1;const e=URLToolkit.buildAbsoluteURL(t.baseurl,t.relurl),n={responseText:!1,method:this.method,headers:this.headers},o=await this.fetch(e,n,i);if(!o.ok){this.requestError++,this.requestErrorDetail=o.statusText;if(!new URL(t.relurl,t.baseurl).search){let e=0,n=0;for(const o of s)if(n!==i){if(o.demuxer===t.demuxer){e=n;break}n++}else n++;const{relurl:o,baseurl:r}=s[e],a=new URL(o,r);a.search&&(t.relurl+=a.search)}return this.freeThreads(),t.lock=0,void this.download()}this.switchLevelLock||(this.completions.push(i),this.completion++),t.lock=0;const r=o.content.byteLength||o.content.length;return t.data=o.content,o.content=null,this.switchLevelLock||(this.size=this.size+r),this.intervalSize=this.intervalSize+r,this.ui.setProgress(),this.ui.setBytes(),this.ui.setChunksCompleted(),this.freeThreads(),void(this.completion===this.total?(this.live&&!this.liveStop&&(await this.getLiveFragments(),this.download()),this.flush()):(this.flush(),this.download()))}this.flush()}async saveDownloaded(){const t=await this.video.flush();if(!t.ok)return t.fatal?(this.status=-1,this.fail=t.message,void this.isFail()):void 0;const e=URL.createObjectURL(t.blob);this.save(e,!0)}save(t,e=!1){const s=document.createElement("a");s.setAttribute("href",t);let i=this.filename;(i.toLowerCase().endsWith(".m3u8")||i.toLowerCase().endsWith(".m3u"))&&(i=i.split("."),i.splice(-1,1),i=i.join(".")),s.setAttribute("download",`${i}.mp4`),document.body.appendChild(s),s.click(),setTimeout((()=>{e&&URL.revokeObjectURL(t),s.remove(),this.ui.showDownloadsList()}),3e3)}setQuality(){if(!this.quality){const t=this.video.getQuality();t&&(t.indexOf("x")>-1||this.completion>4)&&(this.quality=t,this.ui.setQuality())}}async setPreview(t=null){if(!this.previewURL)if(t)this.previewURL=t,this.options.preview&&this.ui.previewToggle(!0);else if(this.flushStep>4){if(this.previewURL=1,!(t=await this.videoFlush()))return void(this.previewURL=null);this.previewURL=t,this.options.preview&&this.ui.previewToggle(!0)}}recheck(){const t=this.fragments;let e=0;for(const s of t){if(void 0===s.data){const t=this.completions.indexOf(e);t>-1&&(this.completions.splice(t,1),this.completion--)}e++}this.completion<this.total&&(this.flushLock=0,this.download())}async videoFlush(){if(!this.video)return null;const t=await this.video.flush();return t.ok?URL.createObjectURL(t.blob):(this.status=-1,this.fail=t.message,this.isFail(),null)}async flushCompleted(){this.status=3,this.options.autoSave&&await new Promise((t=>{const e=setTimeout((()=>{t()}),1e3);chrome.runtime.sendMessage({cmd:"TAB_ACTIVE",parameter:{}},(()=>{clearTimeout(e),t()}))}));const t=await this.videoFlush();return!!t&&(this.blobURL=t,this.setQuality(),this.setPreview(this.blobURL),this.video.clearAllTracks(),this.video=null,this.ui.finish(),this.options.autoSave&&(this.save(this.blobURL),setTimeout((()=>{this.ui.clearCache()}),8e3)),this.disconnectWorker(),!0)}async liveFlushCompleted(){const t=await this.videoFlush();return!!t&&(this.options.autoSave?this.save(t,!0):this.ui.liveSaveModal(t),setTimeout((()=>{this.liveStop=!1,this.liveChunksFlush=!1,this.switchLevel(this.activeLevel)}),5e3),!0)}async flush(){if(!this.completions.includes(this.flushStep)||this.flushLock||this.flushedCount===this.total||this.switchLevelLock)return void(this.live&&this.liveStop&&this.flushedCount===this.total&&(this.liveChunksFlush?this.liveFlushCompleted():this.flushCompleted()));this.flushLock=1,this.video||(this.video=new videoLibs.Video(this.level));const t=this.fragments[this.flushStep];if(!t.data)return;const e=await this.video.push(t);if(!e.ok)return this.status=-1,this.fail=e.message,void this.isFail();if(this.flushStep===this.total-1){if(this.live){if(!this.liveStop)return this.flushLock=0,t.data=null,this.switchLevelLock||this.flushStep++,void(this.switchLevelLock||this.flushedCount++);if(this.liveChunksFlush)return this.liveFlushCompleted(),void(this.flushLock=0)}if(!await this.flushCompleted())return void(this.flushLock=0)}else this.switchLevelLock||this.flushStep++,this.setQuality(),this.setPreview();this.switchLevelLock||this.flushedCount++,this.flushLock=0,t.data=null,this.live||this.flush()}fetch(t,e={responseText:!1,method:"GET",headers:{}},s=null){return new Promise((i=>{try{let n=s,{responseText:o,method:r,headers:a}=e;void 0===o&&(o=!1),void 0===r&&(r="GET"),void 0===a&&(a={}),s=null===s?"":s.toString(),s=parseInt(this.ruleId.toString()+s),chrome.runtime.sendMessage({cmd:"FETCH_DATA",parameter:{url:t,headers:a,method:r,ruleId:s,inprivate:this.inprivate}},(async s=>{if(s.ok)if(s.blob)try{const t=await fetch(s.blob);URL.revokeObjectURL(s.blob),t.ok||(s.ok=t.ok,s.statusText="Fetch Blob Error"),s.content=o?await t.text():new Uint8Array(await t.arrayBuffer())}catch(i){this.inprivate=!0,URL.revokeObjectURL(s.blob),s=await this.fetch(t,e,n)}else if(s.content=new Uint8Array(s.content),o){const t=new Blob([s.content],{type:"text/plain"});s.content=await t.text()}i(s)}))}catch(t){i({ok:!1,statusText:t.name})}}))}}const controller=new Controller("container");try{chrome.storage.local.get(["queue"],(({queue:t})=>{t?("hls"!==t.type&&(t=null),chrome.storage.local.remove(["queue"])):t=null,controller.load(t)}))}catch(t){controller.load(null)}chrome.runtime.onMessage.addListener(((t,e,s)=>{const{cmd:i,parameter:n}=t;if("CONNECT_WORKER"===i)return controller.connectWorker(),s(),!0}));