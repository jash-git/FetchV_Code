document.body.setAttribute("data-version",chrome.runtime.getManifest().version);const lang=t=>chrome.i18n.getMessage(t);class Panel{constructor(t,e){this.controller=e,this.$panel=t,this.$noDate=this.selector("no-data"),this.$hasDate=this.selector("has-data"),this.$fileType=this.selector("file-type"),this.$quality=this.selector("quality"),this.$openSource=this.selector("open-source"),this.$filename=this.selector("filename"),this.$filenameInput=this.selector("filename-input"),this.$rename=this.selector("rename"),this.$renameConfirm=this.selector("rename-confirm"),this.$progress=this.selector("progress"),this.$chunksCompleted=this.selector("chunks-completed"),this.$chunks=this.selector("chunks"),this.$size=this.selector("size"),this.$total=this.selector("total"),this.$speed=this.selector("speed"),this.$cancel=this.selector("cancel"),this.$start=this.selector("start"),this.$pause=this.selector("pause"),this.$save=this.selector("save"),this.$options=this.selector("options"),this.$downloadsList=this.selector("downloads-list"),this.$collapseOption=this.selector("collapse-option"),this.$threads=this.selector("thread",!0),this.$autoSave=this.selector("auto-save"),this.$clearCache=this.selector("clear-cache"),this.$tabProgress=this.selector("tab-progress"),this.$filenameType=this.selector("filename-type",!0),this.$optionsClose=this.selector("options-close"),this.$errorPause=this.selector("error-pause"),this.$requestErrorDetail=this.selector("request-error-detail"),this.$error=this.selector("error"),this.$clearCacheStatus=this.selector("clear-cache-status"),this.$clearCacheTimer=this.selector("clear-cache-timer"),this.$clearCacheEnd=this.selector("clear-cache-end"),this.clearCacheTimer=null,this.tabTitle=document.title}selector(t,e=!1){return e?this.$panel.querySelectorAll('[selector="'+t+'"]'):this.$panel.querySelector('[selector="'+t+'"]')}init(){return new Promise((t=>{const{options:e,filename:s,hasData:i,type:r,quality:o,initiator:n}=this.controller;if(!i)return this.$noDate.classList.remove("d-none"),this.$hasDate.classList.add("d-none"),void t();this.$noDate.remove(),this.$hasDate.classList.remove("d-none"),n&&(this.$openSource.onclick=()=>{chrome.runtime.sendMessage({cmd:"OPEN_INITIATOR",parameter:{initiator:n}})},this.show(this.$openSource)),this.$fileType.innerText=r.toUpperCase(),o?this.$quality.innerText=o:this.hide(this.$quality),this.$filename.innerText=s,this.$filenameInput.value=s,this.$filenameType.forEach((t=>{t.checked=e.filenameType===t.value})),this.$total.innerText=this.bytesCovert(this.controller.contentLength),this.hide(this.$save),this.$start.disabled=!0,this.$pause.disabled=!0,this.$threads.forEach((t=>{const s=parseInt(t.getAttribute("data-thread"));e.threads===s?t.classList.add("text-danger"):t.classList.remove("text-danger")})),this.$autoSave.checked=e.autoSave,this.$clearCache.checked=e.clearCache,this.$tabProgress.checked=e.tabProgress,import("../bootstrap/js/bootstrap.bundle.min.js").then((({bootstrap:e})=>{this.$panel.querySelectorAll(".tooltip-toggle").forEach((t=>{new e.Tooltip(t,{trigger:"hover"})}));const s=new e.Collapse(this.$collapseOption,{toggle:!1});this.$options.onclick=()=>s.toggle(),this.$optionsClose.onclick=()=>s.hide(),this.bootstrap=e,this.loadEvent(),t()}))}))}loadEvent(){this.$rename.onclick=()=>{this.hide(this.$filename,this.$rename),this.show(this.$filenameInput,this.$renameConfirm)},this.$filenameInput.onblur=()=>{const t=this.$filenameInput.value.trim();t?(this.controller.filename=t,this.show(this.$filename,this.$rename),this.hide(this.$filenameInput,this.$renameConfirm),this.controller.nameConvert(),this.$filename.innerText=this.controller.filename,this.$filenameInput.value=this.controller.filename):this.$filenameInput.focus()},this.$filenameInput.onkeydown=t=>{"Enter"===t.key&&this.$filenameInput.blur()},this.$cancel.onclick=()=>this.cancel(),this.$start.onclick=()=>this.controller.start(),this.$pause.onclick=()=>this.controller.pause(),this.$save.onclick=()=>{const{blobURL:t}=this.controller;t&&(this.controller.save(t),setTimeout((()=>{this.clearCache()}),8e3))},this.$downloadsList.onclick=()=>{chrome.runtime.sendMessage({cmd:"OPEN_DOWNLOADS",parameter:{}})},this.$threads.forEach((t=>{t.onclick=()=>{const{options:e}=this.controller,s=parseInt(t.getAttribute("data-thread"));e.threads!==s&&(e.threads=s,t.classList.add("text-danger"),this.$threads.forEach((e=>{t!==e&&e.classList.remove("text-danger")})),this.controller.saveOptions())}})),this.$autoSave.onclick=()=>{const{options:t}=this.controller;t.autoSave=this.$autoSave.checked,this.controller.saveOptions()},this.$clearCache.onclick=()=>{const{options:t}=this.controller;t.clearCache=this.$clearCache.checked,this.controller.saveOptions()},this.$tabProgress.onclick=()=>{const{options:t}=this.controller;t.tabProgress=this.$tabProgress.checked,this.controller.saveOptions(),t.tabProgress||(document.title=this.tabTitle)},this.$filenameType.forEach((t=>{t.onclick=()=>{const{options:e}=this.controller,s=t.value;e.filenameType=s;const i="title"===s?this.controller.title:this.controller.name;this.controller.filename=i,this.$filename.innerText=i,this.$filenameInput.value=i,this.controller.saveOptions()}}))}showDownloadsList(){const{userAgent:t}=navigator;/Chrome\/[\d.]+/i.test(t)||/Edge\/[\d.]+/i.test(t)||/Opera\/[\d.]+/i.test(t)||/Brave\/[\d.]+/i.test(t)?this.$downloadsList.classList.remove("d-none"):this.$downloadsList.classList.add("d-none")}cancel(){this.modal({title:lang("page_cancel_modal_title"),btnCancel:lang("page_cancel_modal_close"),btnConfirm:lang("page_cancel_modal_confirm"),content:lang("page_cancel_modal_content")},(()=>{this.controller.status=-1,this.controller.fail="Task canceled!",this.controller.isFail()}))}error(t){this.$cancel.disabled=!0,this.$start.disabled=!0,this.$pause.disabled=!0,this.hide(this.$save,this.$clearCacheStatus,this.$clearCacheEnd),this.show(this.$error),this.$error.innerText=`Error: ${t}`,this.$progress.classList.add("bg-danger"),this.$progress.classList.remove("progress-bar-striped","progress-bar-animated"),this.controller.options.tabProgress&&(document.title=`[${lang("page_failed")}] ${this.tabTitle}`)}modal(t={},e=(()=>{})){"string"!=typeof t.title&&(t.title="Tip"),"string"!=typeof t.btnCancel&&(t.btnCancel="Cancel"),"string"!=typeof t.btnConfirm&&(t.btnConfirm="Confirm"),"string"!=typeof t.content&&(t.content="Content");const{title:s,btnCancel:i,btnConfirm:r,content:o}=t,n=document.createElement("div");n.className="modal fade",n.setAttribute("tabindex","-1"),n.setAttribute("data-bs-delay",'{"show":150,"hide":150}');const a=document.createElement("div");a.className="modal-dialog",n.appendChild(a);const l=document.createElement("div");l.className="modal-content",a.appendChild(l);const h=document.createElement("div");h.className="modal-header py-3",h.innerHTML=`<h3 class="modal-title fs-6">${s}</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button>`,l.appendChild(h);const c=document.createElement("div");c.className="modal-body",c.innerHTML=o,l.appendChild(c);const d=document.createElement("div");d.className="modal-footer",d.innerHTML=`<button class="btn btn-secondary" data-bs-dismiss="modal">${i}</button>`,l.appendChild(d);const u=document.createElement("button");u.className="btn btn-primary",u.innerText=r,d.appendChild(u),document.body.appendChild(n);const m=new this.bootstrap.Modal(n);m.show(),n.addEventListener("hidden.bs.modal",(t=>{u.onclick=null,m.dispose(),n.remove()})),u.onclick=()=>{e(),m.hide()}}show(...t){for(let e=0;e<t.length;e++)t[e].classList.remove("d-none")}hide(...t){for(let e=0;e<t.length;e++)t[e].classList.add("d-none")}clearCache(){if(!this.controller.options.clearCache)return;if(this.clearCacheTimer)return;this.show(this.$clearCacheStatus);let t=60;this.clearCacheTimer=setInterval((()=>{if(t<0)return this.hide(this.$clearCacheStatus),this.show(this.$clearCacheEnd),clearInterval(this.clearCacheTimer),this.clearCacheTimer=1,this.$save.disabled=!0,this.$cancel.disabled=!0,void(this.controller.blobURL&&(URL.revokeObjectURL(this.controller.blobURL),this.controller.blobURL=null));this.$clearCacheTimer.innerText=t,t--}),1e3)}pause(t=!1){if(this.$progress.classList.add("bg-warning"),this.$pause.disabled=!0,this.$start.disabled=!1,t){const{requestErrorDetail:t}=this.controller;this.show(this.$errorPause),this.$requestErrorDetail.innerText=t}setTimeout((()=>{this.controller.options.tabProgress&&(document.title=`[${lang("page_paused")}] ${this.tabTitle}`)}),2e3)}start(){this.$progress.classList.remove("bg-warning"),this.$cancel.disabled=!1,this.$pause.disabled=!1,this.$start.disabled=!0,this.hide(this.$errorPause,this.$clearCacheStatus,this.$clearCacheEnd),this.controller.options.tabProgress&&(document.title=`[${lang("page_downloading")}] ${this.tabTitle}`)}finish(){this.$progress.classList.remove("bg-warning","progress-bar-striped","progress-bar-animated"),this.$progress.classList.add("bg-success"),this.$pause.disabled=!0,this.$start.disabled=!0,this.show(this.$save),this.$save.setAttribute("data-size",this.controller.size),this.$progress.style.width="100%",this.$progress.innerText="100%",this.controller.options.tabProgress&&(document.title=`[${lang("page_completed")}] ${this.tabTitle}`)}setProgress(){const{contentLength:t,size:e}=this.controller,s=(e/t*100).toFixed(2)+"%";this.$progress.style.width=s,this.$progress.innerText=s,this.controller.options.tabProgress&&(document.title=`[${s}] ${this.tabTitle}`)}bytesCovert(t){return t<1024?t+="B":t=t<1048576?(t/1024).toFixed(0)+"K":t<1073741824?(t/1048576).toFixed(0)+"M":(t/1073741824).toFixed(2)+"G",t}setBytes(){let t=this.controller.size;this.$size.innerText=this.bytesCovert(t)}setSpeed(t){t<1024?t+="Byte/s":t<1048576?t=(t/1024).toFixed(0)+"KB/s":((t=(t/1048576).toFixed(2))>99&&(t=99),t+="MB/s"),this.$speed.innerText=t}loading(){const t=document.createElement("div");return t.className="fixed-top w-100 h-100 pe-none d-flex justify-content-center align-items-center",t.innerHTML='<div class="spinner-border fs-5" style="width: 3rem; height: 3rem;" role="status"></div>',t.style.zIndex=9999,document.body.appendChild(t),t}}class Controller{constructor(t){this.container=t,this.hasData=!0,this.options=this.getOptions(),this.intervalSize=0,this.interval=null,this.usedThread=0,this.requestError=0,this.requestErrorDetail=null,this.quality=null,this.status=1,this.total=0,this.completion=0,this.completions=[],this.range=3145728,this.size=0,this.fail=null,this.video=null,this.flushStep=0,this.flushedCount=0,this.flushLock=0,this.blobURL=null,this.port=null,this.inprivate=!1}connectWorker(){return new Promise((t=>{chrome.runtime.sendMessage({cmd:"BUILD_CONNECT",parameter:{requestId:this.id}},(e=>{const{allow:s,ruleId:i}=e;if(s){const t=chrome.runtime.connect({name:"TASK_TAB"});t.onDisconnect.addListener((()=>{this.port=null})),this.port=t}this.ruleId=i,t()}))}))}disconnectWorker(){chrome.runtime.sendMessage({cmd:"REMOVE_TASK_TAB",parameter:{url:this.url}},(t=>{this.port&&this.port.disconnect()}))}async load(t){t?(this.filename="title"===this.options.filenameType?t.title:t.name,this.id=t.requestId||null,this.url=t.url,this.initiator=t.initiator,this.contentType=t.contentType,this.contentLength=t.size,this.type=t.type,this.title=t.title,this.name=t.name||null,this.headers=t.headers||{},this.method=t.method,this.quality=t.quality||null,this.nameConvert(),this.loadPanel().then((()=>{this.loadFragments()}))):(this.hasData=!1,this.loadPanel())}getOptions(){const t={threads:3,preview:!1,autoSave:!1,clearCache:!0,filenameType:"title",tabProgress:!0,defaultResolution:null};let e=localStorage.getItem("options");if(e)try{e=JSON.parse(e);for(let s in t)void 0!==e[s]&&(t[s]=e[s])}catch(t){localStorage.removeItem("options")}return t}saveOptions(){const{options:t}=this;localStorage.setItem("options",JSON.stringify(t))}loadPanel(){return new Promise((t=>{const e=chrome.runtime.getURL("panel/mp4.html");fetch(e).then((t=>t.text())).then((e=>{e=e.replace(/@_[_a-zA-Z0-9]+/g,(function(t){return t=t.substring(2),lang(t)}));const s=document.createRange().createContextualFragment(e).firstChild;this.ui=new Panel(s,this),this.ui.init().then((()=>{const e=document.getElementById(this.container);for(;e.firstElementChild;)e.firstElementChild.remove();e.appendChild(s),t()}))}))}))}setInterval(){this.interval||(this.interval=setInterval((()=>{if(1!==this.status)return clearInterval(this.interval),this.interval=null,void this.ui.setSpeed(0);let t=0;this.intervalSize&&(t=this.intervalSize/3,t=Math.round(t)),this.ui.setSpeed(t),this.intervalSize=0}),3e3))}loadFragments(){this.fragments=[];let t=0,e=this.range-1;for(;;){if(e>=this.contentLength){this.fragments.push({start:t,end:"",lock:0,data:null});break}this.fragments.push({start:t,end:e,lock:0,data:null}),t=e+1,e+=this.range}this.total=this.fragments.length,this.connectWorker().then((()=>{this.start()}))}nameConvert(){const t=t=>((t=(t=(t=t.replace(/['"*`~#$%^&()=+:;,!\\\/|{}?<>\r\n\t]/g," ")).replace(/\s+/g," ")).trim()).length>255&&(t=t.substring(0,255)+"..."),t);this.title=t(this.title),this.name=t(this.name),this.filename=t(this.filename)}freeThreads(){this.usedThread--,this.usedThread<0&&(this.usedThread=0)}isFail(){return!(!this.fail&&-1!==this.status)&&(this.ui.error(this.fail),this.disconnectWorker(),!0)}async start(){this.isFail()||(this.port||await this.connectWorker(),this.status=1,this.requestError=0,this.interval||this.setInterval(),this.download(),this.ui.start())}async pause(){this.status=2,this.ui.pause()}finish(){if(this.usedThread=0,3===this.status)return;this.status=3;const{fragments:t}=this,e=[];for(const s of t){if(!s.data)return;e.push(s.data),s.data=null}if(0===e.length)return;const s=new Blob(e,{type:this.contentType});this.blobURL=URL.createObjectURL(s),this.ui.finish(),this.options.autoSave&&chrome.runtime.sendMessage({cmd:"TAB_ACTIVE",parameter:{}},(()=>{this.save(this.blobURL),setTimeout((()=>{this.ui.clearCache()}),8e3)})),this.disconnectWorker()}async download(){if(this.isFail())return;const{threads:t}=this.options,{usedThread:e}=this;if(e>=t)return;if(this.completion===this.total)return;if(1!==this.status)return;if(this.requestError>29)return this.status=2,void this.ui.pause(!0);this.usedThread++,this.completion>1&&this.download();const s=this.fragments;for(let t in s){if(t=parseInt(t),this.completions.includes(t))continue;const e=s[t];if(e.lock)continue;e.lock=1;const i=this.headers;i.Range="bytes="+e.start+"-"+e.end;const r={responseText:!1,method:this.method,headers:i},o=await this.fetch(this.url,r);if(!o.ok)return this.requestError++,this.requestErrorDetail=o.statusText,this.freeThreads(),e.lock=0,void this.download();this.completions.push(t),this.completion++,e.lock=0;const n=o.content.byteLength||o.content.length;return e.data=o.content,o.content=null,this.size=this.size+n,this.intervalSize=this.intervalSize+n,this.ui.setProgress(),this.ui.setBytes(),this.freeThreads(),this.size>this.contentLength&&(this.status=-1,this.fail="Size larger than expected"),void(this.completion===this.total?this.finish():this.download())}}save(t,e=!1){const s=document.createElement("a");s.setAttribute("href",t);let i=this.filename;i.toLowerCase().endsWith(`.${this.type}`)||(i=`${i}.${this.type}`),s.setAttribute("download",i),document.body.appendChild(s),s.click(),setTimeout((()=>{e&&URL.revokeObjectURL(t),s.remove(),this.ui.showDownloadsList()}),3e3)}fetch(t,e={responseText:!1,method:"GET",headers:{}}){return new Promise((s=>{try{let{responseText:i,method:r,headers:o}=e;void 0===i&&(i=!1),void 0===r&&(r="GET"),void 0===o&&(o={});const n=parseInt(this.ruleId.toString()+"0");chrome.runtime.sendMessage({cmd:"FETCH_DATA",parameter:{url:t,headers:o,method:r,ruleId:n,inprivate:this.inprivate,isMP4:!0}},(async r=>{if(r.ok)if(r.blob)try{const t=await fetch(r.blob);URL.revokeObjectURL(r.blob),t.ok||(r.ok=t.ok,r.statusText="Fetch Blob Error"),r.content=i?await t.text():new Uint8Array(await t.arrayBuffer())}catch(s){this.inprivate=!0,URL.revokeObjectURL(r.blob),r=await this.fetch(t,e)}else if(r.content=new Uint8Array(r.content),i){const t=new Blob([r.content],{type:"text/plain"});r.content=await t.text()}s(r)}))}catch(t){s({ok:!1,statusText:t.name})}}))}}const controller=new Controller("container");try{chrome.storage.local.get(["queue"],(({queue:t})=>{t?chrome.storage.local.remove(["queue"]):t=null,controller.load(t)}))}catch(t){controller.load(null)}chrome.runtime.onMessage.addListener(((t,e,s)=>{const{cmd:i,parameter:r}=t;if("CONNECT_WORKER"===i)return controller.connectWorker(),s(),!0}));