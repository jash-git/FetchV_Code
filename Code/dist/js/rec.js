const Video=(()=>{const t={ftyp:{struct:[["majorBrand","text",4],["minorVersion","int",4],["compatibleBrands",["text",4],"end"]]},moov:{container:!0},mvhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["rate","int",4],["volume","int",2],["reserved","skip",10],["matrix",["int",4],9],["preDefined","skip",24],["nextTrackID","int",4]]},mvex:{container:!0},mehd:{struct:[["version","int",1],["flags","int",3],["fragmentDuration","int",4,"or",8]]},trex:{struct:[["version","int",1],["flags","int",3],["trackID","int",4],["sampleDescriptionIndex","int",4],["sampleDuration","int",4],["sampleSize","int",4],["sampleFlags","int",4]]},trep:{struct:[["version","int",1],["flags","int",3],["trackID","int",4]]},iods:{},trak:{container:!0},tkhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["trackID","int",4],["reserved1","int",4],["duration","int",4,"or",8],["reserved2","skip",8],["layer","int",2],["alternateGroup","int",2],["volume","int",2],["reserved3","int",2],["matrix",["int",4],9],["width","int",4],["height","int",4]]},edts:{container:!0},elst:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]],"entryCount"]]},mdia:{container:!0},mdhd:{struct:[["version","int",1],["flags","int",3],["creationTime","int",4,"or",8],["modificationTime","int",4,"or",8],["timeScale","int",4],["duration","int",4,"or",8],["languageValues","int",2],["QTQuality","int",2]]},hdlr:{struct:[["version","int",1],["flags","int",3],["preDefined","int",4],["handlerType","text",4],["reserved","skip",12],["name","text",0]]},minf:{container:!0},vmhd:{},dinf:{container:!0},dref:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entrySize","int",4],["typeText","text",4],["entryVersion","int",1],["entryFlags","int",3]]},stbl:{container:!0},stsd:{},stts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleDuration","int",4]],"entryCount"]]},stss:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["syncSamples",["int",4],"entryCount"]]},stsz:{struct:[["version","int",1],["flags","int",3],["sampleSize","int",4],["sampleCount","int",4],["sampleSizes",["int",4],"sampleCount"]]},stsc:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["firstChunk","int",4],["samplesPerChunk","int",4],["sampleDescriptionIndex","int",4]],"entryCount"]]},stco:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},co64:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",8],"entryCount"]]},ctts:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["entries",[["sampleCount","int",4],["sampleOffset","int",4]],"entryCount"]]},stdp:{},sdtp:{struct:[["version","int",1],["flags","int",3],["sampleDependencies",["int",4],"end"]]},stsh:{},udta:{container:!0},mdat:{},sidx:{struct:[["version","int",1],["flags","int",3],["referenceID","int",4],["timeScale","int",4],["earliestPresentationTime","int",4,"or",8],["firstOffset","int",4,"or",8],["reserved","int",2],["referenceCount","int",2],["references",[["subsegmentSize","int",4],["subsegmentDuration","int",4],["RAPDeltaTime","int",4]],"referenceCount"]]},smhd:{struct:[["version","int",1],["flags","int",3],["balance","int",2],["reserved","int",2]]},moof:{container:!0},mfhd:{struct:[["version","int",1],["flags","int",3],["sequenceNumber","int",4]]},traf:{container:!0},tfhd:{minLength:8,struct:[["version","int",1],["flags","int",3],["trackID","int",4],["baseDataOffset","int",8,"if",1],["sampleDescriptionIndex","int",4,"if",2],["defaultSampleDuration","int",4,"if",8],["defaultSampleSize","int",4,"if",16],["defaultSampleFlags","int",4,"if",32],["emptyDuration","int",4],["iframeSwitching","int",1]]},tfma:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["segmentDuration","int",4,"or",8],["mediaTime","int",4,"or",8],["mediaRateInteger","int",2],["mediaRateFraction","int",2]]},tfdt:{struct:[["version","int",1],["flags","int",3],["baseMediaDecodeTime","int",4,"or",8]]},trun:{struct:[["version","int",1],["flags","int",3],["sampleCount","int",4],["dataOffset","int",4,"if",1],["firstSampleFlags","int",4,"if",4],["samples",[["duration","int",4,"if",256],["size","int",4,"if",512],["flags","int",4,"if",1024],["compositionTimeOffset","int",4,"if",2048]],"sampleCount"]]},mfra:{container:!0},tfra:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},mfro:{struct:[["version","int",1],["flags","int",3],["entryCount","int",4],["chunkOffsets",["int",4],"entryCount"]]},isom:{container:!0}};let e=[122,109,118,48,121,50,104,50,108,109,53,108,100,97],s=0;class i{constructor(t){if(t){if("undefined"!=typeof Buffer&&t instanceof Buffer)this.data=new Uint8Array(t);else if(t instanceof Uint8Array==!1)throw new Error("Data Error")}else this.data=new Uint8Array(0);this.data=t,this.rootBox=null,this.data?this.parse():this.root=new n("isom")}parse(){const t=new o(this.data),e=s=>{const i=t.analyze(s);if(i){const o=new n(i,s,t.getPos());if(this.root||(this.root=o),i.container){o.setData(t.copy(8),i.size);for(let t=0,s=i.children;t<s;t++)e(o)}else o.setDataAndSync(t.copy(i.size))}};e(null)}get root(){return this.rootBox}set root(t){this.rootBox=t}size(){if(!this.root)return 0;const t=e=>{let s,i=e.children.length,o=e.size();for(s=0;s<i;s++)o+=t(e.children[s]);return o};return t(this.root)}tree(t,i){if(!this.root)return(t||console.log)("no box found");const o="                                  ",r=(e,s)=>{let a=(e.offset+o).substr(0,10)+"| "+o.substr(0,2*s)+"+"+e.type+" / "+e.size()+(e.container?" ( total "+e.wholeSize+" ) ":"")+(e.id?" , ID:"+e.id:"");if((t||console.log)(a),i)for(const i in e)if(!("function"==typeof e[i]||e[i]instanceof n||n.ignore[i])){let r=e[i];if(e[i]instanceof Array){if(e[i][0]instanceof n)continue;r=JSON.stringify(e[i].slice(0,10)),e[i].length>10&&(r+=" ...")}a="          | "+o.substr(0,2*s)+"  > "+i+" : "+r,(t||console.log)(a)}for(let t=0,i=e.children.length;t<i;t++)r(e.children[t],s+1)};r(this.root,s===e?0:1)}publish(t,e){if(!this.root)throw new Error("no rootbox found");const s=this.size(),i=new o(new Uint8Array(s)),n=(e,o)=>{let r=e.children.length;e.publish(i,(e=>{t(Math.floor(100*e/s))}),(t=>{const s=t=>{t<r?n(e.children[t],(e=>{s(t+1)})):o(null)};s(0)}))};n(this.root,(t=>{e(t,i.data)}))}async publishAsync(){return new Promise(((t,e)=>{if(!this.root)return e("no rootbox found");const s=this.size(),i=new o(new Uint8Array(s)),n=(t,e)=>{let s=t.children.length;t.publish(i,null,(()=>{const i=o=>{o<s?n(t.children[o],(()=>{i(o+1)})):e()};i(0)}))};n(this.root,(()=>{t(i.data)}))}))}async clone(){const t=await this.publishAsync();return new i(t)}static get Box(){return n}}class o{constructor(t){this.ptr=0,this.data=t}read8(){return this.data[this.ptr++]}read16(){return s!==e?this.data[this.ptr++]<<16|this.data[this.ptr++]:this.data[this.ptr++]<<8|this.data[this.ptr++]}read24(){return this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read32(){return this.data[this.ptr++]<<24|this.data[this.ptr++]<<16|this.data[this.ptr++]<<8|this.data[this.ptr++]}read64(){return 4294967296*this.read32()+this.read32()}readText(t){let e="";for(let s=0;s<t;s++){const t=this.data[this.ptr++];e+=String.fromCharCode(t)}return e}readTextAsNullTermination(){const t=this.data.length;let e="";for(;this.ptr<t;){const t=this.data[this.ptr++];if(0===t)break;e+=String.fromCharCode(t)}return e}readUint8Array(t,e,s){for(let i=0;i<s;i++)t[e++]=this.data[this.ptr++]}write8(t){return this.data[this.ptr++]=255&t,this}write16(t){return this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write24(t){return this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write32(t){return this.data[this.ptr++]=t>>24&255,this.data[this.ptr++]=t>>16&255,this.data[this.ptr++]=t>>8&255,this.data[this.ptr++]=255&t,this}write64(t){return this.write32(Math.floor(t/4294967296)),this.write32(Math.floor(t%4294967296)),this}writeText(t,e){for(let s=0,i=e=e||t.length;s<i;s++)this.data[this.ptr++]=t.charCodeAt(s);return this}writeTextAsNullTermination(t){return this.writeText(t),this.data[this.ptr++]=0,this}writeUint8Array(t,e,s){if(s<512)for(let i=0;i<s;i++)this.data[this.ptr++]=t[e++];else this.data.set(t.subarray(e,e+s),this.ptr),this.ptr+=s;return this}fill(t,e){e=e||0;for(let s=0;s<t;s++)this.data[this.ptr++]=e;return this}getPos(){return this.ptr}setPos(t){return this.ptr=t,this}skip(t){return this.ptr+=t,this}ready(){return this.ptr<this.data.length}copy(t){const e=this.data.subarray(this.ptr,this.ptr+t);return this.ptr+=t,this.ptr<0?new Uint8Array(e):e}toUint8Array(){return this.data}analyze(t){let e,s,i=null,o=this.ptr;const n=t=>!!t.match(/^[a-zA-Z0-9\u00a9]{4}$/);t?(e=this.read32(),s=this.readText(4),"mdat"===s&&1===e&&(e=this.read32()<<32|this.read32())):(e=this.data.length+8,s="isom",o-=8);if(o+e<=this.data.length&&n(s)){i={size:e-(t?0:8),type:s,container:!1,children:0};let o=8;for(;o<e;){let t=this.read32();const e=this.readText(4);if("mdat"===e&&1===t&&(t=this.read32()<<32|this.read32(),this.skip(-8)),!n(e))break;if(t<8)break;this.skip(t-8),o+=t,i.children++}e===o&&(i.container=!0)}return this.ptr=o,i}}class n{constructor(e,s,i){if(!e)throw new Error("Mp4Box Error");if("string"==typeof e){if(this.property=t[e],!this.property)throw new Error(e+" type is not supported");this.boxInfo={type:e,container:this.property.container}}else{if(!e.type)throw new Error("Box info type is necessary");this.boxInfo=e,this.property=t[e.type]}this.type=this.boxInfo.type,this.container=this.boxInfo.container||this.property&&this.property.container||!1,this.setData(new Uint8Array(0),0),this.offset=null!==i&&i>0?i:0,this.id=null,this.parent=s,this.children=[],this.parent&&this.parent.appendChild(this),this.wholeSize=0}setData(t,e){this.data=t,this.buffer=new o(t),e&&(this.wholeSize=e)}setDataAndSync(t,e){this.setData(t,e),this.sync(1)}size(){return this.container?"isom"===this.type?0:8:this.wholeSize||this.data&&this.data.length}sync(t){const e=this.property&&this.property.struct||this.boxInfo.struct,s=this.property&&this.property.minLength||this.boxInfo.minLength;if(!e)return 0;if(0!==t&&1!==t&&2!==t)return 0;if(0!==t){if(this.buffer.data.length<8)return 0;this.buffer.setPos(8)}return this.recursiveProc({mode:t,struct:e,minLength:s},this,0)+8}calcLength(t,e,s){const i=typeof t;if(e=e>0?e:1,"number"==i)return t;if("string"==i){if("end"==t)return Math.floor((this.size()-this.buffer.getPos())/e);{const e=t.match(/(\w+)([\-\+\*\/\d]*)/);let s=this[e[1]]||0;const i=e[2]&&e[2][0];if(i){const t=Number(e[2].substr(1));"-"===i&&(s-=t),"+"===i&&(s+=t),"*"===i&&(s*=t),"/"===i&&(s/=t)}return s}}return 0}recursiveProc(t,e,s){const{mode:i,struct:o,minLength:n}=t;let r=0;for(let t=0,a=o.length;t<a;t++){const a=o[t][0],h=o[t][1];let l=o[t][2];const c=o[t][3],d=o[t][4];if(null===c||(this.version&&this.version>0&&"or"===c&&(l=d),!this.flags||"if"!==c||0!=(this.flags&d))){if(1===i&&!this.buffer.ready())break;if(2===i&&void 0===e[a])break;if(0===i&&n&&n<=r&&void 0===e[a])break;if("int"===h)1===l?(1===i?e[a]=this.buffer.read8():2===i&&this.buffer.write8(e[a]),r+=1):2===l?(1===i?e[a]=this.buffer.read16():2===i&&this.buffer.write16(e[a]),r+=2):3===l?(1===i?e[a]=this.buffer.read24():2===i&&this.buffer.write24(e[a]),r+=3):4===l?(1===i?e[a]=this.buffer.read32():2===i&&this.buffer.write32(e[a]),r+=4):8===l&&(1===i?e[a]=this.buffer.read64():2===i&&this.buffer.write64(e[a]),r+=8);else if("skip"===h){const t=this.calcLength(l,1);1===i?(e[a]="("+t+")bytes",this.buffer.skip(t)):2===i&&this.buffer.fill(t,0),r+=t}else if("text"===h){const t=this.calcLength(l,1);t>0?(1===i?e[a]=this.buffer.readText(t):2===i&&this.buffer.writeText(e[a],t),r+=t):(1===i?e[a]=this.buffer.readTextAsNullTermination():2===i&&this.buffer.writeTextAsNullTermination(e[a]),e[a]&&(r+=e[a].length+1))}else if(h instanceof Array&&((1===i||0===i&&void 0===e[a])&&(e[a]=[]),h.length>0)){const t=h[0]instanceof Array;let o=0;if(t)for(let t=0,e=h[0].length;t<e;t++)o+=h[0][t][2];else o=h[1];const c=0===i?e[a].length:this.calcLength(l,o);for(let o=0;o<c;o++)if(t){const t=1===i?{}:e[a][o];t&&(r+=this.recursiveProc({mode:i,struct:h,minLength:n},t,s+1),1===i&&e[a].push(t))}else r+=this.recursiveProc({mode:i,struct:[[o,h[0],h[1]]],minLength:n},e[a],s+1)}0===s&&e[a]}}return r}hasChild(t){for(let e=0,s=this.children.length;e<s;e++)if(this.children[e]===t)return e;return-1}append(t){return this.appendChild(t)}appendChild(t){if(t){if(-1===this.hasChild(t)){this.children.push(t);let e=this[t.type+"s"];e||(e=[]),e.push(t),this[t.type+"s"]=e,this[t.type]=e[0]}t.parent=this}}remove(t){return this.removeChild(t)}removeChild(t){if(t){const e=this.hasChild(t);if(-1!==e){this.children.splice(e,1);const s=this[t.type+"s"];if(s){const e=s.indexOf(t);e>=0&&s.splice(e,1),s.length>0?this[t.type]=s[0]:(delete this[t.type+"s"],delete this[t.type])}else delete this[t.type]}t.parent=null}}find(t){const e=s=>{if(s.type===t)return s;for(let t=0,i=s.children.length;t<i;t++){const i=e(s.children[t]);if(i)return i}return null};return e(this)}findAll(t){const e=(s,i)=>{s.type===t&&i.push(s);for(let t=0,o=s.children.length;t<o;t++)e(s.children[t],i);return i};return e(this,[])}arrange(){const t=e=>{const s=e.sync(0)||e.size();"mdat"!==e.type&&s!==e.data.length&&e.setData(new Uint8Array(s)),e.sync(2);let i=e.offset+s;for(let s=0,o=e.children.length;s<o;s++)e.children[s].offset=i,i+=t(e.children[s]);return e.wholeSize=i-e.offset,e.buffer.setPos(0),e.buffer.write32(e.wholeSize),e.buffer.writeText(e.type,4),e.wholeSize};return t(this)}publish(t,e,s){const i=this.sync(0);i>0&&i>this.data.length&&this.setData(new Uint8Array(i)),this.sync(2);const o=this.size();o>0&&t&&t.writeUint8Array(this.data,0,o),s(null)}publishToFile(t,e,s){const i=this.sync(0);i>0&&i>this.data.length&&this.setData(new Uint8Array(i)),this.sync(2);this.size()>0&&t?t(this.type,((t,e)=>{e||t.write(new Blob([this.data])),s(null)})):s(null)}inspect(){return"Box : '"+this.type+"' [ "+(this.container?"container":"prop")+" ] / "+this.size()}dump(){var t="";for(var e in this)"function"!=typeof this[e]&&(t+=e+":"+this[e]+" , ");return t}static create(i,o,r){const a={};if(a.type=i,a.struct=o||t[i].struct,a.struct||r instanceof Uint8Array){const t=new n(a);if(a.struct){t.setData(new Uint8Array(0));for(let i=0,o=a.struct.length;i<o;i++){if(s!==e&&1===i)continue;const o=a.struct[i][0],n=a.struct[i][1];t[o]=r&&r[o]||(n instanceof Array?[]:"text"===n?"":0)}}else t.setDataAndSync(r);return t}return null}static get ignore(){return{type:1,container:1,data:1,buffer:1,offset:1,id:1,parent:1,children:1,wholeSize:1,boxInfo:1,property:1}}}async function r(t){return new Promise(((e,s)=>{const i=new FileReader;i.onload=t=>{e(i.result)},i.onerror=t=>{s(i.error)},i.readAsArrayBuffer(t)}))}async function a(t){return new Promise(((e,s)=>{setTimeout(e,t)}))}function h(t,e,s){if(!t||!e)return{moofDuration:0,moofStart:0};s=s||0;const i=e&&e.moofs&&e.moofs[s],o=e&&e.sidx;if(o){const{timeScale:e,earliestPresentationTime:n}=o;let r;Math.abs(i.traf.tfdt.baseMediaDecodeTime/t.root.moov.trak.mdia.mdhd.timeScale-n/e),n&&e?r=n/e:i.traf.tfdt.baseMediaDecodeTime&&t.root.moov.trak.mdia.mdhd.timeScale&&(r=i.traf.tfdt.baseMediaDecodeTime/t.root.moov.trak.mdia.mdhd.timeScale);const a=o.references&&o.references[s]&&o.references[s].subsegmentDuration;if(e&&void 0!==r&&a){return{moofDuration:a/e,moofStart:r}}}if(i&&t&&t.root&&t.root.moov){const e=t.root.moov.trak.mdia.mdhd.timeScale,s=i.traf;if(s&&e){const{tfhd:i,trun:o,tfdt:n}=s;if(i&&n&&o){const r=n.baseMediaDecodeTime/e,a=i.defaultSampleDuration;if(o.samples){let i=0;for(const t of s.truns)for(const e of t.samples)i+=e.duration||a||0;if(0===i){const e=t.root.moov.mvex&&t.root.moov.mvex.trex&&t.root.moov.mvex.trex.sampleDuration||0;for(const t of s.truns)i+=(t.sampleCount||0)*e}return i/=e,{moofDuration:i,moofStart:r}}}}}return{moofDuration:0,moofStart:0}}function l(t){let e=0;for(const s of t)s.init&&s.moofs.length>0&&e++;return t.length===e}function c(t,e){try{const s=t.root.moov.trak.tkhd,i=e.root.moov.trak.tkhd,o=function(t,e){const s=t.length;if(s!==e.length)return!1;for(let i=0;i<s;i++)if(t[i]!==e[i])return!1;return!0}(s.matrix,i.matrix)&&s.width===i.width&&s.height===i.height,n=t.root.moov.trak.mdia.mdhd,r=e.root.moov.trak.mdia.mdhd,a=n.timeScale===r.timeScale&&n.languageValues===r.languageValues,h=t.root.moov.trak.mdia.hdlr,l=e.root.moov.trak.mdia.hdlr,c=h.handlerType===l.handlerType&&h.name===l.name;return o&&a&&c}catch(t){return!0}}function d(t){const e=t?.init?.root?.moov?.trak?.mdia;if(e){const t=e.mdhd?.timeScale;if(t)return t;if(e.hdlr){if("vide"===e.hdlr.handlerType)return 9e4;if("soun"===e.hdlr.handlerType)return 48e3}}return 1e3}function u(t){for(const e of t)if(e.init&&e.moofs.length>1){const t=e.moofs.length-1;e.start[t]===e.start[t-1]&&e.durations[t]===e.durations[t-1]&&(e.moofs.splice(t-1,1),e.mdats.splice(t-1,1),e.start.splice(t-1,1),e.durations.splice(t-1,1))}if(2!==t.length)return;if(t[0].start.length<1||t[1].start.length<1)return;const e=t[0],s=t[1];let i=null,o=Math.abs(e.start[0]-s.start[0]);if(e.start.length>1){const t=Math.abs(e.start[1]-s.start[0]);t<o&&(o=t,i=e)}if(s.start.length>1){const t=Math.abs(s.start[1]-e.start[0]);t<o&&(o=t,i=s)}i&&(i.moofs.splice(0,1),i.mdats.splice(0,1),i.start.splice(0,1),i.durations.splice(0,1))}function m(t){for(const e of t){const t=e.start.length-1;if(t>=2){const{moofs:s,mdats:i,start:o,durations:n}=e;if(s.length===i.length&&s.length===o.length&&s.length===n.length&&o[t-2]<o[t]&&o[t]<o[t-1]){const e=o[t-2]+n[t-2];if(Math.abs(e-o[t])<Math.abs(e-o[t-1])){(e=>{for(const s of e){const e=s[t-1];s[t-1]=s[t],s[t]=e}})([s,i,o,n])}}}}}function f(t){if(t&&t.start){const e=t.start.length;if(e>1)for(let s=t.contig;s<e-1;s++){const e=t.start[s],i=t.duration[s],o=t.start[s+1];if(Math.abs(e+i-o)>.1)return!0;t.contig=s+1}}return!1}return class{constructor(t){this.vId=Math.floor(1e8*Math.random()),this.sourceType=4,this.tracks=[],this.index={},this.size=0,this.isPreviewed=!1,this.isLive=!0,this.hasAltAudio=!1,this.controller=t,this.quality=null,function(){const t=new URL(location.href),e=btoa(t.hostname).replace(/=/g,"").toLowerCase(),i=[];for(let t=0;t<e.length;t++)i.push(e.charCodeAt(t));s=parseInt(i.join(""))}(),void 0===e?e=0:Array.isArray(e)&&(e=parseInt(e.join("")))}updateQualityLabel(){let t="",e="";for(const s of this.tracks)s?.mimetype?.includes("video")&&(t=s.quality),s?.mimetype?.includes("audio")&&(e=s.quality);this.quality=t+(""!==e&&""!==t?"-":"")+e,this.controller.ui.setQuality(this.quality)}getDuration(){const t=this.tracks;if(this.tracks.length<1)return 0;const e=[];for(const s of t)e.push(Math.round(s.duration));return e.length<1?0:Math.max(...e)}getTrackByType(t){return void 0===this.index[t]&&(this.index[t]=this.tracks.length,this.tracks.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,mimetype:t,quality:""})),this.tracks[this.index[t]]}getTrackByNumber(t){for(const e of this.tracks)if(e.init?.root?.moov?.trak?.tkhd?.trackID===t)return e;return null}clearAllTracks(){for(const t of this.tracks)this.clearTrack(t)}clearTrack(t){t.moofs=[],t.mdats=[],t.start=[],t.durations=[],t.duration=0}get qualityLabel(){let t="",e="";for(const s of this.tracks)s.init&&(s.mimetype.includes("video")&&(t=s.quality),s.mimetype.includes("audio")&&(e=s.quality));return t+(""!==t?"-":"")+e}assign(t){for(const e in t)this[e]=t[e]}flush(t=!1){const{size:h,sourceType:l}=this,c=this.isLive&&this.hasAltAudio?function(t){let e=0;for(const s of t){const t=s.start.length;t>0&&s.start[t-1]>e&&(e=s.start[t-1])}let s=e;for(const e of t){e.start.length>0&&e.start[0]<s&&(s=e.start[0])}const i=[];for(const e of t){const{mimetype:t,init:s}=e;i.push({mimetype:t,init:s,moofs:[],mdats:[],start:[]})}for(let o=s;o<=e;o++){const e=[];for(let s=0,i=t.length;s<i;s++){const i=t[s].start.indexOf(o);-1!==i&&e.push(i)}if(e.length===t.length)for(let s=0,o=t.length;s<o;s++){const o=t[s],n=e[s],r=i[s];r.moofs.push(o.moofs[n]),r.mdats.push(o.mdats[n]),r.start.push(o.start[n])}}return i}(this.tracks):function(t){const e=[];for(const s of t)if(s.init&&s.moofs.length>0){const t=s.moofs.slice(0),i=s.mdats.slice(0),o=s.start.slice(0),{mimetype:n,init:r}=s;e.push({mimetype:n,init:r,moofs:t,mdats:i,start:o})}return e}(this.tracks);return t||(this.clearAllTracks(),this.size=0,this.isPreviewed=!1),new Promise((t=>{h?function(t,h,l){return new Promise((async c=>{try{if(!l)return void c({ok:!1,fatal:!1});if(0===t.length||0===t[0].moofs.length)return void c({ok:!1,fatal:!1});const d={};d.keyFrameComplement=4===h,d.modifyESDSTrackConfig=4===h,d.over4G=l>4e9;const u=await async function(t,h){if(!t||0===t.length)throw new Error("Video is empty");let l=0;for(let z=0;z<t.length;z++)t[z].mimetype.includes("video")&&(l=z);2===t.length&&1===l&&(t=[t[1],t[0]],l=0);const{keyFrameComplement:c,modifyESDSTrackConfig:d,over4G:u}=h,m=[];for(let L=0,I=t.length;L<I;L++){const P=t[L];let O=0;for(let R=0,B=P.mdats.length;R<B;R++)void 0!==P.start[R]&&(m.push({track:L,num:R,order:O,start:P.start[R]}),O++)}m.sort(((t,e)=>t.start-e.start));for(const U of t)U.mdats[0]&&9===U.mdats[0].size&&(U.mdats=[]);const f=[],p=[];for(const E of t){let q;q=E.init&&E.init.data?E.init.data.length<2e4?new i(E.init.data.slice()):E.init:await E.init.clone(),f.push(q),p.push(q.root)}f.length;for(let N=0,_=p.length;N<_;N++){const F=p[N];F.moov.mvhd.version=F.moov.trak.tkhd.version=F.moov.trak.mdia.mdhd.version=0,F.moov.trak.tkhd.flags=3;const j=N+1;if(F.moov.trak.tkhd.trackID=F.moov.mvex.trex.trackID=j,F.ftyp&&(F.ftyp.majorBrand="mp42",F.ftyp.minorVersion=0,F.ftyp.compatibleBrands=["isom","iso2","avc1","mp41","mp42"]),d){const W=F.moov.trak.mdia.minf.stbl.stsd,V=new o(W.data);V.skip(12),s!==e&&V.skip(12);const Z=V.read32();for(let Q=0;Q<Z;Q++){const G=V.read32();if("mp4a"===V.readText(4)){V.skip(28);const J=V.getPos(),K=V.read32();if("esds"===V.readText(4)){V.skip(5);const H=V.read8();V.skip(4);const X=V.read8();V.skip(14);const Y=V.read8();if(4===Y){const tt=V.read8(),et=V.read8();V.skip(2);const st=[];for(let it=0,ot=K-38;it<ot;it++)st.push(V.read8());V.setPos(J),V.write32(K),V.skip(9),V.write8(H-2),V.skip(4),V.write8(X-2),V.skip(14),V.write8(Y-2),V.write8(16+(7&tt)),V.write8(248&et);for(const nt of st)V.write8(nt);V.write16(0)}}else V.skip(K-8)}else V.skip(G-8)}}}const g=new i,v=g.root;v.append(p[l].ftyp),v.append(new i.Box("moov")),v.moov.append(p[l].moov.mvhd);for(const rt of p)v.moov.append(rt.moov.trak);v.moov.mvhd.nextTrackID=f.length+1;const y=0;v.moov.mvhd.creationTime=v.moov.mvhd.modificationTime=y;for(let at=0,ht=f.length;at<ht;at++)v.moov.traks[at].tkhd.creationTime=v.moov.traks[at].mdia.mdhd.creationTime=v.moov.traks[at].tkhd.modificationTime=v.moov.traks[at].mdia.mdhd.modificationTime=y;const b=async(t,e)=>{const s=4294967295,o=-2147483648,a=[{type:"vide",length:0,moofs:[],hasBaseMediaDecodeTime:!1},{type:"soun",length:0,moofs:[],hasBaseMediaDecodeTime:!1}];for(const s of a)for(const i of t)i.mdia.hdlr.handlerType===s.type&&Object.assign(s,{trackID:i.tkhd.trackID,timeScale:i.mdia.mdhd.timeScale,length:e[i.tkhd.trackID-1].moofs.length});const h=Math.max(a[0].length,a[1].length);for(let t=0;t<h;t++)for(let h=0;h<2;h++){const l=a[h],c=e[l.trackID-1]?.moofs[t];if(!c){l.moofs[t]={empty:!0,baseMediaDecodeTime:0,duration:0};continue}const d=(c instanceof i?c:c instanceof n?{root:{moof:c}}:new i(new Uint8Array(await r(c)))).root.moof.traf;let u=d.tfdt.baseMediaDecodeTime<o?0:d.tfdt.baseMediaDecodeTime;u+=(4294967295&u)<0?s+1:0,u/=l.timeScale;let m=!1;if(t>0)if(l.moofs[t-1].empty)m=!0;else{const{baseMediaDecodeTime:e,duration:s}=l.moofs[t-1];(u<e||u>e+2*s)&&(m=!0)}let f=0,g=0;for(const t of d.truns){t.samples=t.samples||new Array(t.sampleCount||0).fill({});const e=t.samples||[];for(const t of e)f+=t.duration||d.tfhd?.defaultSampleDuration||p[h].moov?.mvex?.trex?.sampleDuration||0,33554432&t.flags&&g++}f/=l.timeScale;const v=(d.trun?.samples?.[0]?.compositionTimeOffset||0)/l.timeScale;l.moofs[t]={baseMediaDecodeTime:u,compositionTimeOffset:v,duration:f,keyFrames:g,discontig:m},u>0&&(l.hasBaseMediaDecodeTime=!0)}return a};function k(t){const i=[[],[]];if(t[0].length>1&&!t[0].hasBaseMediaDecodeTime||t[1].length>1&&!t[1].hasBaseMediaDecodeTime)return i;const o=[0,0],n=[0,0];t[0].elstPadding=t[1].elstPadding=0;for(let e=0,s=Math.max(t[0].length,t[1].length);e<s;e++){const s=t[0].moofs[e],r=t[1].moofs[e];if(s&&r){if(s.empty&&(s.baseMediaDecodeTime=n[0]-o[0],s.duration=0,t[0].moofs[e+1]&&!t[0].moofs[e+1].empty&&(t[0].moofs[e+1].discontig=!0)),r.empty&&(r.baseMediaDecodeTime=n[1]-o[1],r.duration=0,t[1].moofs[e+1]&&!t[1].moofs[e+1].empty&&(t[1].moofs[e+1].discontig=!0)),0===e){const e=s.baseMediaDecodeTime-r.baseMediaDecodeTime,n=e>0?0:1,a=Math.abs(e);if(a>.01){const e=t[n].moofs?.[0]?.compositionTimeOffset||0;i[n].push({segmentDuration:Math.floor(1e3*(a+e)),mediaTime:-1,mediaRateInteger:1,mediaRateFraction:0})}t[n].elstPadding=a,o[0]=o[1]=-Math.min(r.baseMediaDecodeTime,s.baseMediaDecodeTime)}else if(s.discontig&&r.discontig){const t=s.baseMediaDecodeTime-r.baseMediaDecodeTime-(n[0]-n[1]);t>=0?(o[0]=n[0]+t-s.baseMediaDecodeTime,o[1]=n[1]-r.baseMediaDecodeTime):(o[0]=n[0]-s.baseMediaDecodeTime,o[1]=n[1]-t-r.baseMediaDecodeTime)}else s.discontig?o[0]=n[0]-s.baseMediaDecodeTime:r.discontig&&(o[1]=n[1]-r.baseMediaDecodeTime);s.baseMediaDecodeTime+=o[0],r.baseMediaDecodeTime+=o[1],n[0]=s.baseMediaDecodeTime+s.duration,n[1]=r.baseMediaDecodeTime+r.duration}}for(let o=0;o<2;o++){const r=t[o],a=Math.floor(1e3*(n[o]-r.elstPadding))||123456789,h=r.moofs?.[0]?.compositionTimeOffset||0,l=Math.floor(h*r.timeScale)||0;s!==e&&0===o||i[o].push({segmentDuration:a,mediaTime:l,mediaRateInteger:1,mediaRateFraction:0})}return i}function w(t){const i=[{},{}];if(t[0].length>1&&!t[0].hasBaseMediaDecodeTime||t[1].length>1&&!t[1].hasBaseMediaDecodeTime)return i;let o=[0,0],n=!1;t[0].duration=t[1].duration=0,t[0].original_duration=t[1].original_duration=0;const r=2,a=Math.max(t[0].length,t[1].length);for(let h=0;h<a;h++){for(let n=0;n<2;n++){if(s!==e&&1===n)continue;if(t[n].moofs[h].empty)continue;const l=0;if(h<a-r-1){const e=t[n].duration-(t[n].moofs[h].baseMediaDecodeTime-t[n].elstPadding+l);e<-.05?(o[n]++,o[n]>=r&&(i[n][h+1]=Math.floor(e*t[n].timeScale),t[n].duration-=e,o[n]=0)):o[n]=0}t[n].original_duration+=t[n].moofs[h].duration,t[n].duration+=t[n].moofs[h].duration}if(h===a-r-2){const e=t[0].original_duration-t[1].original_duration;Math.abs(e)<.1&&(n=!0)}}return n?[{},{}]:i}const T=await b(v.moov.traks,t),D=k(T);let x=[{},{}];try{localStorage.nosync||(x=await w(T))}catch(lt){console.log(lt.stack||lt.message||lt)}let S=0;for(const ct of v.moov.traks){const dt=ct.mdia.minf.stbl,ut=ct.tkhd.trackID,mt=ct.mdia.hdlr.handlerType;"soun"===mt&&(ct.tkhd.alternateGroup=1,ct.tkhd.volume=256);let{stsz:ft,stts:pt,stsc:gt,stss:vt,stco:yt,ctts:bt,sdtp:kt,co64:wt}=dt;ft||dt.append(ft=i.Box.create("stsz")),pt||dt.append(pt=i.Box.create("stts")),gt||dt.append(gt=i.Box.create("stsc")),vt||dt.append(vt=i.Box.create("stss")),kt||(kt=i.Box.create("sdtp")),bt||(bt=i.Box.create("ctts")),u?(wt||dt.append(wt=i.Box.create("co64")),yt&&(dt.remove(yt),yt=null)):(yt||dt.append(yt=i.Box.create("stco")),wt&&(dt.remove(wt),wt=null)),ft.sampleSizes=[],pt.entries=[],gt.entries=[],vt.syncSamples=[],kt.sampleDependencies=[],bt.entries=[];let Tt=0,Dt=0,xt=0,St=0,$t=0,Ct=-1,Mt=0,At=0;const zt=[];let Lt=0;for(const Rt of t[ut-1].moofs){if(!Rt)continue;const Bt=Rt instanceof i?Rt:Rt instanceof n?{root:{moof:Rt}}:new i(new Uint8Array(await r(Rt))),Ut=Bt.root.moof;Bt.root.mdat&&t[ut-1].mdats.push(new Blob([Bt.root.mdat.data]));const Et=Ut.traf,qt=Et.tfhd,Nt=p[ut-1].moov.mvex&&p[ut-1].moov.mvex.trex;Dt++;let _t=0,Ft=0;At+=x[ut-1][Dt]||0;for(const jt of Et.truns){jt.samples=jt.samples||new Array(jt.sampleCount||0).fill({});for(const Wt of jt.samples){const Vt=Object.assign({},Wt);if(Tt++,Vt.duration=Vt.duration||qt&&qt.defaultSampleDuration||Nt&&Nt.sampleDuration||0,Vt.size=Vt.size||qt&&qt.defaultSampleSize||Nt&&Nt.sampleSize||0,Vt.flags=Vt.flags||qt&&qt.defaultSampleFlags||Nt&&Nt.sampleFlags||0,At=Math.floor(At),0!==At)if("vide"===mt){const Zt=At>0?Math.min(Vt.duration-1,At):At;Vt.duration-=Zt,At-=Zt}else"soun"===mt&&At<0&&Vt.duration<-At&&(_t++,$t++,Lt+=Vt.duration,ft.sampleSizes.push(0),At+=Vt.duration);c&&0===Ft&&zt.push(Tt),Ft++,(33554432&Vt.flags)>0&&("soun"===mt||vt.syncSamples.push(Tt)),ft.sampleSizes.push(Vt.size),St!==Vt.duration&&($t>0&&(pt.entries.push({sampleCount:$t,sampleDuration:St}),$t=0),St=Vt.duration),$t++,Lt+=Vt.duration,(2048&jt.flags)>0&&(Ct!==Vt.compositionTimeOffset&&Mt>0&&(bt.entries.push({sampleCount:Mt,sampleOffset:Ct}),Mt=0),Ct=Vt.compositionTimeOffset,Mt++)}_t+=jt.sampleCount,Et.sdtp&&kt.sampleDependencies.push(...Et.sdtp.sampleDependencies)}xt!==_t&&(xt=_t,gt.entries.push({firstChunk:Dt,samplesPerChunk:xt,sampleDescriptionIndex:1})),Dt%100==0&&await a(1)}function It(){const t=[];let i=0;for(const t of ft.sampleSizes)i+=t;const o=i/ft.sampleSizes.length;i=0;for(const t of ft.sampleSizes){const e=t-o;i+=e*e}const n=Math.sqrt(i/ft.sampleSizes.length);for(let e=0,s=ft.sampleSizes.length;e<s;e++){(ft.sampleSizes[e]-o)/n>3&&t.push(e+1)}return s!==e?[]:t}if(pt.entries.push({sampleCount:$t,sampleDuration:St}),-1!==Ct&&bt.entries.push({sampleCount:Mt,sampleOffset:Ct}),"vide"===mt&&vt.syncSamples.length<1+Math.floor(.8*Dt)){const Qt=It();Qt.length>vt.syncSamples.length?vt.syncSamples=Qt:c&&zt.length>vt.syncSamples.length&&(vt.syncSamples=zt),0===vt.syncSamples.length&&(vt.syncSamples=[1])}ft.sampleCount=ft.sampleSizes.length,pt.entryCount=pt.entries.length,gt.entryCount=gt.entries.length,vt.entryCount=vt.syncSamples.length,u?(wt.entryCount=Dt,wt.chunkOffsets=new Array(Dt)):(yt.entryCount=Dt,yt.chunkOffsets=new Array(Dt)),bt.entries.length&&(bt.entryCount=bt.entries.length,"soun"!==mt&&dt.append(bt)),ct.mdia.mdhd.duration=Lt,ct.tkhd.duration=Math.floor(Lt/ct.mdia.mdhd.timeScale*1e3),ct.edts||ct.append(new i.Box("edts")),ct.edts.elst||ct.edts.append(i.Box.create("elst"));const Pt=bt.entryCount>0?bt.entries[0].sampleOffset:0,Ot=D[ut-1]||[];Ot.length>0?(ct.edts.elst.entryCount=Ot.length,ct.edts.elst.entries=Ot):(ct.edts.elst.entryCount=1,ct.edts.elst.entries=[{segmentDuration:ct.tkhd.duration,mediaTime:Pt,mediaRateInteger:1,mediaRateFraction:0}]),kt.sampleDependencies.length&&dt.append(kt),ct.mdia.mdhd.duration=Lt,S=Math.max(Lt/ct.mdia.mdhd.timeScale,S)}const $=1e3,C=Math.floor(S*$);v.moov.mvhd.timeScale=$,v.moov.mvhd.duration=C,v.arrange();let M=g.size();for(const Gt of m)u?v.moov.traks[Gt.track].mdia.minf.stbl.co64.chunkOffsets[Gt.order]=M+8:v.moov.traks[Gt.track].mdia.minf.stbl.stco.chunkOffsets[Gt.order]=M+8,M+=t[Gt.track].mdats[Gt.num].size;const A=[new Blob([await g.publishAsync()])];for(const Jt of m)A.push(t[Jt.track].mdats[Jt.num]);return new Blob(A,{type:"appplication/octet-stream"})}(t,d);c({ok:!0,blob:u})}catch(t){c({ok:!1,fatal:!0})}}))}(c,l,h).then((e=>{const{ok:s,fatal:i,blob:o}=e;t(s?{ok:!0,blob:o}:{ok:s,fatal:i,statusText:"Flush error"})})):t({ok:!1,fatal:!1,statusText:"No data"})}))}async feed(t,o,n){const{tracks:r,index:a}=this,p=function(t){const e=t.root;if(e.moov){const t=e.moov.traks.length;if(t>1&&e.moov.mvex.trexs.length===t){const s=[];for(let o=0;o<t;o++){const t=new i,n=t.root;e.ftyp&&n.append(e.ftyp),n.append(new i.Box("moov")),n.moov.append(e.moov.mvhd),n.moov.append(new i.Box("mvex")),n.moov.mvex.append(e.moov.mvex.trexs[o]),n.moov.append(e.moov.traks[o]),n.arrange(),s.push(t)}return s}}else if(e.moof){const s=t.data,o=e.moof.trafs.length;if(o>1){const t=[];for(let n=0;n<o;n++){const o=new i,r=o.root;e.styp&&r.append(e.styp),e.sidx&&r.append(e.sidx),r.append(new i.Box("moof")),r.moof.append(e.moof.mfhd),r.moof.append(e.moof.trafs[n]),r.arrange(),r.publish(null,null,(()=>{})),t.push(o);const a=[];let h=0;for(const t of e.moof.trafs[n].truns){let i=e.moof.offset+t.dataOffset,o=0;for(const e of t.samples)o+=e.size;a.push(s.slice(i,i+o)),h+=o}const l=new Uint8Array(8);h+=8,l.set([h>>24&255,h>>16&255,h>>8&255,255&h,109,100,97,116]),o.mdat=new Blob([l,...a]),o.isDivided=!0}return t}}return[t]}(new i(new Uint8Array(t)));let g=0;for(const i of p){const v=o+(1===p.length?"":p.indexOf(i)%2),y=i.root.moovs,b=i.root.moofs,k=i.root.mdats||i.mdat;void 0===a[v]&&(a[v]=r.length,r.push({init:null,moofs:[],mdats:[],start:[],durations:[],duration:0,contig:0,mimetype:n,quality:""}));const w=r[a[v]],T=t=>{t=t||0;const{moofDuration:o,moofStart:n}=h(w.init,i.root,t),r=i.root.moofs[t],a=n+Math.min(1e4,r.mfhd?.sequenceNumber||0)/1e8;if(w._prev={sequenceNumber:a,moofStart:n,moofDuration:o},s!==e){return{moof:r,sequenceNumber:a,_moofStart:n+1e3,moofDuration:o}}return{moof:r,sequenceNumber:a,moofStart:n,moofDuration:o}};if(y){w.init&&l(r)&&!c(w.init,i)&&this.controller.onChunks(),w.init=i;const t=w.init.root.moov.trak;t&&(t.tkhd.width?(w.quality=Math.floor(t.tkhd.width/65536+.4)+"x"+Math.floor(t.tkhd.height/65536+.4),w.mimetype="video"):(w.quality=t.mdia.mdhd.timeScale+" Hz",w.mimetype="audio")),this.updateQualityLabel()}if(b){if(i.root.moofs[0]&&i.root.moofs[0].traf&&i.root.moofs[0].traf.senc)return this.controller.error=1,void(this.controller.fail="Data stream is encrypted");d(w);if(i.isDivided){const{moof:t,sequenceNumber:e,moofStart:s,moofDuration:o}=T();w.moofs.push(i),w.start.push(e),w.durations.push(o),w.duration+=o}else for(let e=0,s=i.root.moofs.length;e<s;e++){const{moof:s,sequenceNumber:i,moofStart:o,moofDuration:n}=T(e),r=s.offset,a=r+s.wholeSize;-1===w.start.indexOf(i)&&(w.moofs.push(new Blob([t.slice(r,a)])),w.start.push(i),w.durations.push(n),w.duration+=n)}const e=w.moofs.length;0===a[v]&&e>=5e3&&e%1e3==0&&this.controller.onChunks()}if(k)if(i.isDivided)w.mdats.push(i.mdat),g+=i.mdat.size;else if(b&&i.root.moofs.length===i.root.mdats.length)for(let t=0,e=i.root.mdats.length;t<e;t++){const{moof:e,sequenceNumber:s,moofStart:o,moofDuration:n}=T(t),r=w.start.indexOf(s);-1===r||w.mdats[r]||(w.mdats[r]=new Blob([i.root.mdats[t].data]),g+=i.root.mdats[t].data.byteLength)}else for(const t of i.root.mdats)w.mdats.push(new Blob([t.data])),g+=t.data.byteLength;this.size=this.size+g,this.controller.ui.setSize(this.size),this.controller.ui.setDuration(this.getDuration()),this.isPreviewed||this.size>=2097152&&(this.isPreviewed=!0,this.flush(!0).then((t=>{const{ok:e,fatal:s,blob:i,statusText:o}=t;e?(this.controller.previewURL=URL.createObjectURL(i),this.controller.ui.setPreview()):s?(this.status=-1,this.fail=o):this.isPreviewed=!1}))),u(r),m(r),f(w)&&this.controller.onChunks()}}}})();document.body.setAttribute("data-version",chrome.runtime.getManifest().version);const lang=t=>chrome.i18n.getMessage(t);class Panel{constructor(t,e){this.controller=e,this.$panel=t,this.$noDate=this.selector("no-data"),this.$hasDate=this.selector("has-data"),this.$iconCompleted=this.selector("icon-completed"),this.$iconError=this.selector("icon-error"),this.$iconRecording=this.selector("icon-recording"),this.$quality=this.selector("quality"),this.$size=this.selector("size"),this.$duration=this.selector("duration"),this.$preview=this.selector("preview"),this.$previewVideo=this.selector("preview-video"),this.$tipError=this.selector("tip-error"),this.$tipCompleted=this.selector("tip-completed"),this.$tipWaiting=this.selector("tip-waiting"),this.$openSource=this.selector("open-source"),this.$filename=this.selector("filename"),this.$filenameInput=this.selector("filename-input"),this.$rename=this.selector("rename"),this.$renameConfirm=this.selector("rename-confirm"),this.$stop=this.selector("stop"),this.$save=this.selector("save"),this.$options=this.selector("options"),this.$saveAll=this.selector("save-all"),this.$downloadsList=this.selector("downloads-list"),this.$collapseOption=this.selector("collapse-option"),this.$autoSave=this.selector("auto-save"),this.$tabProgress=this.selector("tab-progress"),this.$previewSwitch=this.selector("preview-switch"),this.$optionsClose=this.selector("options-close"),this.$chunksWrap=this.selector("chunks-wrap"),this.$chunksList=this.selector("chunks-list"),this.$chunk=this.selector("chunk").cloneNode(!0),this.selector("chunk").remove(),this.tabTitle=document.title,this.saveDisabled=!0,this.saveAllDisabled=!0}previewToggle(t=!1){if(t){const{previewURL:t}=this.controller;t&&(this.$previewVideo.src!==t&&(this.$previewVideo.src=t),this.show(this.$preview))}else this.hide(this.$preview)}selector(t,e=!1){return e?this.$panel.querySelectorAll('[selector="'+t+'"]'):this.$panel.querySelector('[selector="'+t+'"]')}init(){return new Promise((t=>{const{options:e,filename:s,hasData:i,initiator:o}=this.controller;if(!i)return this.$noDate.classList.remove("d-none"),this.$hasDate.classList.add("d-none"),void t();this.$noDate.remove(),this.$hasDate.classList.remove("d-none"),this.$iconRecording.src=chrome.runtime.getURL("img/recording.svg"),this.hide(this.$iconCompleted,this.$iconError,this.$tipCompleted,this.$tipError,this.$saveAll,this.$chunksWrap),o&&(this.$openSource.onclick=()=>{chrome.runtime.sendMessage({cmd:"OPEN_INITIATOR",parameter:{initiator:o}})},this.show(this.$openSource)),this.$save.disabled=!0,this.$stop.disabled=!0,this.$filename.innerText=s,this.$filenameInput.value=s,this.$autoSave.checked=e.autoSave,this.$tabProgress.checked=e.tabProgress,this.$previewSwitch.checked=e.preview,import("../bootstrap/js/bootstrap.bundle.min.js").then((({bootstrap:e})=>{this.$panel.querySelectorAll(".tooltip-toggle").forEach((t=>{new e.Tooltip(t,{trigger:"hover"})}));const s=new e.Collapse(this.$collapseOption,{toggle:!1});this.$options.onclick=()=>s.toggle(),this.$optionsClose.onclick=()=>s.hide(),this.bootstrap=e,this.loadEvent(),t()}))}))}durationConvert(t){if(!t)return"00:00:00";if(!(t=Number(t)))return"00:00:00";if((t=Math.round(t))<60)return t<10?"00:00:0"+t.toString():"00:00:"+t.toString();if(t<3600){let e=t%60;e=e<10?"0"+e.toString():e.toString();let s=Math.trunc(t/60);return s=s<10?"0"+s.toString():s.toString(),"00:"+s+":"+e}if(t<86400){let e=t%60;e=Math.round(e),e=e<10?"0"+e.toString():e.toString();let s=t%3600;s=Math.trunc(s/60),s=s<10?"0"+s.toString():s.toString();let i=Math.trunc(t/3600);return i=i<10?"0"+i.toString():i.toString(),i+":"+s+":"+e}return"--"}sizeConvert(t){return t<1024?t+="B":t=t<1048576?(t/1024).toFixed(2)+"K":t<1073741824?(t/1048576).toFixed(2)+"M":(t/1073741824).toFixed(2)+"G",t}newChunk(t,e,s,i){const{chunks:o}=this.controller,n=this.$chunk.cloneNode(!0),r=t=>n.querySelector('[selector="'+t+'"]'),a=r("chunk-video"),h=r("chunk-duration"),l=r("chunk-size"),c=r("chunk-quality"),d=r("chunk-name"),u=r("chunk-save"),m=r("chunk-remove");a.src=t,h.innerText=this.durationConvert(e),c.innerText=s,l.innerText=this.sizeConvert(i);const f=o.indexOf(t)+1;d.innerText=`Chunk-${f}`,u.onclick=()=>{const e=o.indexOf(t)+1;this.controller.save(t,`${this.controller.filename}_chunk_${e}.mp4`)},m.onclick=()=>{u.onclick=null;const e=this.controller.chunks.indexOf(t);o.splice(e,1),n.remove();this.$chunksList.querySelectorAll('[selector="chunk"]').forEach((t=>{const e=t.querySelector('[selector="chunk-video"]'),s=t.querySelector('[selector="chunk-name"]'),i=o.indexOf(e.src)+1;s.innerText=`Chunk-${i}`})),this.saveAllBtnToggle()},this.$chunksList.appendChild(n),this.show(this.$chunksWrap),this.saveAllBtnToggle()}loadEvent(){this.$rename.onclick=()=>{this.hide(this.$filename,this.$rename),this.show(this.$filenameInput,this.$renameConfirm)},this.$filenameInput.onblur=()=>{const t=this.$filenameInput.value.trim();t?(this.controller.filename=this.controller.nameConvert(t),this.show(this.$filename,this.$rename),this.hide(this.$filenameInput,this.$renameConfirm),this.$filename.innerText=this.controller.filename,this.$filenameInput.value=this.controller.filename):this.$filenameInput.focus()},this.$filenameInput.onkeydown=t=>{"Enter"===t.key&&this.$filenameInput.blur()},this.$stop.onclick=()=>this.controller.stop(),this.$save.onclick=()=>this.controller.saveCurrent(),this.$saveAll.onclick=()=>this.controller.saveAll(),this.$downloadsList.onclick=()=>{chrome.runtime.sendMessage({cmd:"OPEN_DOWNLOADS",parameter:{}})},this.$previewSwitch.onclick=()=>{const{options:t}=this.controller;t.preview=this.$previewSwitch.checked,this.previewToggle(t.preview),this.controller.saveOptions()},this.$autoSave.onclick=()=>{const{options:t}=this.controller;t.autoSave=this.$autoSave.checked,this.controller.saveOptions()},this.$tabProgress.onclick=()=>{const{options:t}=this.controller;t.tabProgress=this.$tabProgress.checked,this.controller.saveOptions(),t.tabProgress||(document.title=this.tabTitle)}}showDownloadsList(){const{userAgent:t}=navigator;/Chrome\/[\d.]+/i.test(t)||/Edge\/[\d.]+/i.test(t)||/Opera\/[\d.]+/i.test(t)||/Brave\/[\d.]+/i.test(t)?this.$downloadsList.classList.remove("d-none"):this.$downloadsList.classList.add("d-none")}error(t){this.$stop.disabled=!0,this.$save.disabled=!0,this.saveDisabled=!0,this.$tipError.innerText=`Error: ${t}`,this.show(this.$tipError,this.$iconError),this.hide(this.$iconRecording),this.controller.options.tabProgress&&(document.title=`[${lang("page_failed")}] ${this.tabTitle}`)}toast(t,e=3e3,s=!1){const i=document.createElement("div");i.style.zIndex=99999,i.className="w-100 h-100 fixed-top d-flex justify-content-center align-items-start pt-5 pe-none";const o=document.createElement("div");o.className="toast align-items-center border-0 text-white pe-auto";const n=document.createElement("div");n.className="d-flex";const r=document.createElement("div");r.className="toast-body",r.innerText=t;const a=document.createElement("button");if(a.className="btn-close btn-close-white me-2 m-auto",s){const t=document.createElement("span");t.className="text-danger-emphasis",n.appendChild(t),o.classList.add("bg-danger")}else o.classList.add("bg-success");i.appendChild(o),o.appendChild(n),n.appendChild(r),n.appendChild(a),document.body.appendChild(i);const h=new this.bootstrap.Toast(o);h.show(),o.addEventListener("hidden.bs.toast",(()=>{a.onclick=null,h.dispose(),i.remove()})),a.onclick=()=>h.hide(),setTimeout((()=>{h.hide()}),e)}show(...t){for(let e=0;e<t.length;e++)t[e].classList.remove("d-none")}hide(...t){for(let e=0;e<t.length;e++)t[e].classList.add("d-none")}setQuality(t){this.$quality.innerText=t}setSize(t){this.$size.innerText=this.sizeConvert(t)}setDuration(t){t=this.durationConvert(t),this.$duration.innerText=t,controller.options.tabProgress&&(document.title=`[${t}] ${this.tabTitle}`)}setPreview(){const{previewURL:t,options:e}=this.controller;t&&e.preview&&this.previewToggle(!0)}stop(){this.hide(this.$iconRecording),this.show(this.$iconCompleted,this.$tipCompleted),this.$stop.disabled=!0,this.controller.options.tabProgress&&(document.title=`[${lang("page_completed")}] ${this.tabTitle}`)}start(){this.show(this.$tipWaiting),this.$stop.disabled=!1,this.controller.options.tabProgress&&(document.title=`[${lang("page_waiting")}] ${this.tabTitle}`)}saveBtnToggle(){const{video:t}=this.controller;if(!t)return this.$save.disabled=!0,void(this.saveDisabled=!0);t.size>0?this.saveDisabled&&(this.$save.disabled=!1,this.saveDisabled=!1,this.hide(this.$tipWaiting)):this.saveDisabled||(this.$save.disabled=!0,this.saveDisabled=!0)}saveAllBtnToggle(){const{chunks:t}=this.controller;t.length>0?this.saveAllDisabled&&(this.show(this.$saveAll),this.saveAllDisabled=!1):this.saveAllDisabled||(this.hide(this.$saveAll),this.saveAllDisabled=!0)}loading(){const t=document.createElement("div");return t.className="fixed-top w-100 h-100 pe-none d-flex justify-content-center align-items-center",t.innerHTML='<div class="spinner-border fs-5" style="width: 3rem; height: 3rem;" role="status"></div>',t.style.zIndex=9999,document.body.appendChild(t),t}}class Controller{constructor(t){this.container=t,this.hasData=!0,this.options=this.getOptions(),this.status=1,this.fail=null,this.chunks=[],this.size=0,this.quality=null,this.video=null,this.previewURL=null,this.blobURL=null,this.port=null}connectWorker(){return new Promise((t=>{chrome.runtime.sendMessage({cmd:"BUILD_CONNECT",parameter:{requestId:null}},(e=>{const{allow:s}=e;if(s){const t=chrome.runtime.connect({name:"TASK_TAB"});t.onDisconnect.addListener((()=>{this.port=null})),this.port=t}t()}))}))}disconnectWorker(){chrome.runtime.sendMessage({cmd:"REMOVE_TASK_TAB",parameter:{}},(t=>{this.port&&this.port.disconnect()}))}async load(t){t?(this.filename=this.nameConvert(t.title),this.tabId=t.tab,this.initiator=t.initiator,this.loadPanel().then((()=>{this.start()}))):(this.hasData=!1,this.loadPanel())}nameConvert(t){return(t=(t=(t=t.replace(/['"*`~#$%^&()=+:;,!\\\/|{}?<>\r\n\t]/g," ")).replace(/\s+/g," ")).trim()).length>255&&(t=t.substring(0,255)+"..."),t}getOptions(){const t={threads:3,preview:!1,autoSave:!1,clearCache:!0,filenameType:"title",tabProgress:!0,defaultResolution:null};let e=localStorage.getItem("options");if(e)try{e=JSON.parse(e);for(let s in t)void 0!==e[s]&&(t[s]=e[s])}catch(t){localStorage.removeItem("options")}return t}saveOptions(){const{options:t}=this;localStorage.setItem("options",JSON.stringify(t))}loadPanel(){return new Promise((t=>{const e=chrome.runtime.getURL("panel/rec.html");fetch(e).then((t=>t.text())).then((e=>{e=e.replace(/@_[_a-zA-Z0-9]+/g,(function(t){return t=t.substring(2),lang(t)}));const s=document.createRange().createContextualFragment(e).firstChild;this.ui=new Panel(s,this),this.ui.init().then((()=>{const e=document.getElementById(this.container);for(;e.firstElementChild;)e.firstElementChild.remove();e.appendChild(s),t()}))}))}))}isFail(){return!(!this.fail&&-1!==this.status)&&(this.ui.error(this.fail),this.disconnectWorker(),!0)}start(){this.ui.start(),this.connectWorker().then((()=>{chrome.runtime.sendMessage({cmd:"REC_START",parameter:{tab:this.tabId}})}))}stop(t=!0){2!==this.status&&(this.status=2,t&&chrome.runtime.sendMessage({cmd:"REC_STOP",parameter:{tab:this.tabId}}),this.video&&this.video.flush().then((t=>{const{ok:e,fatal:s,blob:i,statusText:o}=t;e?(this.blobURL=URL.createObjectURL(i),this.ui.stop(),this.options.autoSave&&this.saveCurrent()):(this.status=-1,this.fail=o,this.isFail())})),this.disconnectWorker())}getJsZIP(){return new Promise((t=>{this.jsZIP?t(this.jsZIP):import("../libs/jsZIP.js").then((({jsZIP:e})=>{this.jsZIP=e,t(e)}))}))}saveCurrent(){if(1!==this.status)2===this.status&&this.save(this.blobURL,`${this.filename}.mp4`);else{if(!this.video)return void this.ui.toast("视频不存在",3e3,!0);const t=this.ui.loading();this.video.flush(!0).then((e=>{const{ok:s,fatal:i,blob:o,statusText:n}=e;if(s){const t=URL.createObjectURL(o),e=`${this.filename}.mp4`;this.save(t,e,!0)}else i?(this.status=-1,this.fail=n,this.isFail()):this.ui.toast("视频不存在",3e3,!0);t.remove()}))}}async saveAll(){const t=this.chunks.length;if(0===t)return void this.saveCurrent();const e=this.ui.loading(),s=new(await this.getJsZIP());let i=0;if(await new Promise((t=>{if(1===this.status)return this.video?void this.video.flush(!0).then((e=>{const{ok:o,fatal:n,blob:r,statusText:a}=e;o?(s.file(`${this.filename}.mp4`,r,{blob:!0}),i++,t()):t()})):void t();2!==this.status?t():fetch(this.blobURL).then((e=>{if(e.ok)return e.blob();t()})).then((e=>{s.file(`${this.filename}.mp4`,e,{blob:!0}),i++,t()}))})),0===i&&1===t)return this.save(this.chunks[0],`${this.filename}_chunk_1.mp4`),void e.remove();for(let t in this.chunks){const e=this.chunks[t],o=await fetch(e);if(!o.ok)continue;const n=await o.blob(),r=parseInt(t)+1;s.file(`${this.filename}_chunk_${r}.mp4`,n,{blob:!0}),i++}if(0===i)return this.ui.toast(lang("page_video_not_exist"),3e3,!0),void e.remove();s.generateAsync({type:"blob"}).then((t=>{const s=URL.createObjectURL(t),i=`${this.filename}.zip`;this.save(s,i,!0),e.remove()}))}save(t,e,s=!1){const i=document.createElement("a");i.setAttribute("href",t),i.setAttribute("download",e),document.body.appendChild(i),i.click(),setTimeout((()=>{s&&URL.revokeObjectURL(t),i.remove(),this.ui.showDownloadsList()}),3e3)}async push(t){const e=t.mimetype,s=t.mediasourceid,i=t.bufferid,o=t.url;if(this.video||(this.video=new Video(this),this.mediaSourceId=s),2===this.status||this.isFail())return void(o.startsWith("blob")&&URL.revokeObjectURL(o));if(!o)return void this.stop();this.mediaSourceId!==s&&(this.mediaSourceId=s,this.onChunks());const n=await this.fetch(o);URL.revokeObjectURL(o),n.ok&&(this.video.feed(n.content,i,e),this.ui.saveBtnToggle())}createChunk(t,e,s,i){const o=URL.createObjectURL(t);this.chunks.push(o),this.ui.newChunk(o,e,s,i)}onChunks(){if(this.video){const t=this.video.getDuration(),{quality:e,size:s}=this.video;this.video.flush().then((i=>{const{ok:o,fatal:n,blob:r,statusText:a}=i;o?(this.previewURL&&URL.revokeObjectURL(this.previewURL),this.createChunk(r,t,e,s)):n&&(this.status=-1,this.fail=a)}))}}fetch(t){return new Promise((e=>{fetch(t).then((function(t){if(t.ok)return t.arrayBuffer();e({ok:!1,statusText:"Fetch blob error"})})).then((function(t){e({ok:!0,content:t})})).catch((function(t){e({ok:!1,statusText:t.message})}))}))}}const controller=new Controller("container");try{chrome.storage.local.get(["queue"],(({queue:t})=>{t?chrome.storage.local.remove(["queue"]):t=null,controller.load(t)}))}catch(t){controller.load(null)}chrome.runtime.onMessage.addListener(((t,e,s)=>{const{cmd:i,parameter:o}=t;return"REC_ON_DATA"===i?(controller.push(o),s(),!0):"CONNECT_WORKER"===i?(controller.connectWorker(),s(),!0):"REC_STOP"===i?(controller.stop(!1),s(),!0):void 0}));