void 0===window.Hls&&(window.Hls={},window.Hls.isSupported=()=>!1);class e{constructor(){this.disableDetailUrl="/blog/not-support-youtube",this.tab=null,this.options=OPTION,this.langDir="",this.disable=!1,this.bootstrap=null,this.ruleId=1,this.items=[],this.storageKey=null,this.langRender(),this.$item=this.selector("item").cloneNode(!0),this.selector("item").remove(),this.$loading=this.selector("loading"),this.$empty=this.selector("empty"),this.$disable=this.selector("disable"),this.$container=this.selector("container"),this.$list=this.selector("list"),this.$optionsBtn=this.selector("optionsBtn"),this.$options=this.selector("options"),this.$record=this.selector("record",!0),this.$home=this.selector("home"),this.$disableDetail=this.selector("disableDetail")}itemToggle(e,t){const{max:s,min:i}=this.options.size;let o=!0;o=0!==i&&0!==s?t<i||t>s:(0!==i||0!==s)&&(0===i?t>s:t<i),o?e.classList.add("d-none"):e.classList.remove("d-none")}optionRender(){this.$options.classList.add("offcanvas"),this.$options.classList.remove("d-none");const e=new this.bootstrap.Offcanvas(this.$options);this.$optionsBtn.onclick=()=>{e.toggle()},document.querySelectorAll(".tooltip-toggle").forEach((e=>{new this.bootstrap.Tooltip(e)}));const{$options:t,options:s}=this,i=this.selector("sizeMin",!1,t),o=this.selector("sizeMax",!1,t),n=this.selector("noAddDomainTip",!1,t),a=this.selector("noRecordTip",!1,t);i.value=s.size.min/1024,o.value=s.size.max/1024,n.checked=!s.noAddDomainTip,a.checked=!s.noRecordTip;for(const e of s.domain)this.createOptionDomain(e);i.onblur=()=>{let e=i.value||0;e?e=parseInt(e):i.value=0,e*=1024,e!=this.options.size.min&&(this.options.size.min=e,this.saveOptions().then((()=>{for(const e of this.items)"hls"!==e.detail.type&&this.itemToggle(e.$item,e.detail.size);this.toast(this.lang("popup_option_setup_success"))})))},o.onblur=()=>{let e=o.value||0;e?e=parseInt(e):o.value=0,e*=1024,e!=this.options.size.max&&(this.options.size.max=e,this.saveOptions().then((()=>{for(const e of this.items)"hls"!==e.detail.type&&this.itemToggle(e.$item,e.detail.size);this.toast(this.lang("popup_option_setup_success"))})))},n.onclick=()=>{this.options.noAddDomainTip=!n.checked,this.saveOptions().then((()=>this.toast(this.lang("popup_option_setup_success"))))},a.onclick=()=>{this.options.noRecordTip=!a.checked,this.saveOptions().then((()=>this.toast(this.lang("popup_option_setup_success"))))}}createOptionDomain(e){const t=this.selector("domain",!1,this.$options),s=this.selector("noDomain",!1,this.$options);s.classList.contains("d-none")||s.classList.add("d-none");const i=document.createElement("div");i.className="d-flex justify-content-between align-items-center mb-1";const o=document.createElement("span");o.className="flex-grow-1 text-truncate me-2 text-decoration-underline",o.innerText=e;const n=document.createElement("button");n.className="btn btn-light",n.innerHTML='<i class="bi bi-trash3"></i>',i.appendChild(o),i.appendChild(n),t.appendChild(i),n.onclick=()=>{n.onclick=null;const t=this.options.domain.indexOf(e);t>-1&&(this.options.domain.splice(t,1),this.saveOptions()),i.remove(),0===this.options.domain.length&&s.classList.remove("d-none")}}langRender(){document.querySelectorAll(".lang-title").forEach((e=>{let t=e.getAttribute("title");t?(t=t.trim(),e.setAttribute("title",this.lang(t))):(t=e.getAttribute("data-bs-title"),t&&(t=t.trim(),e.setAttribute("data-bs-title",this.lang(t))))})),document.querySelectorAll(".lang").forEach((e=>{let t=e.innerText.trim();t&&(e.innerHTML=this.lang(t))}))}async init(){this.bootstrap=await new Promise((e=>{import("../bootstrap/js/bootstrap.bundle.min.js").then((({bootstrap:t})=>{e(t)}))})),await this.getOptions(),this.langDir=await this.getLangDir(),this.tab=await new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0}).then((t=>{e(t[0])}))})),this.optionRender(),this.$home.onclick=()=>chrome.tabs.create({url:this.options.site+this.langDir,index:this.tab.index+1}),this.$disableDetail.onclick=()=>chrome.tabs.create({url:this.options.site+this.langDir+this.disableDetailUrl,index:this.tab.index+1}),this.$record.forEach((e=>{e.onclick=()=>{const{options:e}=this,t=()=>{const e={tab:this.tab.id};this.createTab(e,!0)};e.noRecordTip?t():this.modal({title:this.lang("popup_record_modal_title"),content:this.lang("popup_record_modal_content"),btnConfirm:this.lang("popup_record_modal_btn_confirm")},(s=>{s!==e.noRecordTip?(e.noRecordTip=s,this.saveOptions().then((()=>t()))):t()}))}})),chrome.runtime.onMessage.addListener(((e,t,s)=>{const{cmd:i,parameter:o}=e;if("POPUP_APPEND_ITEMS"===i){if(!o.tab||!o.item||this.disable)return s(),!0;if(this.tab.id!==o.tab)return s(),!0;this.$empty.classList.add("d-none"),this.$container.classList.remove("d-none");for(const e in o.item)this.itemCreate(o.item[e]);return s(),!0}}));const e=["youtube.com","globo.com"];if(0===this.tab.url.indexOf("http")){const t=new URL(this.tab.url).hostname;for(const s of e)if(t.endsWith(s))return this.$loading.remove(),this.$disable.classList.remove("d-none"),void(this.disable=!0)}this.storageKey=`storage${this.tab.id}`;const t=await new Promise((e=>{try{chrome.storage.local.get([this.storageKey],(t=>{Object.keys(t).length>0?e(t[this.storageKey]):e({})}))}catch(t){e({})}}));if(0===Object.keys(t).length)return this.$loading.remove(),void this.$empty.classList.remove("d-none");this.$loading.remove(),this.$container.classList.remove("d-none");for(const e in t)this.itemCreate(t[e])}selector(e,t=!1,s=null){return s?t?s.querySelectorAll('[selector="'+e+'"]'):s.querySelector('[selector="'+e+'"]'):t?document.querySelectorAll('[selector="'+e+'"]'):document.querySelector('[selector="'+e+'"]')}saveOptions(e=!1){const t=JSON.parse(JSON.stringify(this.options));return t.size.min=t.size.min/1024,t.size.max=t.size.max/1024,new Promise((s=>{chrome.storage.sync.set({options:t}).then((()=>{const t={};e&&(t.storageKey=this.storageKey),chrome.runtime.sendMessage({cmd:"RESET_OPTIONS",parameter:t},(()=>{s()}))}))}))}getOptions(){const e=e=>{e?.size?.min&&(e.size.min=1024*e.size.min,e.size.min<0&&(e.size.min=0)),e?.size?.max&&(e.size.max=1024*e.size.max,e.size.max<0&&(e.size.max=0))};return new Promise((t=>{try{chrome.storage.sync.get(["options"]).then((({options:s})=>{if(s)for(let e in this.options)void 0!==s[e]&&(this.options[e]=s[e]);e(this.options),t()}))}catch(s){e(this.options),t()}}))}getLangDir(){return new Promise((async e=>{let t=await chrome.i18n.getUILanguage();t=t.toLowerCase(),t=t.replace(/_/,"-"),t=this.options.lang.indexOf(t)<0?"":"/"+t,e(t)}))}sizeConvert(e){return e<1024?e+="B":e=e<1048576?(e/1024).toFixed(0)+"K":e<1073741824?(e/1048576).toFixed(0)+"M":(e/1073741824).toFixed(2)+"G",e}creatRules(e){const t=[];e||(e={});let s=!1;for(const i in e){const o=i.toLowerCase();"origin"!==o&&"referer"!==o||(s=!0),t.push({header:i,operation:"set",value:e[i]})}return s?t:null}setRules(e,t){const{ruleId:s}=this;return new Promise((i=>{try{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[s],addRules:[{id:s,priority:1,action:{type:"modifyHeaders",requestHeaders:e},condition:{urlFilter:t,resourceTypes:["xmlhttprequest","media"]}}]},(function(){i(s)}))}catch(e){i(0)}}))}removeRules(){chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[this.ruleId]})}player(e,t,s){const i=document.createElement("video");i.autoplay=!0,i.controls=!0,i.style.maxWidth="100%",t.appendChild(i);const o=this.creatRules(e.headers);if("hls"===e.type){if(Hls.isSupported()){const t={};o&&(t.fetchSetup=async(t,s)=>(await this.setRules(o,e.url),new Request(t.url,s)),t.xhrSetup=async(t,s)=>{await this.setRules(o,e.url),t.open("GET",s,!0)});const n=new Hls(t);return n.on(Hls.Events.FRAG_LOADED,(()=>{o&&this.removeRules()})),n.on(Hls.Events.DESTROYING,(()=>{o&&this.removeRules()})),n.on(Hls.Events.MANIFEST_PARSED,((e,t)=>{let o=0,a=0,l=0;for(const e of n.levels){const{bitrate:t,width:s,height:i}=e;t&&s&&i&&(t>l&&(l=t,o=s,a=i))}o&&a?s.innerText=`${o} x ${a}`:i.addEventListener("loadedmetadata",(()=>{const e=i.videoWidth,t=i.videoHeight;s.innerText=`${e} x ${t}`}))})),n.loadSource(e.url),n.attachMedia(i),n}}else i.addEventListener("loadedmetadata",(()=>{const t=`${i.videoWidth} x ${i.videoHeight}`;e.quality=t,s.innerText=t})),o?this.setRules(o,e.url).then((()=>{i.src=e.url})):i.src=e.url;return null}createTab(e,t=!1,s=null){e.initiator=this.tab.url,e.title=this.tab.title.trim()||this.tab.url,chrome.storage.local.set({queue:e},(()=>{const{options:e,langDir:i}=this;let o="bufferrecorder";if(!t){if(!s)return;o="hls"===s?"m3u8downloader":"videodownloader"}chrome.tabs.create({url:`${e.site}${i}/${o}`,index:this.tab.index+1})}))}itemCreate(e){let t=null;const s=this.$item.cloneNode(!0),i={requestId:e.requestId,detail:e,$item:s},o=this.selector("play",!1,s),n=this.selector("info",!1,s),a=this.selector("name-wrap",!1,s),l=this.selector("name-width",!1,s),r=this.selector("name",!1,s),c=this.selector("name-ellipsis",!1,s),d=this.selector("size",!1,s),h=this.selector("chevron-down",!1,s),m=this.selector("download",!1,s),p=this.selector("blocked",!1,s),u=this.selector("url-collapse",!1,s),b=this.selector("url",!1,s),g=this.selector("url-close",!1,s),f=this.selector("copy",!1,s),v=this.selector("player-collapse",!1,s),y=this.selector("resolution",!1,s),x=this.selector("player",!1,s),_=this.selector("player-close",!1,s);n.setAttribute("title",e.name),r.innerText=e.name,d.innerText="hls"===e.type?"HLS":`${e.type.toUpperCase()}/${this.sizeConvert(e.size)}`,b.innerText=e.url,this.$list.appendChild(s),l.offsetWidth<a.offsetWidth&&(l.classList.remove("h-100","position-absolute","top-0","end-0"),c.remove());const w=new this.bootstrap.Collapse(u,{toggle:!1}),T=new this.bootstrap.Collapse(v,{toggle:!1});u.addEventListener("hide.bs.collapse",(e=>{h.classList.remove("transform-up")})),u.addEventListener("show.bs.collapse",(e=>{h.classList.add("transform-up"),T.hide()})),v.addEventListener("hide.bs.collapse",(e=>{t&&t.destroy(),x.firstElementChild.remove()})),v.addEventListener("show.bs.collapse",(e=>{w.hide()})),n.onclick=()=>{for(const e of this.items)e.requestId!==i.requestId&&e.urlCollapse.hide();w.toggle()},g.onclick=()=>w.hide(),_.onclick=()=>T.hide(),o.onclick=()=>{for(const e of this.items)e.requestId!==i.requestId&&e.playerCollapse.hide();v.classList.contains("show")||(t=this.player(e,x,y),T.show())},m.onclick=()=>{if(e.contentType.startsWith("audio"))return void chrome.tabs.create({url:e.url,index:this.tab.index+1});new Promise((t=>{try{chrome.runtime.sendMessage({cmd:"CHECK_DOWNLOADING_REQUEST_EXIST",parameter:{requestId:e.requestId}},(function(e){t(e)}))}catch(e){t({exist:!1})}})).then((t=>{t.exist?chrome.tabs.query({}).then((s=>{for(let e=0;e<s.length;e++)if(s[e].id===t.tabId)return void chrome.tabs.update(t.tabId,{active:!0});this.createTab(e,!1,e.type)})):this.createTab(e,!1,e.type)}))},p.onclick=()=>{const{options:t}=this,{hostname:i}=new URL(e.url),o=()=>{if(t.domain.indexOf(i)<0){if(t.domain.length>30)return void this.toast(this.lang("popup_item_block_error"),4e3,!0);t.domain.push(i),this.saveOptions(!0).then((()=>{for(this.createOptionDomain(i);;){let e=!0,t=0;for(const s of this.items){if(new URL(s.detail.url).hostname===i){s.$item.remove(),this.items.splice(t,1),e=!1;break}t++}if(e)break}this.updateBadge(),this.toast(this.lang("popup_item_block_success"))}))}else s.remove()};t.noAddDomainTip?o():this.modal({title:`${this.lang("popup_item_block_modal_title")}: <span class="text-danger text-decoration-underline">${i}</span>`,btnConfirm:this.lang("popup_item_block_modal_btn_confirm"),content:this.lang("popup_item_block_modal_content")},(e=>{t.noAddDomainTip=e,o()}))},f.onclick=()=>{try{navigator.clipboard.writeText(e.url).then((()=>{this.toast(this.lang("popup_item_copy_success"))})).catch((e=>{this.toast(this.lang("popup_item_copy_error"),4e3,!0)}))}catch(e){this.toast(this.lang("popup_item_copy_error"),4e3,!0)}},i.urlCollapse=w,i.playerCollapse=T,this.items.push(i),"hls"!==e.type&&this.itemToggle(s,e.size)}updateBadge(){let e=this.items.length;0===e&&(this.$container.classList.add("d-none"),this.$empty.classList.remove("d-none")),e=e>0?e.toString():"",chrome.action.setBadgeText({text:e,tabId:this.tab.id});try{chrome.action.setBadgeTextColor({color:"#FFFFFF"}),chrome.action.setBadgeBackgroundColor({color:"#FF0000"})}catch(e){}}toast(e,t=3e3,s=!1){const i=document.createElement("div");i.style.zIndex=99999,i.className="w-100 h-100 fixed-top d-flex justify-content-center align-items-start pt-5 pe-none";const o=document.createElement("div");o.className="toast align-items-center border-0 text-white pe-auto";const n=document.createElement("div");n.className="d-flex";const a=document.createElement("div");a.className="toast-body",a.innerText=e;const l=document.createElement("button");if(l.className="btn-close btn-close-white me-2 m-auto",s){const e=document.createElement("span");e.className="text-danger-emphasis",n.appendChild(e),o.classList.add("bg-danger")}else o.classList.add("bg-success");i.appendChild(o),o.appendChild(n),n.appendChild(a),n.appendChild(l),document.body.appendChild(i);const r=new this.bootstrap.Toast(o);r.show(),o.addEventListener("hidden.bs.toast",(()=>{l.onclick=null,r.dispose(),i.remove()})),l.onclick=()=>r.hide(),setTimeout((()=>{r.hide()}),t)}modal(e={},t=((e=!1)=>{})){"string"!=typeof e.title&&(e.title="Tip"),"string"!=typeof e.btnConfirm&&(e.btnConfirm="Confirm"),"string"!=typeof e.content&&(e.content="Content");const{title:s,btnConfirm:i,content:o}=e,n=document.createElement("div");n.className="modal fade",n.setAttribute("tabindex","-1"),n.setAttribute("data-bs-delay",'{"show":150,"hide":150}');const a=document.createElement("div");a.className="modal-dialog",n.appendChild(a);const l=document.createElement("div");l.className="modal-content",a.appendChild(l);const r=document.createElement("div");r.className="modal-header py-3",r.innerHTML=`<h3 class="modal-title fs-6">${s}</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button>`,l.appendChild(r);const c=document.createElement("div");c.className="modal-body",c.innerHTML=o,l.appendChild(c);const d=document.createElement("div");d.className="modal-footer d-flex justify-content-between align-items-center",l.appendChild(d);const h=document.createElement("label");h.className="d-flex justify-content-start align-items-center pointer";const m=document.createElement("input");m.className="form-check-input fs-5 mt-0 border-2",m.setAttribute("type","checkbox");const p=document.createElement("span");p.className="ps-1",p.innerText=this.lang("popup_no_remind"),h.appendChild(m),h.appendChild(p),d.appendChild(h);const u=document.createElement("button");u.className="btn btn-primary",u.innerText=i,d.appendChild(u),document.body.appendChild(n);const b=new this.bootstrap.Modal(n);b.show(),n.addEventListener("hidden.bs.modal",(e=>{u.onclick=null,b.dispose(),n.remove()})),u.onclick=()=>{t(m.checked),b.hide()}}lang(e){return chrome.i18n.getMessage(e)}}const t=new e;t.init(),chrome.runtime.connect({name:"POPUP"});